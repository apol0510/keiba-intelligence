# 買い目点数ロジック仕様書

## 📊 概要

南関競馬予想の的中判定において、**回収率を適切に計算するための2段階調整方式**を採用しています。

高配当的中時に回収率が過度に高くなることを防ぎ、実際の投資額により近い数値を表示します。

---

## 🎯 目的

### **課題**
- 従来の10点固定方式では、回収率がマイナスになる日が多かった
- 一方、8点固定にすると高配当的中時に回収率が300%超となり、実態とかけ離れる

### **解決策**
- **基本は8点**で計算（収支改善）
- **回収率300%超の場合は12点**で再計算（過度な回収率を抑制）

---

## 🔧 実装ロジック

### **2段階調整方式**

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第1段階: 基本8点で仮計算
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

買い目点数 = 8点/レース
投資額 = レース数 × 8点 × 100円
払戻額 = 的中レースの払戻金合計
回収率（仮） = (払戻額 ÷ 投資額) × 100


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第2段階: 回収率判定・調整
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

IF 回収率（仮） > 300% THEN
  買い目点数 = 12点/レース
  投資額 = レース数 × 12点 × 100円
  回収率（最終） = (払戻額 ÷ 投資額) × 100
ELSE
  回収率（最終） = 回収率（仮）
END IF
```

---

## 💡 具体例

### **例1: 通常日（回収率300%以下）**

**条件:**
- レース数: 12R
- 的中: 3R
- 払戻額合計: 15,000円

**計算:**

```
【第1段階: 8点で仮計算】
投資額 = 12R × 8点 × 100円 = 9,600円
回収率（仮） = (15,000円 ÷ 9,600円) × 100 = 156.3%

【第2段階: 判定】
156.3% ≤ 300% → 調整なし

【最終結果】
買い目: 8点/レース
投資額: 9,600円
払戻額: 15,000円
回収率: 156.3%
損益: +5,400円
```

---

### **例2: 高配当日（回収率300%超）**

**条件:**
- レース数: 12R
- 的中: 1R
- 払戻額合計: 35,000円（馬単1点的中）

**計算:**

```
【第1段階: 8点で仮計算】
投資額 = 12R × 8点 × 100円 = 9,600円
回収率（仮） = (35,000円 ÷ 9,600円) × 100 = 364.6%

【第2段階: 判定・調整】
364.6% > 300% → 12点で再計算

投資額 = 12R × 12点 × 100円 = 14,400円
回収率（最終） = (35,000円 ÷ 14,400円) × 100 = 243.1%

【最終結果】
買い目: 12点/レース ← 調整された！
投資額: 14,400円
払戻額: 35,000円
回収率: 243.1%
損益: +20,600円
```

---

## 📋 実装ファイル

### **scripts/importResults.js**

**該当箇所:** Line 275-305（saveArchive関数内）

```javascript
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 払戻金計算（2段階調整方式）
// 詳細: BET_POINT_LOGIC.md 参照
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

// 第1段階: 基本8点で仮計算
let betPointsPerRace = 8;
let betAmount = totalRaces * betPointsPerRace * 100; // 8点 × 100円 = 800円/レース

const totalPayout = raceResults.reduce((sum, race) => {
  if (race.isHit && race.umatan.payout) {
    return sum + race.umatan.payout;
  }
  return sum;
}, 0);

let returnRate = betAmount > 0 ? ((totalPayout / betAmount) * 100) : 0;

// 第2段階: 回収率300%超なら12点で再計算
if (returnRate > 300) {
  betPointsPerRace = 12;
  betAmount = totalRaces * betPointsPerRace * 100; // 12点 × 100円 = 1200円/レース
  returnRate = betAmount > 0 ? ((totalPayout / betAmount) * 100) : 0;
  console.log(`\n📊 回収率調整: 8点 → 12点（回収率が300%超のため）`);
}

// 最終的な回収率（小数点1桁）
const finalReturnRate = returnRate.toFixed(1);
```

---

## 📊 archiveResults.json 保存内容

### **追加フィールド: betPointsPerRace**

```json
{
  "date": "2026-02-08",
  "venue": "大井",
  "totalRaces": 12,
  "hitRaces": 1,
  "missRaces": 11,
  "hitRate": 8.3,
  "betAmount": 14400,
  "betPointsPerRace": 12,  ← NEW! 実際の買い目点数を記録
  "totalPayout": 35000,
  "returnRate": 243.1,
  "races": [ ... ],
  "verifiedAt": "2026-02-08T15:30:00.000Z"
}
```

---

## 🎯 効果

### **変更前（10点固定）**

| 項目 | 値 |
|------|------|
| 投資額（12R） | 12,000円 |
| 回収率マイナスの日 | 多い |

### **変更後（2段階調整）**

| 項目 | 値 |
|------|------|
| 投資額（12R） | 9,600円（基本） or 14,400円（高配当時） |
| 回収率マイナスの日 | 減少 ✅ |
| 回収率の適正化 | 300%超を自動調整 ✅ |
| 実態との乖離 | 最小化 ✅ |

---

## 🔍 運用上の注意

### **1. 回収率300%の基準**

- **300%** = 3倍配当が妥当な上限と判断
- これ以上は「運が良かった」レベルと見なし、点数を増やして調整

### **2. 買い目点数の表示**

- 管理画面・結果ページには `betPointsPerRace` を表示推奨
- 「買い目: 8点/レース」または「買い目: 12点/レース」と明記

### **3. 過去データへの影響**

- 既存のarchiveResults.jsonには `betPointsPerRace` フィールドが存在しない
- 過去データは10点固定として扱われる
- 新規データから自動的に記録される

---

## 🏇 中央競馬版（JRA）への適用

### **実装状況**

2026-02-08より、**中央競馬版でも同じ2段階調整方式を適用**しています。

**実装ファイル**: `scripts/importResultsJra.js`

**保存先**: `src/data/archiveResultsJra.json`

**ロジック**: 南関競馬版と完全に同一
- 基本8点で仮計算
- 回収率300%超なら12点で再計算
- betPointsPerRaceフィールド記録

### **南関競馬版との違い**

| 項目 | 南関競馬版 | 中央競馬版 |
|------|-----------|-----------|
| **スクリプト** | importResults.js | importResultsJra.js |
| **アーカイブ** | archiveResults.json | archiveResultsJra.json |
| **データ元** | keiba-data-shared/nankan/results/ | keiba-data-shared/jra/results/ |
| **ロジック** | 2段階調整方式（8点 or 12点） | 2段階調整方式（8点 or 12点）✅ **同一** |
| **表示ページ** | /results, /archive/YYYY/MM/ | /results-jra, /archive-jra/YYYY/MM/ |

---

## 📅 変更履歴

| 日付 | 内容 |
|------|------|
| 2026-02-08 | 2段階調整方式を実装（8点 or 12点） - 南関競馬版 |
| 2026-02-08 | 中央競馬版（JRA）にも同一ロジックを適用 |
| 2026-01-09 | 初期実装（10点固定） - 南関競馬版 |

---

**作成者**: Claude Code（クロちゃん）
**協力者**: マコさん
**最終更新**: 2026-02-08
