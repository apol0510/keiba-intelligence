---
// ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆKEIBA Intelligenceç”¨ï¼‰
export interface Props {
    requiredPlan: 'free' | 'pro' | 'pro-plus';
    showUpgrade?: boolean;
}

const { requiredPlan, showUpgrade = true } = Astro.props;
---

<div id="access-control" data-required-plan={requiredPlan}>
    <!-- èª­ã¿è¾¼ã¿ä¸­è¡¨ç¤º -->
    <div id="loading-state" class="access-loading">
        <div class="spinner"></div>
        <p>ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªä¸­...</p>
    </div>

    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="content-area" class="hidden">
        <slot />
    </div>

    <!-- ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="access-denied" class="access-denied hidden">
        <div class="denied-icon">ğŸ”’</div>
        <h2>ã“ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã”è¦§ã„ãŸã ãã«ã¯ä¼šå“¡ç™»éŒ²ãŒå¿…è¦ã§ã™</h2>
        <p class="denied-message"></p>

        {showUpgrade && (
            <div class="upgrade-options">
                <a href="/pricing/" class="upgrade-btn primary">æ–™é‡‘ãƒ—ãƒ©ãƒ³ã‚’è¦‹ã‚‹</a>
                <a href="/login" class="upgrade-btn secondary">ãƒ­ã‚°ã‚¤ãƒ³</a>
            </div>
        )}
    </div>
</div>

<style>
    .access-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        color: var(--color-text-secondary);
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(59, 130, 246, 0.2);
        border-top: 3px solid var(--color-accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .hidden {
        display: none !important;
    }

    .access-denied {
        text-align: center;
        padding: 80px 20px;
        background: rgba(30, 41, 59, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 16px;
        margin: 40px auto;
        max-width: 600px;
    }

    .denied-icon {
        font-size: 64px;
        margin-bottom: 24px;
        filter: grayscale(0.5);
        opacity: 0.8;
    }

    .access-denied h2 {
        color: var(--color-text-primary);
        font-size: 24px;
        margin-bottom: 16px;
    }

    .denied-message {
        color: var(--color-text-secondary);
        font-size: 16px;
        line-height: 1.6;
        margin-bottom: 32px;
        white-space: pre-line;
    }

    .upgrade-options {
        display: flex;
        gap: 16px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .upgrade-btn {
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s;
        display: inline-block;
    }

    .upgrade-btn.primary {
        background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-alt) 100%);
        color: white;
    }

    .upgrade-btn.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
    }

    .upgrade-btn.secondary {
        background: transparent;
        color: var(--color-accent);
        border: 2px solid rgba(59, 130, 246, 0.5);
    }

    .upgrade-btn.secondary:hover {
        background: rgba(59, 130, 246, 0.1);
        border-color: var(--color-accent);
    }
</style>

<script>
    // ç’°å¢ƒåˆ¤å®š
    function isDevelopmentMode() {
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const hasDevPort = window.location.port === '4321' || window.location.port === '3000';
        return isLocalhost || hasDevPort;
    }

    // èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
    function getCurrentUserPlan() {
        console.log('ğŸ” èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯é–‹å§‹ (KEIBA Intelligence)');

        // 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å„ªå…ˆ - Netlify Blobsãƒ™ãƒ¼ã‚¹èªè¨¼ï¼‰
        const sessionAuth = sessionStorage.getItem('keiba_session');
        if (sessionAuth) {
            try {
                const { user, plan, expiresAt } = JSON.parse(sessionAuth);

                // æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
                if (expiresAt && new Date() < new Date(expiresAt)) {
                    console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼:', { user, plan });
                    return { user, plan: plan || 'free' };
                } else {
                    console.log('âš ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™åˆ‡ã‚Œ');
                    sessionStorage.removeItem('keiba_session');
                }
            } catch (error) {
                console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³è§£æã‚¨ãƒ©ãƒ¼:', error);
                sessionStorage.removeItem('keiba_session');
            }
        }

        // 2. LocalStorageã®user-planãƒã‚§ãƒƒã‚¯
        const userPlanData = localStorage.getItem('user-plan');
        if (userPlanData) {
            try {
                const userData = JSON.parse(userPlanData);
                console.log('âœ… user-planèªè¨¼:', userData);
                return {
                    user: { email: userData.email },
                    plan: userData.plan || 'free'
                };
            } catch (error) {
                console.error('user-planè§£æã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // 3. LocalStorageã®auth_dataãƒã‚§ãƒƒã‚¯
        const authData = localStorage.getItem('auth_data');
        if (authData) {
            try {
                const { user, plan, expiresAt } = JSON.parse(authData);

                // æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
                if (expiresAt && new Date() > new Date(expiresAt)) {
                    console.log('âš ï¸ auth_dataæœ‰åŠ¹æœŸé™åˆ‡ã‚Œ');
                    localStorage.removeItem('auth_data');
                    return { user: null, plan: null };
                }

                console.log('âœ… auth_dataèªè¨¼:', { user, plan });
                return { user, plan: plan || 'free' };
            } catch (error) {
                console.error('auth_dataè§£æã‚¨ãƒ©ãƒ¼:', error);
                localStorage.removeItem('auth_data');
            }
        }

        // 4. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æœªç™»éŒ²
        console.log('âŒ èªè¨¼ãƒ‡ãƒ¼ã‚¿ãªã— - æœªç™»éŒ²çŠ¶æ…‹');
        return { user: null, plan: null };
    }

    // ãƒ—ãƒ©ãƒ³éšå±¤ãƒã‚§ãƒƒã‚¯
    function canAccessContent(userPlan, requiredPlan, user) {
        const planHierarchy = {
            'free': 0,
            'pro': 1,
            'pro-plus': 2
        };

        const userLevel = planHierarchy[userPlan] || 0;
        const requiredLevel = planHierarchy[requiredPlan] || 0;

        console.log('ğŸ” ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚§ãƒƒã‚¯è©³ç´°:', {
            userPlan, requiredPlan, user,
            userLevel, requiredLevel,
            hasUser: user !== null
        });

        // ç„¡æ–™ãƒ—ãƒ©ãƒ³ãŒå¿…è¦ãªå ´åˆ - ç™»éŒ²ä¸è¦ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
        if (requiredPlan === 'free') {
            console.log('ğŸ†“ ç„¡æ–™ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ - å…¨å“¡ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½');
            return true;
        }

        // æœ‰æ–™ãƒ—ãƒ©ãƒ³ã®å ´åˆã¯éšå±¤ãƒã‚§ãƒƒã‚¯ + ç™»éŒ²ãƒã‚§ãƒƒã‚¯
        const hasValidUser = user !== null && (user.email || user.legacy || user.temp);
        const hasAccess = userLevel >= requiredLevel && hasValidUser;
        console.log('ğŸ’ æœ‰æ–™ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚§ãƒƒã‚¯:', hasAccess, { userLevel, requiredLevel, hasValidUser });
        return hasAccess;
    }

    // ãƒ—ãƒ©ãƒ³è¡¨ç¤ºåå–å¾—
    function getPlanDisplayName(plan) {
        const displayNames = {
            'free': 'ãƒ•ãƒªãƒ¼ãƒ—ãƒ©ãƒ³',
            'pro': 'ãƒ—ãƒ­ãƒ—ãƒ©ãƒ³',
            'pro-plus': 'ãƒ—ãƒ­ãƒ—ãƒ©ã‚¹ãƒ—ãƒ©ãƒ³'
        };
        return displayNames[plan] || 'ä¸æ˜ãªãƒ—ãƒ©ãƒ³';
    }

    async function checkAccess() {
        const accessControl = document.getElementById('access-control');
        const loadingState = document.getElementById('loading-state');
        const contentArea = document.getElementById('content-area');
        const accessDenied = document.getElementById('access-denied');

        const requiredPlan = accessControl.dataset.requiredPlan;

        try {
            // èªè¨¼çŠ¶æ…‹ã®å–å¾—
            const { user, plan } = getCurrentUserPlan();
            console.log('ğŸ”’ èªè¨¼ãƒã‚§ãƒƒã‚¯ - ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user, 'ãƒ—ãƒ©ãƒ³:', plan, 'å¿…è¦ãƒ—ãƒ©ãƒ³:', requiredPlan);

            // é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ã®å„ªå…ˆè¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            if (isDevelopmentMode()) {
                console.log('ğŸ”§ é–‹ç™ºãƒ¢ãƒ¼ãƒ‰: èªè¨¼æƒ…å ±ã‚’å„ªå…ˆè¡¨ç¤º');
                setTimeout(() => {
                    if (loadingState && !loadingState.classList.contains('hidden')) {
                        console.log('âš ï¸ é–‹ç™ºãƒ¢ãƒ¼ãƒ‰: èªè¨¼ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - å¼·åˆ¶è¡¨ç¤ºå®Ÿè¡Œ');
                        loadingState.style.display = 'none';
                        loadingState.classList.add('hidden');
                        if (contentArea) {
                            contentArea.style.display = 'block';
                            contentArea.classList.remove('hidden');
                        }
                    }
                }, 10000);
            }

            // ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãƒã‚§ãƒƒã‚¯
            if (canAccessContent(plan, requiredPlan, user)) {
                // ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯
                console.log(`âœ… ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯: ${getPlanDisplayName(plan)} â†’ ${requiredPlan}ã‚³ãƒ³ãƒ†ãƒ³ãƒ„`);

                if (loadingState) {
                    loadingState.style.display = 'none';
                    loadingState.classList.add('hidden');
                }
                if (contentArea) {
                    contentArea.style.display = 'block';
                    contentArea.classList.remove('hidden');
                }
                if (accessDenied) {
                    accessDenied.style.display = 'none';
                    accessDenied.classList.add('hidden');
                }

                console.log('ğŸ”“ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºå®Œäº†');
            } else {
                // ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦
                console.log(`âŒ ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦: ${getPlanDisplayName(plan)} â†’ ${requiredPlan}ã‚³ãƒ³ãƒ†ãƒ³ãƒ„`);
                loadingState.classList.add('hidden');
                contentArea.classList.add('hidden');
                accessDenied.classList.remove('hidden');

                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
                const deniedMessage = accessDenied.querySelector('.denied-message');

                if (!user) {
                    deniedMessage.textContent = 'è©³ç´°ãªäºˆæƒ³ã¨è²·ã„ç›®ã‚’ã”è¦§ã„ãŸã ãã«ã¯ã€ä¼šå“¡ç™»éŒ²ã¨ãƒ—ãƒ©ãƒ³ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚';
                } else {
                    const currentPlanName = getPlanDisplayName(plan);
                    const requiredPlanName = getPlanDisplayName(requiredPlan);

                    deniedMessage.textContent = `ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³: ${currentPlanName}\nã“ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã¯ã€Œ${requiredPlanName}ã€ä»¥ä¸Šã®ãƒ—ãƒ©ãƒ³ãŒå¿…è¦ã§ã™ã€‚`;
                }
            }
        } catch (error) {
            console.error('âŒ ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚¨ãƒ©ãƒ¼:', error);

            // æœ¬ç•ªç’°å¢ƒã§ã¯ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ï¼ˆå®‰å…¨å´ã«å€’ã™ï¼‰
            if (!isDevelopmentMode()) {
                console.log('ğŸ”’ æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰: ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦');
                loadingState.classList.add('hidden');
                accessDenied.classList.remove('hidden');

                const deniedMessage = accessDenied.querySelector('.denied-message');
                deniedMessage.textContent = 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
            } else {
                // é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ã®ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯
                console.log('ğŸ”§ é–‹ç™ºãƒ¢ãƒ¼ãƒ‰: ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚è¡¨ç¤ºç¶™ç¶š');
                loadingState.classList.add('hidden');
                contentArea.classList.remove('hidden');
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        console.log('ğŸ“‹ DOMContentLoaded - AccessControlåˆæœŸåŒ–é–‹å§‹');

        const accessControl = document.getElementById('access-control');
        const loadingState = document.getElementById('loading-state');
        const contentArea = document.getElementById('content-area');
        const accessDenied = document.getElementById('access-denied');

        if (!accessControl || !loadingState || !contentArea || !accessDenied) {
            console.error('âŒ å¿…è¦ãªDOMè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', {
                accessControl: !!accessControl,
                loadingState: !!loadingState,
                contentArea: !!contentArea,
                accessDenied: !!accessDenied
            });
            if (contentArea) {
                contentArea.style.display = 'block';
                contentArea.classList.remove('hidden');
            }
            return;
        }

        console.log('âœ… å…¨DOMè¦ç´ ç¢ºèªå®Œäº† - AccessControlå®Ÿè¡Œé–‹å§‹');

        setTimeout(() => {
            checkAccess();
        }, 50);
    });
</script>
