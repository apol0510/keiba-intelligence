---
/**
 * 認証チェックコンポーネント
 *
 * 使い方:
 * ---
 * import AuthCheck from '../components/AuthCheck.astro';
 * ---
 *
 * <AuthCheck />
 * <div>ここに認証が必要なコンテンツ</div>
 */
---

<div id="auth-check" style="display: none;">
  <div class="auth-loading">
    <div class="spinner"></div>
    <p>認証確認中...</p>
  </div>
</div>

<style>
  .auth-loading {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    z-index: 9999;
  }

  .spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(59, 130, 246, 0.2);
    border-top: 4px solid #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 24px;
  }

  .auth-loading p {
    color: #94a3b8;
    font-size: 16px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>

<script>
  async function checkAuth() {
    const authCheck = document.getElementById('auth-check');

    if (authCheck) {
      authCheck.style.display = 'block';
    }

    try {
      const response = await fetch('/.netlify/functions/get-session', {
        method: 'GET',
        credentials: 'include',
      });

      if (!response.ok) {
        // 認証失敗 → ログインページへリダイレクト
        console.warn('Not authenticated, redirecting to login...');
        window.location.href = '/login';
        return;
      }

      const data = await response.json();

      if (!data.success || !data.user) {
        // セッション情報が不正
        console.warn('Invalid session, redirecting to login...');
        window.location.href = '/login';
        return;
      }

      // 認証成功 → ページを表示
      console.log('Authenticated user:', data.user.email);

      // グローバルに保存（他のスクリプトから参照可能）
      (window as any).currentUser = data.user;

      // ローディング画面を非表示
      if (authCheck) {
        authCheck.style.display = 'none';
      }

    } catch (error) {
      console.error('Auth check error:', error);
      // エラー時もログインページへ
      window.location.href = '/login';
    }
  }

  // ページ読み込み時に自動実行
  checkAuth();
</script>
