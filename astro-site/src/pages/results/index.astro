---
import BaseLayout from '../../layouts/BaseLayout.astro';

export const prerender = false;

// GitHub APIã§æœ€æ–°ã®çµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
async function getRecentResults() {
  const results = [];
  const currentYear = new Date().getFullYear();
  const currentMonth = new Date().getMonth() + 1;

  // ç›´è¿‘3ãƒ¶æœˆåˆ†ã‚’å–å¾—
  for (let monthOffset = 0; monthOffset < 3; monthOffset++) {
    let year = currentYear;
    let month = currentMonth - monthOffset;

    if (month < 1) {
      month += 12;
      year -= 1;
    }

    const monthStr = month.toString().padStart(2, '0');

    try {
      const url = `https://api.github.com/repos/apol0510/keiba-data-shared/contents/nankan/results/${year}/${monthStr}`;
      const response = await fetch(url);

      if (response.ok) {
        const files = await response.json();
        for (const file of files) {
          if (file.name.endsWith('.json')) {
            results.push({
              date: file.name.replace('.json', ''),
              downloadUrl: file.download_url,
              year,
              month: monthStr
            });
          }
        }
      }
    } catch (error) {
      console.error(`Error fetching ${year}/${monthStr}:`, error);
    }
  }

  // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
  results.sort((a, b) => b.date.localeCompare(a.date));

  // æœ€æ–°30ä»¶ã«åˆ¶é™
  return results.slice(0, 30);
}

const recentResults = await getRecentResults();

// å„çµæœã®åŸºæœ¬æƒ…å ±ã‚’å–å¾—
const resultsWithInfo = await Promise.all(
  recentResults.map(async (result) => {
    try {
      const response = await fetch(result.downloadUrl);
      const data = await response.json();
      return {
        ...result,
        venue: data.venue,
        venueCode: data.venueCode,
        raceCount: data.races?.length || 0
      };
    } catch (error) {
      return {
        ...result,
        venue: 'ä¸æ˜',
        venueCode: '??',
        raceCount: 0
      };
    }
  })
);
---

<BaseLayout
  title="å—é–¢ç«¶é¦¬ çµæœä¸€è¦§"
  description="å—é–¢ç«¶é¦¬ï¼ˆå¤§äº•ãƒ»å·å´ãƒ»èˆ¹æ©‹ãƒ»æµ¦å’Œï¼‰ã®æœ€æ–°ãƒ¬ãƒ¼ã‚¹çµæœã‚’å…¬é–‹ã€‚å…¨é¦¬ç€é †ãƒ»å…¨é¦¬åˆ¸ç¨®é¡ã®æ‰•æˆ»é‡‘ã‚’å®Œå…¨æ²è¼‰ã€‚AIäºˆæƒ³ã®çš„ä¸­å®Ÿç¸¾ã‚‚ç¢ºèªã§ãã¾ã™ã€‚"
>
  <section class="results-section">
    <div class="container">
      <h1 class="page-title">ğŸ‡ å—é–¢ç«¶é¦¬ çµæœä¸€è¦§</h1>
      <p class="page-description">
        æœ€æ–°ãƒ¬ãƒ¼ã‚¹çµæœã‚’å…¬é–‹ä¸­ã€‚å…¨é¦¬ç€é †ãƒ»å…¨é¦¬åˆ¸ç¨®é¡ã®æ‰•æˆ»é‡‘ã‚’å®Œå…¨æ²è¼‰ã—ã¦ã„ã¾ã™ã€‚
      </p>

      <div class="cta-banner">
        <h2>ğŸ“Š AIäºˆæƒ³ã‚’ç„¡æ–™ã§è©¦ã™</h2>
        <p>å¾ŒåŠ3ãƒ¬ãƒ¼ã‚¹ã®äºˆæƒ³ã‚’ç„¡æ–™å…¬é–‹ä¸­ï¼</p>
        <a href="/free-prediction" class="btn btn-primary btn-lg">ç„¡æ–™äºˆæƒ³ã‚’è¦‹ã‚‹</a>
      </div>

      <div class="results-grid">
        {resultsWithInfo.map((result) => (
          <a href={`/results/${result.year}/${result.month}/${result.date.split('-')[2]}`} class="result-card">
            <div class="result-header">
              <span class="result-date">{result.date}</span>
              <span class="result-venue">{result.venue}</span>
            </div>
            <div class="result-info">
              <span class="result-races">{result.raceCount}ãƒ¬ãƒ¼ã‚¹</span>
              <span class="result-link">è©³ç´°ã‚’è¦‹ã‚‹ â†’</span>
            </div>
          </a>
        ))}
      </div>

      {resultsWithInfo.length === 0 && (
        <div class="no-results">
          <p>çµæœãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
        </div>
      )}

      <div class="cta-section">
        <h2>ğŸ¯ æœ‰æ–™äºˆæƒ³ã§çš„ä¸­ç‡ã‚¢ãƒƒãƒ—</h2>
        <p>AIåˆ†æã«ã‚ˆã‚‹é«˜ç²¾åº¦ãªè²·ã„ç›®ã‚’æä¾›</p>
        <div class="cta-buttons">
          <a href="/pricing" class="btn btn-primary btn-lg">æ–™é‡‘ãƒ—ãƒ©ãƒ³ã‚’è¦‹ã‚‹</a>
          <a href="/prediction" class="btn btn-secondary btn-lg">æœ‰æ–™äºˆæƒ³ã‚’è¦‹ã‚‹</a>
        </div>
      </div>
    </div>
  </section>

  <style>
    .results-section {
      padding: var(--spacing-2xl) 0;
      min-height: 100vh;
    }

    .page-title {
      font-size: 2.5rem;
      text-align: center;
      margin-bottom: var(--spacing-md);
    }

    .page-description {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-2xl);
      font-size: 1.125rem;
    }

    .cta-banner {
      background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
      padding: var(--spacing-xl);
      border-radius: var(--radius-lg);
      text-align: center;
      margin-bottom: var(--spacing-2xl);
      color: white;
    }

    .cta-banner h2 {
      margin-bottom: var(--spacing-sm);
      font-size: 1.75rem;
    }

    .cta-banner p {
      margin-bottom: var(--spacing-lg);
      opacity: 0.9;
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-2xl);
    }

    .result-card {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      text-decoration: none;
      color: inherit;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .result-card:hover {
      transform: translateY(-4px);
      border-color: var(--primary-end);
      background: var(--bg-tertiary);
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-md);
      border-bottom: 1px solid var(--border-color);
    }

    .result-date {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .result-venue {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--primary-end);
    }

    .result-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .result-races {
      color: var(--text-secondary);
    }

    .result-link {
      color: var(--primary-end);
      font-weight: 600;
    }

    .no-results {
      text-align: center;
      padding: var(--spacing-3xl);
      color: var(--text-secondary);
    }

    .cta-section {
      background: var(--bg-secondary);
      padding: var(--spacing-2xl);
      border-radius: var(--radius-lg);
      text-align: center;
      margin-top: var(--spacing-3xl);
    }

    .cta-section h2 {
      margin-bottom: var(--spacing-sm);
      font-size: 1.75rem;
    }

    .cta-section p {
      color: var(--text-secondary);
      margin-bottom: var(--spacing-xl);
      font-size: 1.125rem;
    }

    .cta-buttons {
      display: flex;
      gap: var(--spacing-md);
      justify-content: center;
      flex-wrap: wrap;
    }

    @media (max-width: 768px) {
      .page-title {
        font-size: 2rem;
      }

      .results-grid {
        grid-template-columns: 1fr;
      }

      .cta-buttons {
        flex-direction: column;
      }

      .cta-buttons .btn {
        width: 100%;
      }
    }
  </style>
</BaseLayout>
