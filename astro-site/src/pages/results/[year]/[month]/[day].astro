---
import BaseLayout from '../../../../layouts/BaseLayout.astro';

export const prerender = false;

const { year, month, day } = Astro.params;

// æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
const date = `${year}-${month}-${day}`;
const dateFormatted = `${year}å¹´${parseInt(month)}æœˆ${parseInt(day)}æ—¥`;

// keiba-data-shared ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
let resultsData = null;
let errorMessage = null;

try {
  const url = `https://raw.githubusercontent.com/apol0510/keiba-data-shared/main/nankan/results/${year}/${month}/${date}.json`;
  const response = await fetch(url);

  if (!response.ok) {
    throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }

  resultsData = await response.json();
} catch (error) {
  errorMessage = error.message;
}

// ç«¶é¦¬å ´ã‚³ãƒ¼ãƒ‰ã‚’æ—¥æœ¬èªåã«å¤‰æ›
const venueNames = {
  'OI': 'å¤§äº•',
  'KA': 'å·å´',
  'FU': 'èˆ¹æ©‹',
  'UR': 'æµ¦å’Œ'
};

const venueName = resultsData ? (resultsData.venue || venueNames[resultsData.venueCode] || 'ä¸æ˜') : 'ä¸æ˜';

// SEOç”¨
const pageTitle = resultsData
  ? `${dateFormatted} ${venueName}ç«¶é¦¬ å…¨${resultsData.races?.length || 0}Rçµæœãƒ»æ‰•æˆ»é‡‘`
  : `${dateFormatted} å—é–¢ç«¶é¦¬çµæœ`;

const pageDescription = resultsData && resultsData.races?.[0]
  ? `${venueName}ç«¶é¦¬ã®å…¨ãƒ¬ãƒ¼ã‚¹çµæœãƒ»æ‰•æˆ»é‡‘ã‚’å®Œå…¨å…¬é–‹ã€‚1ç€: ${resultsData.races[0].results?.[0]?.number}ç•ª ${resultsData.races[0].results?.[0]?.name}ã€å˜å‹${resultsData.races[0].payouts?.tansho?.payout || 0}å††...`
  : `${dateFormatted} å—é–¢ç«¶é¦¬ã®çµæœã‚’å…¬é–‹ä¸­`;
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <section class="result-detail-section">
    <div class="container">
      <div class="breadcrumb">
        <a href="/">ãƒ›ãƒ¼ãƒ </a>
        <span>â€º</span>
        <a href="/results">çµæœä¸€è¦§</a>
        <span>â€º</span>
        <span>{date}</span>
      </div>

      <h1 class="page-title">{dateFormatted} {venueName}ç«¶é¦¬ çµæœ</h1>

      {errorMessage && (
        <div class="error-message">
          <p>âŒ {errorMessage}</p>
          <a href="/results" class="btn btn-primary">çµæœä¸€è¦§ã«æˆ»ã‚‹</a>
        </div>
      )}

      {resultsData && (
        <>
          <div class="cta-banner">
            <h2>ğŸ“Š æ˜æ—¥ã®äºˆæƒ³ã‚’è¦‹ã‚‹</h2>
            <p>AIåˆ†æã«ã‚ˆã‚‹é«˜ç²¾åº¦ãªè²·ã„ç›®ã‚’å…¬é–‹ä¸­</p>
            <div class="cta-buttons">
              <a href="/free-prediction" class="btn btn-secondary">ç„¡æ–™äºˆæƒ³</a>
              <a href="/prediction" class="btn btn-primary">æœ‰æ–™äºˆæƒ³</a>
            </div>
          </div>

          {resultsData.races?.map((race) => (
            <div class="race-card">
              <div class="race-header">
                <h2>ç¬¬{race.raceNumber}R {race.raceName || ''}</h2>
                <div class="race-info">
                  <span>{race.surface || 'ãƒ€ãƒ¼ãƒˆ'}{race.distance}m</span>
                  {race.track && <span>ï¼ˆ{race.track}ï¼‰</span>}
                  {race.horses && <span>{race.horses}é ­</span>}
                  {race.startTime && <span>ç™ºèµ°{race.startTime}</span>}
                </div>
              </div>

              {/* ç€é †è¡¨ç¤º */}
              <div class="results-section">
                <h3>ğŸ ç€é †</h3>
                <div class="results-table">
                  <div class="table-header">
                    <span>ç€</span>
                    <span>æ </span>
                    <span>é¦¬ç•ª</span>
                    <span>é¦¬å</span>
                    <span>é¨æ‰‹</span>
                    <span>ã‚¿ã‚¤ãƒ </span>
                    <span>äººæ°—</span>
                  </div>
                  {race.results?.map((horse) => (
                    <div class={`table-row rank-${horse.rank}`}>
                      <span class="rank">{horse.rank}ç€</span>
                      <span>{horse.bracket}</span>
                      <span class="horse-number">{horse.number}</span>
                      <span class="horse-name">{horse.name}</span>
                      <span>{horse.jockey}</span>
                      <span>{horse.time}</span>
                      <span>{horse.popularity}äººæ°—</span>
                    </div>
                  ))}
                </div>
              </div>

              {/* æ‰•æˆ»é‡‘è¡¨ç¤º */}
              <div class="payouts-section">
                <h3>ğŸ’° æ‰•æˆ»é‡‘</h3>
                <div class="payouts-grid">
                  {race.payouts?.tansho && (
                    <div class="payout-card">
                      <div class="payout-type">å˜å‹</div>
                      <div class="payout-combo">{race.payouts.tansho.number}ç•ª</div>
                      <div class="payout-value">{race.payouts.tansho.payout.toLocaleString()}å††</div>
                      <div class="payout-popularity">{race.payouts.tansho.popularity}äººæ°—</div>
                    </div>
                  )}
                  {race.payouts?.umaren && (
                    <div class="payout-card">
                      <div class="payout-type">é¦¬è¤‡</div>
                      <div class="payout-combo">{race.payouts.umaren.combination}</div>
                      <div class="payout-value">{race.payouts.umaren.payout.toLocaleString()}å††</div>
                      <div class="payout-popularity">{race.payouts.umaren.popularity}äººæ°—</div>
                    </div>
                  )}
                  {race.payouts?.umatan && (
                    <div class="payout-card">
                      <div class="payout-type">é¦¬å˜</div>
                      <div class="payout-combo">{race.payouts.umatan.combination}</div>
                      <div class="payout-value">{race.payouts.umatan.payout.toLocaleString()}å††</div>
                      <div class="payout-popularity">{race.payouts.umatan.popularity}äººæ°—</div>
                    </div>
                  )}
                  {race.payouts?.wide && race.payouts.wide.length > 0 && (
                    <div class="payout-card">
                      <div class="payout-type">ãƒ¯ã‚¤ãƒ‰</div>
                      <div class="payout-combo">{race.payouts.wide[0].combination}</div>
                      <div class="payout-value">{race.payouts.wide[0].payout.toLocaleString()}å††</div>
                      <div class="payout-popularity">{race.payouts.wide[0].popularity}äººæ°—</div>
                    </div>
                  )}
                  {race.payouts?.sanrenpuku && (
                    <div class="payout-card">
                      <div class="payout-type">ä¸‰é€£è¤‡</div>
                      <div class="payout-combo">{race.payouts.sanrenpuku.combination}</div>
                      <div class="payout-value">{race.payouts.sanrenpuku.payout.toLocaleString()}å††</div>
                      <div class="payout-popularity">{race.payouts.sanrenpuku.popularity}äººæ°—</div>
                    </div>
                  )}
                  {race.payouts?.sanrentan && (
                    <div class="payout-card">
                      <div class="payout-type">ä¸‰é€£å˜</div>
                      <div class="payout-combo">{race.payouts.sanrentan.combination}</div>
                      <div class="payout-value">{race.payouts.sanrentan.payout.toLocaleString()}å††</div>
                      <div class="payout-popularity">{race.payouts.sanrentan.popularity}äººæ°—</div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          ))}

          <div class="cta-section">
            <h2>ğŸ¯ AIäºˆæƒ³ã§çš„ä¸­ç‡ã‚¢ãƒƒãƒ—</h2>
            <p>éå»ãƒ‡ãƒ¼ã‚¿ã‚’AIåˆ†æã—ã€é«˜ç²¾åº¦ãªè²·ã„ç›®ã‚’æä¾›</p>
            <div class="cta-buttons-large">
              <a href="/pricing" class="btn btn-primary btn-lg">æ–™é‡‘ãƒ—ãƒ©ãƒ³ã‚’è¦‹ã‚‹</a>
              <a href="/free-prediction" class="btn btn-secondary btn-lg">ç„¡æ–™äºˆæƒ³ã‚’è©¦ã™</a>
            </div>
          </div>
        </>
      )}
    </div>
  </section>

  <style>
    .result-detail-section {
      padding: var(--spacing-2xl) 0;
      min-height: 100vh;
    }

    .breadcrumb {
      display: flex;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-xl);
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .breadcrumb a {
      color: var(--primary-end);
      text-decoration: none;
    }

    .breadcrumb a:hover {
      text-decoration: underline;
    }

    .page-title {
      font-size: 2.5rem;
      margin-bottom: var(--spacing-2xl);
    }

    .error-message {
      text-align: center;
      padding: var(--spacing-3xl);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
    }

    .error-message p {
      font-size: 1.25rem;
      margin-bottom: var(--spacing-xl);
      color: var(--error);
    }

    .cta-banner {
      background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
      padding: var(--spacing-xl);
      border-radius: var(--radius-lg);
      text-align: center;
      margin-bottom: var(--spacing-2xl);
      color: white;
    }

    .cta-banner h2 {
      margin-bottom: var(--spacing-sm);
      font-size: 1.75rem;
    }

    .cta-banner p {
      margin-bottom: var(--spacing-lg);
      opacity: 0.9;
    }

    .cta-buttons {
      display: flex;
      gap: var(--spacing-md);
      justify-content: center;
      flex-wrap: wrap;
    }

    .race-card {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
    }

    .race-header {
      margin-bottom: var(--spacing-xl);
      padding-bottom: var(--spacing-lg);
      border-bottom: 2px solid var(--border-color);
    }

    .race-header h2 {
      font-size: 1.75rem;
      margin-bottom: var(--spacing-sm);
    }

    .race-info {
      display: flex;
      gap: var(--spacing-md);
      flex-wrap: wrap;
      color: var(--text-secondary);
    }

    .results-section,
    .payouts-section {
      margin-bottom: var(--spacing-xl);
    }

    .results-section h3,
    .payouts-section h3 {
      font-size: 1.25rem;
      margin-bottom: var(--spacing-md);
    }

    .results-table {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }

    .table-header,
    .table-row {
      display: grid;
      grid-template-columns: 50px 40px 60px 1fr 120px 100px 60px;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm);
      align-items: center;
    }

    .table-header {
      font-weight: 700;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
    }

    .table-row {
      background: var(--bg-primary);
      border-radius: var(--radius-md);
      transition: background 0.2s;
    }

    .table-row:hover {
      background: var(--bg-tertiary);
    }

    .table-row.rank-1 {
      border-left: 4px solid #fbbf24;
    }

    .table-row.rank-2 {
      border-left: 4px solid #9ca3af;
    }

    .table-row.rank-3 {
      border-left: 4px solid #cd7f32;
    }

    .rank {
      font-weight: 700;
    }

    .horse-number {
      font-weight: 700;
      color: var(--primary-end);
    }

    .horse-name {
      font-weight: 600;
    }

    .payouts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: var(--spacing-md);
    }

    .payout-card {
      background: var(--bg-tertiary);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      text-align: center;
    }

    .payout-type {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-xs);
    }

    .payout-combo {
      font-size: 1.125rem;
      font-weight: 600;
      font-family: 'Courier New', monospace;
      margin-bottom: var(--spacing-xs);
    }

    .payout-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--success);
      margin-bottom: var(--spacing-xs);
    }

    .payout-popularity {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .cta-section {
      background: var(--bg-secondary);
      padding: var(--spacing-2xl);
      border-radius: var(--radius-lg);
      text-align: center;
      margin-top: var(--spacing-3xl);
    }

    .cta-section h2 {
      margin-bottom: var(--spacing-sm);
      font-size: 1.75rem;
    }

    .cta-section p {
      color: var(--text-secondary);
      margin-bottom: var(--spacing-xl);
      font-size: 1.125rem;
    }

    .cta-buttons-large {
      display: flex;
      gap: var(--spacing-lg);
      justify-content: center;
      flex-wrap: wrap;
    }

    @media (max-width: 1024px) {
      .table-header,
      .table-row {
        grid-template-columns: 45px 35px 50px 1fr 100px 90px 55px;
        font-size: 0.875rem;
      }
    }

    @media (max-width: 768px) {
      .page-title {
        font-size: 1.75rem;
      }

      .table-header,
      .table-row {
        grid-template-columns: 40px 30px 45px 1fr 80px 75px 50px;
        font-size: 0.75rem;
        padding: var(--spacing-xs);
        gap: var(--spacing-xs);
      }

      .payouts-grid {
        grid-template-columns: 1fr;
      }

      .cta-buttons-large {
        flex-direction: column;
      }

      .cta-buttons-large .btn {
        width: 100%;
      }
    }
  </style>
</BaseLayout>
