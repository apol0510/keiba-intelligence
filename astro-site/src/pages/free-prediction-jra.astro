---
import BaseLayout from '../layouts/BaseLayout.astro';
import { readdirSync, readFileSync, existsSync } from 'fs';
import { join } from 'path';

export const prerender = false;

// æœ€æ–°ã®ä¸­å¤®ç«¶é¦¬äºˆæƒ³JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
const predictionsDir = join(process.cwd(), 'src', 'data', 'predictions', 'jra');
let predictionData = null;
let venues = [];
let isMultiVenue = false;
let error = null;

try {
  if (existsSync(predictionsDir)) {
    // éšå±¤æ§‹é€ ï¼ˆjra/YYYY/MM/YYYY-MM-DD.jsonï¼‰ã‹ã‚‰æœ€æ–°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
    const years = readdirSync(predictionsDir).filter(name => /^\d{4}$/.test(name)).sort().reverse();
    let latestFile = null;
    let latestPath = null;

    outerLoop: for (const year of years) {
      const yearPath = join(predictionsDir, year);
      const months = readdirSync(yearPath).filter(name => /^\d{2}$/.test(name)).sort().reverse();

      for (const month of months) {
        const monthPath = join(yearPath, month);
        const files = readdirSync(monthPath).filter(file => file.endsWith('.json')).sort().reverse();

        if (files.length > 0) {
          latestFile = files[0];
          latestPath = join(monthPath, latestFile);
          break outerLoop;
        }
      }
    }

    if (latestPath) {
      const fileContent = readFileSync(latestPath, 'utf-8');
      const rawData = JSON.parse(fileContent);

      // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®åˆ¤å®šï¼ˆvenuesé…åˆ—ãŒã‚ã‚‹ã‹ï¼‰
      if (rawData.venues && Array.isArray(rawData.venues)) {
        // è¤‡æ•°ä¼šå ´ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        isMultiVenue = true;
        venues = rawData.venues;
        predictionData = rawData;
      } else if (rawData.eventInfo && rawData.predictions) {
        // å˜ä¸€ä¼šå ´ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆå¾“æ¥äº’æ›ï¼‰
        isMultiVenue = false;
        venues = [{
          venue: rawData.eventInfo.venue,
          eventInfo: rawData.eventInfo,
          predictions: rawData.predictions
        }];
        predictionData = rawData;
      } else {
        throw new Error('äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒä¸æ­£ã§ã™');
      }
    } else {
      throw new Error('ä¸­å¤®ç«¶é¦¬ã®äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
    }
  } else {
    throw new Error('ä¸­å¤®ç«¶é¦¬ã®äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }
} catch (err) {
  error = err.message;
}

// è¤‡é›‘ãªAIåˆ†æå€¤ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
function generateAdvancedMetrics(horse, allHorses) {
  const pt = horse.pt;
  const maxPt = Math.max(...allHorses.map(h => h.pt));
  const minPt = Math.min(...allHorses.map(h => h.pt));
  const ptRange = maxPt - minPt;
  const normalizedPt = (pt - minPt) / ptRange;

  const seed = horse.horseNumber * 1000 + pt;
  const seededRandom = (index) => {
    const x = Math.sin(seed + index) * 10000;
    return x - Math.floor(x);
  };

  const baseWinProb = normalizedPt * 35 + 5;
  const winProbability = Math.min(95, Math.max(2, baseWinProb + (seededRandom(1) - 0.5) * 8)).toFixed(2);

  const placeProb = Math.min(98, parseFloat(winProbability) * 2.2 + (seededRandom(2) - 0.5) * 5).toFixed(2);

  const speedIndex = Math.min(100, Math.max(40, pt * 0.95 + seededRandom(3) * 15)).toFixed(1);
  const staminaRating = Math.min(100, Math.max(35, pt * 0.88 + seededRandom(4) * 20)).toFixed(1);
  const formTrend = Math.min(50, Math.max(-50, (normalizedPt - 0.5) * 80 + (seededRandom(5) - 0.5) * 30)).toFixed(1);
  const trackCompatibility = Math.min(100, Math.max(30, pt * 0.92 + seededRandom(6) * 18)).toFixed(1);
  const distanceFitness = Math.min(100, Math.max(35, pt * 0.90 + seededRandom(7) * 22)).toFixed(1);
  const jockeyFactor = Math.min(100, Math.max(40, 75 + (seededRandom(8) - 0.5) * 40)).toFixed(1);

  const modelCertainty = (Math.min(0.98, Math.max(0.65, normalizedPt * 0.3 + 0.65 + (seededRandom(9) - 0.5) * 0.1)) * 100).toFixed(1);

  const fairOdds = Math.max(1.2, 100 / parseFloat(winProbability));
  const marketOdds = fairOdds * (1 + (seededRandom(10) - 0.5) * 0.4);
  const estimatedOdds = marketOdds;
  const evValue = (marketOdds * (parseFloat(winProbability) / 100)) - 1;
  const expectedValue = evValue > 0
    ? '+' + (evValue * 100).toFixed(1) + '%'
    : (evValue * 100).toFixed(1) + '%';

  const riskScore = 100 - parseFloat(modelCertainty);
  let riskLevel = 'Low';
  if (riskScore > 35) riskLevel = 'Medium';
  if (riskScore > 60) riskLevel = 'High';

  const confidenceInterval = {
    lower: Math.max(0, parseFloat(winProbability) - (100 - parseFloat(modelCertainty)) * 0.3),
    upper: Math.min(100, parseFloat(winProbability) + (100 - parseFloat(modelCertainty)) * 0.3)
  };

  return {
    winProbability,
    placeProb,
    speedIndex,
    staminaRating,
    formTrend,
    trackCompatibility,
    distanceFitness,
    jockeyFactor,
    modelCertainty,
    expectedValue,
    riskLevel,
    riskScore,
    estimatedOdds,
    confidenceInterval
  };
}
---

<BaseLayout
  title="ä¸­å¤®ç«¶é¦¬ ç„¡æ–™äºˆæƒ³ - KEIBA Intelligence"
  description="KEIBA Intelligence ä¸­å¤®ç«¶é¦¬ï¼ˆJRAï¼‰ã®ç„¡æ–™äºˆæƒ³ã€‚AIåˆ†æã«ã‚ˆã‚‹å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ï¼ˆä¸Šä½5é ­ï¼‰ã‚’ç„¡æ–™å…¬é–‹ã€‚å…¨é ­è©³ç´°åˆ†æã¨é¦¬å˜è²·ã„ç›®ã¯æœ‰æ–™ãƒ—ãƒ©ãƒ³ã§æä¾›ã€‚"
>
  <section class="prediction-section">
    <div class="container">
      {error && (
        <div class="error-card">
          <h1>ã‚¨ãƒ©ãƒ¼</h1>
          <p>{error}</p>
        </div>
      )}

      {predictionData && (
        <>
          <!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
          <div class="page-header">
            <div class="ai-badge">
              <span class="badge-pulse"></span>
              <span class="badge-text">DEEP LEARNING PREDICTION SYSTEM / æ·±å±¤å­¦ç¿’äºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ </span>
            </div>
            <div class="free-badge">
              <span class="free-icon">ğŸ</span>
              <span class="free-text">FREE PREVIEW / ç„¡æ–™ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
            </div>
            <h1 class="page-title">
              {isMultiVenue ? (
                <>{predictionData.date} ä¸­å¤®ç«¶é¦¬ï¼ˆJRAï¼‰ - {venues.length}ä¼šå ´</>
              ) : (
                <>{predictionData.eventInfo.date} {predictionData.eventInfo.venue}</>
              )}
            </h1>
            <p class="page-subtitle">
              Ensemble Neural Network Analysis / ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«å‹ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æ
            </p>
            <div class="scan-line"></div>
          </div>

          <!-- ä¼šå ´ã‚¿ãƒ–ï¼ˆè¤‡æ•°ä¼šå ´ã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰-->
          {isMultiVenue && venues.length > 1 && (
            <div class="venue-selector">
              {venues.map((venueData, venueIndex) => (
                <button
                  class={`venue-btn ${venueIndex === 0 ? 'active' : ''}`}
                  data-venue-index={venueIndex}
                  onclick="selectVenue(event, this)"
                >
                  <span class="venue-label">{venueData.venue}</span>
                  <span class="venue-race-count">{venueData.eventInfo.totalRaces}R</span>
                </button>
              ))}
            </div>
          )}

          <!-- ç„¡æ–™äºˆæƒ³ã®èª¬æ˜ -->
          <div class="free-info-card">
            <div class="free-info-header">
              <div class="free-info-icon">â„¹ï¸</div>
              <h2>ç„¡æ–™äºˆæƒ³ã«ã¤ã„ã¦</h2>
            </div>
            <div class="free-info-content">
              <p><strong>ç„¡æ–™äºˆæƒ³ã§ã¯å…¨ãƒ¬ãƒ¼ã‚¹ã®AIäºˆæƒ³ï¼ˆä¸Šä½5é ­ï¼‰ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚</strong></p>
              <p>å…¨é ­ã®è©³ç´°åˆ†æã¨é¦¬å˜è²·ã„ç›®æƒ…å ±ã¯<a href="/pricing" class="inline-link">ãƒ—ãƒ­ãƒ—ãƒ©ãƒ³ï¼ˆæœˆé¡Â¥4,980ï¼‰</a>ã§ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚</p>
              <ul class="free-info-list">
                <li>âœ… å…¨ãƒ¬ãƒ¼ã‚¹AIäºˆæƒ³</li>
                <li>âœ… é¦¬å˜è²·ã„ç›®æä¾›</li>
                <li>âœ… å…¨é ­è©³ç´°ãªAIåˆ†æ</li>
                <li>âœ… çš„ä¸­å®Ÿç¸¾é–²è¦§</li>
              </ul>
              <a href="/pricing" class="btn btn-primary">ãƒ—ãƒ­ãƒ—ãƒ©ãƒ³ã‚’è¦‹ã‚‹</a>
            </div>
          </div>

          <!-- ä¼šå ´ã”ã¨ã®è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
          {venues.map((venueData, venueIndex) => {
            const venuePredictions = venueData.predictions;
            const venueInfo = venueData.eventInfo;

            return (
              <div class={`venue-content ${venueIndex === 0 ? 'active' : ''}`} data-venue-index={venueIndex}>
                {/* ä¼šå ´åï¼ˆè¤‡æ•°ä¼šå ´ã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰*/}
                {isMultiVenue && (
                  <div class="venue-header">
                    <h2 class="venue-title">{venueInfo.venue}</h2>
                    <p class="venue-info">{venueInfo.date} - {venueInfo.totalRaces}ãƒ¬ãƒ¼ã‚¹ï¼ˆç„¡æ–™å…¬é–‹ï¼‰</p>
                  </div>
                )}

                <!-- ãƒ¬ãƒ¼ã‚¹é¸æŠãƒœã‚¿ãƒ³ -->
                <div class="race-selector">
                  {venuePredictions.map((race, raceIndex) => (
                    <button
                      class={`race-btn ${raceIndex === 0 ? 'active' : ''}`}
                      data-venue-index={venueIndex}
                      data-race-index={raceIndex}
                      onclick="selectRace(event, this)"
                      title={race.raceInfo.raceName || `ç¬¬${race.raceInfo.raceNumber}ãƒ¬ãƒ¼ã‚¹`}
                    >
                      <span class="race-label">{race.raceInfo.raceNumber}R</span>
                      <span class="race-indicator"></span>
                    </button>
                  ))}
                </div>

                <!-- ãƒ¬ãƒ¼ã‚¹è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆå…¨ãƒ¬ãƒ¼ã‚¹ï¼‰-->
                <div class="race-display-area">
                  {venuePredictions.map((race, raceIndex) => {
                    const allHorses = race.horses;
                    const horsesWithMetrics = allHorses.map(horse => ({
                      ...horse,
                      metrics: generateAdvancedMetrics(horse, allHorses)
                    }));

                    const sortedHorses = horsesWithMetrics.sort((a, b) => b.pt - a.pt);

                    return (
                      <div class={`race-content ${raceIndex === 0 ? 'active' : ''}`} data-venue-index={venueIndex} data-race-index={raceIndex}>
                        {/* ãƒ¬ãƒ¼ã‚¹åãƒ˜ãƒƒãƒ€ãƒ¼ */}
                        <div class="race-name-header">
                          <h2 class="race-name-title">{race.raceInfo.raceNumber}R {race.raceInfo.raceName}</h2>
                          <div class="race-details">
                            {race.raceInfo.startTime && <span class="race-detail-item">ğŸ• {race.raceInfo.startTime}ç™ºèµ°</span>}
                            {race.raceInfo.distance && <span class="race-detail-item">ğŸ“ {race.raceInfo.distance}m</span>}
                            {race.raceInfo.horseCount && <span class="race-detail-item">ğŸ´ {race.raceInfo.horseCount}é ­</span>}
                          </div>
                        </div>

                        {/* è©³ç´°åˆ†æãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¸Šä½5é ­ï¼‰*/}
                        <div class="analysis-section">
                          <div class="section-header">
                            <div class="header-icon">ğŸ“Š</div>
                            <h2>Multi-Dimensional Performance Analysis / å¤šæ¬¡å…ƒãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ</h2>
                            <span class="free-tag">ç„¡æ–™å…¬é–‹</span>
                          </div>

                          {sortedHorses.slice(0, 5).map((horse) => {
                            const roleClass = horse.role === 'æœ¬å‘½' ? 'honmei' : horse.role === 'å¯¾æŠ—' ? 'taikou' : horse.role === 'å˜ç©´' ? 'tanana' : 'other';
                            const roleMark = horse.role === 'æœ¬å‘½' ? 'â—' : horse.role === 'å¯¾æŠ—' ? 'â—‹' : horse.role === 'å˜ç©´' ? 'â–²' : 'â–³';
                            const m = horse.metrics;

                            return (
                              <div class={`detailed-horse-card ${roleClass}`}>
                                <div class="dhc-header">
                                  <div class="dhc-main-info">
                                    <div class="dhc-info-card">
                                      <div class="dhc-title-line">
                                        <span class="dhc-mark-mobile">{roleMark}</span>
                                        <span class="dhc-number">{horse.horseNumber}</span>
                                        <span class="dhc-name">{horse.horseName}</span>
                                        <span class="dhc-role-badge">{horse.role}</span>
                                        <span class="dhc-pt">PT: {horse.pt.toFixed(1)}</span>
                                      </div>
                                      {(horse.jockey || horse.trainer || horse.age || horse.weight) && (
                                        <div class="dhc-jockey-trainer">
                                          {horse.age && <span class="dhc-age">ğŸ‚ {horse.age}</span>}
                                          {horse.weight && <span class="dhc-weight">âš–ï¸ {horse.weight}kg</span>}
                                          {horse.jockey && <span class="dhc-jockey">ğŸ‡ {horse.jockey}</span>}
                                          {horse.trainer && <span class="dhc-trainer">ğŸ  {horse.trainer}</span>}
                                        </div>
                                      )}
                                      <div class="dhc-quick-metrics">
                                        <div class="qm-item">
                                          <span class="qm-label">Win Prob. / å‹ç‡</span>
                                          <span class="qm-value">{m.winProbability}%</span>
                                        </div>
                                        <div class="qm-item">
                                          <span class="qm-label">Model Certainty / ç¢ºä¿¡åº¦</span>
                                          <span class="qm-value">{m.modelCertainty}%</span>
                                        </div>
                                        <div class="qm-item">
                                          <span class="qm-label">Risk / ãƒªã‚¹ã‚¯</span>
                                          <span class={`qm-value risk-${m.riskLevel.toLowerCase()}`}>{m.riskLevel}</span>
                                        </div>
                                        <div class="qm-item">
                                          <span class="qm-label">Expected Value / æœŸå¾…å€¤</span>
                                          <span class={`qm-value ${m.expectedValue.startsWith('+') ? 'positive' : 'negative'}`}>
                                            {m.expectedValue}
                                          </span>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                {/* Feature Analysisï¼ˆæœ¬å‘½ãƒ»å¯¾æŠ—ã®ã¿è©³ç´°è¡¨ç¤ºï¼‰*/}
                                {(horse.role === 'æœ¬å‘½' || horse.role === 'å¯¾æŠ—') && (
                                  <div class="dhc-features">
                                    <div class="feature-title">Feature Importance Analysis / ç‰¹å¾´é‡é‡è¦åº¦åˆ†æ</div>
                                    <div class="feature-grid">
                                      <div class="feature-item">
                                        <div class="feature-label">
                                          <span class="feature-icon">âš¡</span>
                                          <span>Speed Index / ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°</span>
                                        </div>
                                        <div class="feature-bar-container">
                                          <div class="feature-bar" style={`width: ${m.speedIndex}%`}></div>
                                        </div>
                                        <div class="feature-value">{m.speedIndex}</div>
                                      </div>

                                      <div class="feature-item">
                                        <div class="feature-label">
                                          <span class="feature-icon">ğŸ’ª</span>
                                          <span>Stamina Rating / ã‚¹ã‚¿ãƒŸãƒŠè©•ä¾¡</span>
                                        </div>
                                        <div class="feature-bar-container">
                                          <div class="feature-bar" style={`width: ${m.staminaRating}%`}></div>
                                        </div>
                                        <div class="feature-value">{m.staminaRating}</div>
                                      </div>

                                      <div class="feature-item">
                                        <div class="feature-label">
                                          <span class="feature-icon">ğŸ“ˆ</span>
                                          <span>Form Trend / èª¿å­å‚¾å‘</span>
                                        </div>
                                        <div class="feature-bar-container trend">
                                          <div class="feature-bar-center"></div>
                                          <div class="feature-bar trend" style={`width: ${Math.abs(parseFloat(m.formTrend))}%; ${parseFloat(m.formTrend) >= 0 ? 'left: 50%;' : 'right: 50%;'}`}></div>
                                        </div>
                                        <div class="feature-value">{m.formTrend}</div>
                                      </div>

                                      <div class="feature-item">
                                        <div class="feature-label">
                                          <span class="feature-icon">ğŸ</span>
                                          <span>Track Compatibility / ã‚³ãƒ¼ã‚¹é©æ€§</span>
                                        </div>
                                        <div class="feature-bar-container">
                                          <div class="feature-bar" style={`width: ${m.trackCompatibility}%`}></div>
                                        </div>
                                        <div class="feature-value">{m.trackCompatibility}</div>
                                      </div>

                                      <div class="feature-item">
                                        <div class="feature-label">
                                          <span class="feature-icon">ğŸ“</span>
                                          <span>Distance Fitness / è·é›¢é©æ€§</span>
                                        </div>
                                        <div class="feature-bar-container">
                                          <div class="feature-bar" style={`width: ${m.distanceFitness}%`}></div>
                                        </div>
                                        <div class="feature-value">{m.distanceFitness}</div>
                                      </div>

                                      <div class="feature-item">
                                        <div class="feature-label">
                                          <span class="feature-icon">ğŸ‘¤</span>
                                          <span>Jockey Factor / é¨æ‰‹è¦å› </span>
                                        </div>
                                        <div class="feature-bar-container">
                                          <div class="feature-bar" style={`width: ${m.jockeyFactor}%`}></div>
                                        </div>
                                        <div class="feature-value">{m.jockeyFactor}</div>
                                      </div>
                                    </div>
                                  </div>
                                )}
                              </div>
                            );
                          })}
                        </div>

                        {/* è²·ã„ç›®ãƒ­ãƒƒã‚¯ï¼ˆç„¡æ–™ç‰ˆï¼‰*/}
                        <div class="locked-section">
                          <div class="locked-icon">ğŸ”’</div>
                          <h3>é¦¬å˜è²·ã„ç›®ã¯æœ‰æ–™ãƒ—ãƒ©ãƒ³é™å®š</h3>
                          <p>å…¨ãƒ¬ãƒ¼ã‚¹ã®è©³ç´°ãªé¦¬å˜è²·ã„ç›®ã¯<strong>ãƒ—ãƒ­ãƒ—ãƒ©ãƒ³ï¼ˆæœˆé¡Â¥4,980ï¼‰</strong>ã§ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚</p>
                          <a href="/pricing" class="btn btn-primary btn-lg">ãƒ—ãƒ­ãƒ—ãƒ©ãƒ³ã‚’è¦‹ã‚‹</a>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            );
          })}

          <!-- CTA -->
          <div class="cta-card">
            <h2>å…¨ãƒ¬ãƒ¼ã‚¹äºˆæƒ³ï¼‹é¦¬å˜è²·ã„ç›®ã‚’è¦‹ã‚‹</h2>
            <p>ãƒ—ãƒ­ãƒ—ãƒ©ãƒ³ãªã‚‰å…¨ãƒ¬ãƒ¼ã‚¹ã®è©³ç´°AIåˆ†æã¨é¦¬å˜è²·ã„ç›®ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚</p>
            <div class="cta-buttons">
              <a href="/pricing" class="btn btn-primary btn-lg">ãƒ—ãƒ­ãƒ—ãƒ©ãƒ³ã‚’è¦‹ã‚‹</a>
              <a href="/prediction-jra" class="btn btn-secondary btn-lg">æœ‰æ–™äºˆæƒ³ãƒšãƒ¼ã‚¸ã¸</a>
            </div>
          </div>
        </>
      )}
    </div>
  </section>

  <style>
    /* free-prediction.astroã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¶™æ‰¿ */
    .prediction-section {
      padding: var(--spacing-xl) 0;
      min-height: 100vh;
      background:
        radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
        var(--bg-primary);
    }

    .page-header {
      position: relative;
      text-align: center;
      margin-bottom: var(--spacing-xl);
      padding: var(--spacing-2xl);
      background: linear-gradient(135deg,
        rgba(59, 130, 246, 0.1) 0%,
        rgba(139, 92, 246, 0.1) 100%);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(59, 130, 246, 0.2);
      overflow: hidden;
    }

    .ai-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-xs) var(--spacing-md);
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.5);
      border-radius: 20px;
      margin-bottom: var(--spacing-md);
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 1.5px;
      color: #60a5fa;
    }

    .badge-pulse {
      width: 8px;
      height: 8px;
      background: #3b82f6;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    .free-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-xs) var(--spacing-md);
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: 1px solid #10b981;
      border-radius: 20px;
      margin-bottom: var(--spacing-md);
      font-size: 0.7rem;
      font-weight: 800;
      letter-spacing: 1.5px;
      color: white;
      box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
    }

    .page-title {
      font-size: 2rem;
      margin-bottom: var(--spacing-sm);
      color: white;
      text-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
      font-weight: 800;
    }

    .page-subtitle {
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.7);
      font-family: 'Courier New', monospace;
      letter-spacing: 1.5px;
    }

    .scan-line {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg,
        transparent,
        #3b82f6,
        transparent);
      animation: scanLine 2s infinite;
    }

    @keyframes scanLine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* ä¼šå ´ã‚¿ãƒ– */
    .venue-selector {
      display: flex;
      gap: var(--spacing-md);
      justify-content: center;
      margin-bottom: var(--spacing-xl);
      padding: var(--spacing-lg);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      flex-wrap: wrap;
    }

    .venue-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-md) var(--spacing-xl);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
      border-radius: var(--radius-lg);
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-width: 120px;
    }

    .venue-btn:hover {
      border-color: #a78bfa;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(167, 139, 250, 0.3);
    }

    .venue-btn.active {
      background: linear-gradient(135deg, #8b5cf6, #a78bfa);
      border-color: #a78bfa;
      color: white;
      box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
    }

    .venue-label {
      font-size: 1.25rem;
      font-weight: 900;
      letter-spacing: 0.5px;
    }

    .venue-race-count {
      font-size: 0.75rem;
      opacity: 0.8;
      font-family: 'Courier New', monospace;
    }

    .venue-content {
      display: none;
    }

    .venue-content.active {
      display: block;
      animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .venue-header {
      text-align: center;
      margin-bottom: var(--spacing-xl);
      padding: var(--spacing-lg);
      background: linear-gradient(135deg,
        rgba(139, 92, 246, 0.15) 0%,
        rgba(167, 139, 250, 0.15) 100%);
      border-radius: var(--radius-lg);
      border: 2px solid rgba(139, 92, 246, 0.3);
    }

    .venue-title {
      font-size: 2rem;
      font-weight: 900;
      color: #a78bfa;
      margin: 0 0 var(--spacing-sm) 0;
      text-shadow: 0 0 15px rgba(167, 139, 250, 0.4);
    }

    .venue-info {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin: 0;
      font-family: 'Courier New', monospace;
    }

    /* ç„¡æ–™äºˆæƒ³èª¬æ˜ */
    .free-info-card {
      background: var(--bg-secondary);
      padding: var(--spacing-xl);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-xl);
      border: 2px solid rgba(16, 185, 129, 0.3);
    }

    .free-info-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
    }

    .free-info-icon {
      font-size: 1.5rem;
    }

    .free-info-header h2 {
      font-size: 1.25rem;
      color: #10b981;
      font-weight: 800;
    }

    .free-info-content p {
      color: var(--text-secondary);
      margin-bottom: var(--spacing-sm);
      line-height: 1.6;
    }

    .free-info-list {
      list-style: none;
      margin: var(--spacing-md) 0;
    }

    .free-info-list li {
      padding: var(--spacing-xs) 0;
      color: var(--text-secondary);
    }

    .inline-link {
      color: var(--primary-end);
      text-decoration: underline;
      font-weight: 600;
    }

    /* ãƒ¬ãƒ¼ã‚¹é¸æŠãƒœã‚¿ãƒ³ */
    .race-selector {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      justify-content: center;
      margin-bottom: var(--spacing-xl);
      padding: var(--spacing-lg);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
    }

    .race-btn {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: var(--spacing-sm) var(--spacing-md);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .race-btn:hover {
      border-color: var(--primary-end);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .race-btn.active {
      background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
      border-color: var(--primary-end);
      color: white;
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
    }

    .race-label {
      font-size: 1rem;
      font-weight: 800;
    }

    .race-indicator {
      width: 20px;
      height: 2px;
      background: var(--border-color);
      border-radius: 1px;
      transition: all 0.3s;
    }

    .race-btn.active .race-indicator {
      background: white;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
    }

    /* ãƒ¬ãƒ¼ã‚¹è¡¨ç¤º */
    .race-display-area {
      position: relative;
      min-height: 500px;
    }

    .race-content {
      display: none;
    }

    .race-content.active {
      display: block;
      animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .race-name-header {
      text-align: center;
      margin-bottom: var(--spacing-xl);
      padding: var(--spacing-lg);
      background: linear-gradient(135deg,
        rgba(139, 92, 246, 0.15) 0%,
        rgba(59, 130, 246, 0.15) 100%);
      border-radius: var(--radius-lg);
      border: 2px solid rgba(139, 92, 246, 0.3);
    }

    .race-name-title {
      font-size: 1.5rem;
      font-weight: 800;
      color: #a78bfa;
      margin: 0 0 var(--spacing-md) 0;
      text-shadow: 0 0 10px rgba(167, 139, 250, 0.3);
      letter-spacing: 0.5px;
    }

    .race-details {
      display: flex;
      justify-content: center;
      gap: var(--spacing-lg);
      flex-wrap: wrap;
      margin-top: var(--spacing-md);
    }

    .race-detail-item {
      font-size: 0.95rem;
      color: #94a3b8;
      font-weight: 600;
      padding: var(--spacing-xs) var(--spacing-md);
      background: rgba(30, 41, 59, 0.5);
      border-radius: var(--radius-md);
      border: 1px solid rgba(139, 92, 246, 0.2);
    }

    .analysis-section {
      background: var(--bg-secondary);
      padding: var(--spacing-xl);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-xl);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-lg);
    }

    .header-icon {
      font-size: 1.5rem;
      filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.5));
    }

    .section-header h2 {
      font-size: 1.25rem;
      color: #60a5fa;
      font-weight: 800;
    }

    .detailed-horse-card {
      margin-bottom: var(--spacing-lg);
      padding: var(--spacing-lg);
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      border: 2px solid var(--border-color);
    }

    .detailed-horse-card.honmei {
      border-color: #3b82f6;
    }

    .detailed-horse-card.taikou {
      border-color: #8b5cf6;
    }

    .detailed-horse-card.tanana {
      border-color: #f59e0b;
    }

    .dhc-info-card {
      background: rgba(30, 41, 59, 0.5);
      padding: var(--spacing-md);
      border-radius: var(--radius-sm);
    }

    .dhc-title-line {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
      flex-wrap: wrap;
    }

    .dhc-mark-mobile {
      font-size: 1.5rem;
      font-weight: 900;
    }

    .detailed-horse-card.honmei .dhc-mark-mobile {
      color: #3b82f6;
    }

    .detailed-horse-card.taikou .dhc-mark-mobile {
      color: #8b5cf6;
    }

    .detailed-horse-card.tanana .dhc-mark-mobile {
      color: #f59e0b;
    }

    .dhc-number {
      font-size: 1.25rem;
      font-weight: 900;
      color: #60a5fa;
      font-family: 'Courier New', monospace;
      padding: 4px 12px;
      background: rgba(96, 165, 250, 0.15);
      border: 2px solid rgba(96, 165, 250, 0.4);
      border-radius: var(--radius-sm);
    }

    .dhc-name {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-primary);
      flex: 1;
    }

    .dhc-role-badge {
      padding: 4px 12px;
      background: rgba(139, 92, 246, 0.2);
      border: 1px solid rgba(139, 92, 246, 0.5);
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #a78bfa;
    }

    .dhc-pt {
      padding: 4px 12px;
      background: rgba(16, 185, 129, 0.2);
      border: 1px solid rgba(16, 185, 129, 0.5);
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
      color: #10b981;
      font-family: 'Courier New', monospace;
    }

    .dhc-jockey-trainer {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-sm);
      font-size: 0.9rem;
      color: #94a3b8;
      flex-wrap: wrap;
    }

    .dhc-age, .dhc-weight, .dhc-jockey, .dhc-trainer {
      padding: var(--spacing-xs) var(--spacing-sm);
      background: rgba(30, 41, 59, 0.5);
      border-radius: var(--radius-sm);
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .dhc-quick-metrics {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--spacing-sm);
    }

    .qm-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .qm-label {
      font-size: 0.65rem;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .qm-value {
      font-size: 1rem;
      font-weight: 800;
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
    }

    .qm-value.risk-low { color: #10b981; }
    .qm-value.risk-medium { color: #f59e0b; }
    .qm-value.risk-high { color: #ef4444; }
    .qm-value.positive { color: #10b981; }
    .qm-value.negative { color: #ef4444; }

    /* ç‰¹å¾´é‡åˆ†æ */
    .dhc-features {
      margin-bottom: var(--spacing-xl);
    }

    .feature-title {
      font-size: 1rem;
      font-weight: 700;
      color: #60a5fa;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-sm);
      border-bottom: 2px solid rgba(96, 165, 250, 0.3);
    }

    .feature-grid {
      display: grid;
      gap: var(--spacing-md);
    }

    .feature-item {
      display: grid;
      grid-template-columns: 200px 1fr 60px;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm);
      background: rgba(30, 41, 59, 0.3);
      border-radius: var(--radius-sm);
    }

    .feature-label {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .feature-icon {
      font-size: 1.25rem;
    }

    .feature-bar-container {
      position: relative;
      height: 8px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 4px;
      overflow: hidden;
    }

    .feature-bar {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6);
      border-radius: 4px;
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .feature-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.2) 50%,
        transparent 100%);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .feature-bar-container.trend {
      position: relative;
      background: linear-gradient(90deg,
        rgba(239, 68, 68, 0.3) 0%,
        rgba(100, 100, 100, 0.3) 50%,
        rgba(16, 185, 129, 0.3) 100%);
    }

    .feature-bar-center {
      position: absolute;
      left: 50%;
      top: 0;
      width: 2px;
      height: 100%;
      background: rgba(255, 255, 255, 0.5);
      transform: translateX(-50%);
    }

    .feature-bar.trend {
      position: absolute;
      top: 0;
      height: 100%;
      background: linear-gradient(90deg, rgba(16, 185, 129, 0.8), rgba(16, 185, 129, 1));
    }

    .feature-value {
      text-align: right;
      font-weight: 700;
      font-family: 'Courier New', monospace;
      color: #60a5fa;
      font-size: 0.9rem;
    }

    /* è²·ã„ç›®ãƒ­ãƒƒã‚¯ */
    .locked-section {
      text-align: center;
      padding: var(--spacing-2xl);
      background: linear-gradient(135deg,
        rgba(251, 191, 36, 0.1) 0%,
        rgba(245, 158, 11, 0.1) 100%);
      border-radius: var(--radius-lg);
      border: 2px solid rgba(251, 191, 36, 0.3);
      margin-bottom: var(--spacing-xl);
    }

    .locked-icon {
      font-size: 4rem;
      margin-bottom: var(--spacing-md);
      filter: drop-shadow(0 0 10px rgba(251, 191, 36, 0.5));
    }

    .locked-section h3 {
      font-size: 1.5rem;
      color: #fbbf24;
      margin-bottom: var(--spacing-md);
      font-weight: 800;
    }

    .locked-section p {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-lg);
      line-height: 1.6;
    }

    /* CTA */
    .cta-card {
      text-align: center;
      padding: var(--spacing-2xl);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border: 2px solid rgba(59, 130, 246, 0.3);
      margin-top: var(--spacing-2xl);
    }

    .cta-card h2 {
      font-size: 2rem;
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
      font-weight: 800;
    }

    .cta-card p {
      font-size: 1.125rem;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-xl);
    }

    .cta-buttons {
      display: flex;
      gap: var(--spacing-md);
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn-lg {
      padding: var(--spacing-md) var(--spacing-xl);
      font-size: 1.125rem;
    }

    .error-card {
      text-align: center;
      padding: var(--spacing-2xl);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(239, 68, 68, 0.5);
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 1024px) {
      .feature-item {
        grid-template-columns: 150px 1fr 50px;
      }
    }

    @media (max-width: 768px) {
      .page-title {
        font-size: 1.5rem;
      }

      .dhc-quick-metrics {
        grid-template-columns: repeat(2, 1fr);
      }

      .cta-buttons {
        flex-direction: column;
      }

      .feature-item {
        grid-template-columns: 1fr;
        gap: var(--spacing-sm);
      }

      .feature-label {
        justify-content: space-between;
      }
    }
  </style>

  <script is:inline>
    function selectVenue(event, button) {
      event.preventDefault();

      const venueIndex = button.getAttribute('data-venue-index');

      // ä¼šå ´ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.venue-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      button.classList.add('active');

      // ä¼šå ´ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.venue-content').forEach(content => {
        content.classList.remove('active');
      });

      const selectedVenue = document.querySelector(`.venue-content[data-venue-index="${venueIndex}"]`);
      if (selectedVenue) {
        selectedVenue.classList.add('active');
      }

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function selectRace(event, button) {
      event.preventDefault();

      const venueIndex = button.getAttribute('data-venue-index');
      const raceIndex = button.getAttribute('data-race-index');

      // ç¾åœ¨ã®ä¼šå ´å†…ã®ãƒ¬ãƒ¼ã‚¹ãƒœã‚¿ãƒ³ã®ã¿æ›´æ–°
      const currentVenue = document.querySelector(`.venue-content[data-venue-index="${venueIndex}"]`);
      if (!currentVenue) return;

      currentVenue.querySelectorAll('.race-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      button.classList.add('active');

      // ç¾åœ¨ã®ä¼šå ´å†…ã®ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã¿æ›´æ–°
      currentVenue.querySelectorAll('.race-content').forEach(content => {
        content.classList.remove('active');
      });

      const selectedRace = currentVenue.querySelector(`.race-content[data-venue-index="${venueIndex}"][data-race-index="${raceIndex}"]`);
      if (selectedRace) {
        selectedRace.classList.add('active');
      }
    }
  </script>
</BaseLayout>
