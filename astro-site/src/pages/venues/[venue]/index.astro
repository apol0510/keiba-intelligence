---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { readFileSync, existsSync } from 'fs';
import { join } from 'path';

export const prerender = false;

const { venue } = Astro.params;

// ä¼šå ´åãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ â†’ æ—¥æœ¬èªè¡¨è¨˜ï¼‰
const venueMap = {
  'funabashi': 'èˆ¹æ©‹',
  'kawasaki': 'å·å´',
  'ooi': 'å¤§äº•',
  'urawa': 'æµ¦å’Œ',
};

const venueName = venueMap[venue] || venue;

// archiveResults.jsonã‹ã‚‰è©²å½“ä¼šå ´ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
const archivePath = join(process.cwd(), 'src', 'data', 'archiveResults.json');
let venueData = [];
let venueStats = {
  totalDays: 0,
  totalRaces: 0,
  totalHitRaces: 0,
  totalBetAmount: 0,
  totalPayout: 0,
  hitRate: 0,
  returnRate: 0,
  bestDay: null,
  worstDay: null,
  highestPayout: null,
};

try {
  if (existsSync(archivePath)) {
    const fileContent = readFileSync(archivePath, 'utf-8');
    const allData = JSON.parse(fileContent);

    // è©²å½“ä¼šå ´ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºï¼ˆæ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆï¼‰
    venueData = allData.filter(entry => entry.venue === venueName)
      .sort((a, b) => b.date.localeCompare(a.date)); // é™é †ã‚½ãƒ¼ãƒˆ

    // ä¼šå ´çµ±è¨ˆã‚’è¨ˆç®—
    venueData.forEach(entry => {
      venueStats.totalDays++;
      venueStats.totalRaces += entry.totalRaces;
      venueStats.totalHitRaces += entry.hitRaces;
      venueStats.totalBetAmount += entry.betAmount;
      venueStats.totalPayout += entry.totalPayout;

      // æœ€é«˜å›åç‡ã®æ—¥
      if (!venueStats.bestDay || entry.returnRate > venueStats.bestDay.returnRate) {
        venueStats.bestDay = entry;
      }

      // æœ€ä½å›åç‡ã®æ—¥
      if (!venueStats.worstDay || entry.returnRate < venueStats.worstDay.returnRate) {
        venueStats.worstDay = entry;
      }

      // æœ€é«˜é…å½“ã®æ—¥
      if (!venueStats.highestPayout || entry.totalPayout > venueStats.highestPayout.totalPayout) {
        venueStats.highestPayout = entry;
      }
    });

    if (venueStats.totalRaces > 0) {
      venueStats.hitRate = ((venueStats.totalHitRaces / venueStats.totalRaces) * 100).toFixed(1);
    }
    if (venueStats.totalBetAmount > 0) {
      venueStats.returnRate = ((venueStats.totalPayout / venueStats.totalBetAmount) * 100).toFixed(1);
    }
  }
} catch (error) {
  console.error('Error loading archive:', error);
}

const pageTitle = venueData.length > 0
  ? `${venueName}ç«¶é¦¬ çš„ä¸­å®Ÿç¸¾ãƒ»çµ±è¨ˆãƒ‡ãƒ¼ã‚¿`
  : `${venueName}ç«¶é¦¬ çš„ä¸­å®Ÿç¸¾`;

const pageDescription = venueData.length > 0
  ? `${venueName}ç«¶é¦¬ã®çš„ä¸­å®Ÿç¸¾ã€‚é–‹å‚¬æ—¥æ•°${venueStats.totalDays}æ—¥ã€é€šç®—çš„ä¸­ç‡${venueStats.hitRate}%ã€é€šç®—å›åç‡${venueStats.returnRate}%ã€é€šç®—åˆè¨ˆé…å½“Â¥${venueStats.totalPayout.toLocaleString()}`
  : `${venueName}ç«¶é¦¬ã®çš„ä¸­å®Ÿç¸¾ãƒ»çµ±è¨ˆãƒ‡ãƒ¼ã‚¿`;
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <main class="venue-page">
    <div class="container">
      {venueData.length === 0 ? (
        <div class="no-data">
          <h1>âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h1>
          <p>{venueName}ç«¶é¦¬ã®çš„ä¸­å®Ÿç¸¾ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
          <a href="/results" class="btn-back">çš„ä¸­å®Ÿç¸¾ä¸€è¦§ã¸æˆ»ã‚‹</a>
        </div>
      ) : (
        <>
          {/* ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ */}
          <header class="page-header">
            <div class="breadcrumb">
              <a href="/results">çš„ä¸­å®Ÿç¸¾</a>
              <span>/</span>
              <span>{venueName}ç«¶é¦¬</span>
            </div>
            <h1>{venueName}ç«¶é¦¬ çš„ä¸­å®Ÿç¸¾</h1>
            <div class="meta">
              <span class="venue-badge">{venueName}</span>
              <span class="days-badge">{venueStats.totalDays}æ—¥é–‹å‚¬</span>
            </div>
          </header>

          {/* é€šç®—çµ±è¨ˆ */}
          <section class="summary-section">
            <h2>é€šç®—çµ±è¨ˆ</h2>
            <div class="summary-grid">
              <div class="summary-card">
                <div class="summary-label">é–‹å‚¬æ—¥æ•°</div>
                <div class="summary-value">{venueStats.totalDays}æ—¥</div>
              </div>
              <div class="summary-card">
                <div class="summary-label">é€šç®—çš„ä¸­ç‡</div>
                <div class="summary-value highlight">{venueStats.hitRate}%</div>
                <div class="summary-detail">{venueStats.totalHitRaces}/{venueStats.totalRaces}R</div>
              </div>
              <div class="summary-card">
                <div class="summary-label">é€šç®—å›åç‡</div>
                <div class={`summary-value ${parseFloat(venueStats.returnRate) >= 100 ? 'profit' : 'loss'}`}>
                  {venueStats.returnRate}%
                </div>
              </div>
              <div class="summary-card">
                <div class="summary-label">é€šç®—åˆè¨ˆé…å½“</div>
                <div class="summary-value profit">Â¥{venueStats.totalPayout.toLocaleString()}</div>
              </div>
            </div>
          </section>

          {/* ãƒã‚¤ãƒ©ã‚¤ãƒˆè¨˜éŒ² */}
          {venueStats.bestDay && (
            <section class="highlights-section">
              <h2>ãƒã‚¤ãƒ©ã‚¤ãƒˆè¨˜éŒ²</h2>
              <div class="highlights-grid">
                {venueStats.bestDay && (
                  <div class="highlight-card best">
                    <div class="highlight-icon">ğŸ†</div>
                    <div class="highlight-label">æœ€é«˜å›åç‡</div>
                    <div class="highlight-value">{venueStats.bestDay.returnRate}%</div>
                    <div class="highlight-date">
                      <a href={`/results/${venueStats.bestDay.date.split('-')[0]}/${venueStats.bestDay.date.split('-')[1]}/${venueStats.bestDay.date.split('-')[2]}`}>
                        {venueStats.bestDay.date}
                      </a>
                    </div>
                  </div>
                )}
                {venueStats.highestPayout && (
                  <div class="highlight-card payout">
                    <div class="highlight-icon">ğŸ’°</div>
                    <div class="highlight-label">æœ€é«˜é…å½“</div>
                    <div class="highlight-value">Â¥{venueStats.highestPayout.totalPayout.toLocaleString()}</div>
                    <div class="highlight-date">
                      <a href={`/results/${venueStats.highestPayout.date.split('-')[0]}/${venueStats.highestPayout.date.split('-')[1]}/${venueStats.highestPayout.date.split('-')[2]}`}>
                        {venueStats.highestPayout.date}
                      </a>
                    </div>
                  </div>
                )}
              </div>
            </section>
          )}

          {/* é–‹å‚¬å±¥æ­´ */}
          <section class="history-section">
            <h2>é–‹å‚¬å±¥æ­´</h2>
            <div class="history-list">
              {venueData.map((dayData) => {
                const [year, month, day] = dayData.date.split('-');

                return (
                  <a
                    href={`/results/${year}/${month}/${day}`}
                    class="history-card"
                  >
                    <div class="history-date">
                      <span class="date-day">{month}/{day}</span>
                      <span class="date-year">{year}</span>
                    </div>
                    <div class="history-stats">
                      <div class="stat-item">
                        <span class="stat-label">çš„ä¸­ç‡</span>
                        <span class="stat-value highlight">{dayData.hitRate}%</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">å›åç‡</span>
                        <span class={`stat-value ${dayData.returnRate >= 100 ? 'profit' : 'loss'}`}>
                          {dayData.returnRate}%
                        </span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">é…å½“</span>
                        <span class="stat-value profit">Â¥{dayData.totalPayout.toLocaleString()}</span>
                      </div>
                    </div>
                    <div class="history-detail">
                      <span>{dayData.hitRaces}/{dayData.totalRaces}Rçš„ä¸­</span>
                    </div>
                  </a>
                );
              })}
            </div>
          </section>

          {/* ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ */}
          <footer class="page-footer">
            <a href="/results" class="btn-back">â† çš„ä¸­å®Ÿç¸¾ä¸€è¦§ã¸æˆ»ã‚‹</a>
          </footer>
        </>
      )}
    </div>
  </main>
</BaseLayout>

<style lang="scss">
  .venue-page {
    min-height: 100vh;
    padding: var(--spacing-2xl) 0;
    background: var(--bg-primary);
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--spacing-lg);
  }

  /* ãƒ‡ãƒ¼ã‚¿ãªã— */
  .no-data {
    text-align: center;
    padding: var(--spacing-2xl);
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);

    h1 {
      font-size: 2rem;
      margin-bottom: var(--spacing-md);
      color: var(--text-primary);
    }

    p {
      color: var(--text-secondary);
      margin-bottom: var(--spacing-xl);
    }
  }

  /* ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ */
  .page-header {
    margin-bottom: var(--spacing-2xl);

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
      font-size: 0.875rem;
      color: var(--text-secondary);

      a {
        color: #60a5fa;
        text-decoration: none;
        transition: color var(--transition-fast);

        &:hover {
          color: #93c5fd;
        }
      }

      span:not(.venue-badge):not(.days-badge) {
        color: var(--text-tertiary);
      }
    }

    h1 {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: var(--spacing-md);
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .meta {
      display: flex;
      gap: var(--spacing-md);
      flex-wrap: wrap;

      .venue-badge,
      .days-badge {
        padding: var(--spacing-xs) var(--spacing-md);
        background: rgba(96, 165, 250, 0.15);
        border: 1px solid rgba(96, 165, 250, 0.3);
        border-radius: var(--radius-sm);
        font-size: 0.875rem;
        font-weight: 600;
        color: #60a5fa;
      }
    }
  }

  /* é€šç®—çµ±è¨ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .summary-section {
    margin-bottom: var(--spacing-2xl);

    h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: var(--spacing-lg);
      color: var(--text-primary);
    }
  }

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-lg);
  }

  .summary-card {
    text-align: center;
    padding: var(--spacing-xl);
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
    transition: all var(--transition-normal);

    &:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    .summary-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-sm);
      font-weight: 500;
    }

    .summary-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);

      &.highlight {
        color: #60a5fa;
      }

      &.profit {
        color: #10b981;
      }

      &.loss {
        color: #ef4444;
      }
    }

    .summary-detail {
      font-size: 0.875rem;
      color: var(--text-tertiary);
    }
  }

  /* ãƒã‚¤ãƒ©ã‚¤ãƒˆè¨˜éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .highlights-section {
    margin-bottom: var(--spacing-2xl);

    h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: var(--spacing-lg);
      color: var(--text-primary);
    }
  }

  .highlights-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-lg);
  }

  .highlight-card {
    text-align: center;
    padding: var(--spacing-xl);
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    border: 2px solid var(--border-color);
    transition: all var(--transition-normal);

    &.best {
      border-color: rgba(251, 191, 36, 0.5);
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, var(--bg-secondary) 50%);
    }

    &.payout {
      border-color: rgba(16, 185, 129, 0.5);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, var(--bg-secondary) 50%);
    }

    &:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    .highlight-icon {
      font-size: 3rem;
      margin-bottom: var(--spacing-md);
    }

    .highlight-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-sm);
      font-weight: 500;
    }

    .highlight-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
    }

    .highlight-date {
      font-size: 0.875rem;

      a {
        color: #60a5fa;
        text-decoration: none;
        transition: color var(--transition-fast);

        &:hover {
          color: #93c5fd;
        }
      }
    }
  }

  /* é–‹å‚¬å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .history-section {
    margin-bottom: var(--spacing-2xl);

    h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: var(--spacing-lg);
      color: var(--text-primary);
    }
  }

  .history-list {
    display: grid;
    gap: var(--spacing-md);
  }

  .history-card {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: var(--spacing-lg);
    align-items: center;
    padding: var(--spacing-lg);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
    text-decoration: none;
    transition: all var(--transition-normal);

    &:hover {
      background: var(--bg-tertiary);
      transform: translateX(8px);
      border-color: rgba(96, 165, 250, 0.4);
    }

    .history-date {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: var(--spacing-md);
      background: rgba(0, 0, 0, 0.2);
      border-radius: var(--radius-md);
      min-width: 80px;

      .date-day {
        font-size: 1.25rem;
        font-weight: 700;
        color: #60a5fa;
      }

      .date-year {
        font-size: 0.75rem;
        color: var(--text-tertiary);
      }
    }

    .history-stats {
      display: flex;
      gap: var(--spacing-xl);

      .stat-item {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);

        .stat-label {
          font-size: 0.75rem;
          color: var(--text-tertiary);
        }

        .stat-value {
          font-size: 1.125rem;
          font-weight: 700;
          color: var(--text-primary);

          &.highlight {
            color: #60a5fa;
          }

          &.profit {
            color: #10b981;
          }

          &.loss {
            color: #ef4444;
          }
        }
      }
    }

    .history-detail {
      font-size: 0.875rem;
      color: var(--text-secondary);
      text-align: right;
    }
  }

  /* ãƒ•ãƒƒã‚¿ãƒ¼ */
  .page-footer {
    margin-top: var(--spacing-2xl);
    padding-top: var(--spacing-2xl);
    border-top: 1px solid var(--border-color);
    text-align: center;
  }

  .btn-back {
    display: inline-block;
    padding: var(--spacing-md) var(--spacing-xl);
    background: var(--bg-secondary);
    color: var(--text-primary);
    text-decoration: none;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
    font-weight: 600;
    transition: all var(--transition-normal);

    &:hover {
      background: var(--bg-tertiary);
      transform: translateY(-2px);
    }
  }

  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
  @media (max-width: 768px) {
    .page-header h1 {
      font-size: 1.5rem;
    }

    .summary-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .summary-card {
      padding: var(--spacing-lg);

      .summary-value {
        font-size: 1.5rem;
      }
    }

    .highlights-grid {
      grid-template-columns: 1fr;
    }

    .history-card {
      grid-template-columns: 1fr;
      gap: var(--spacing-md);

      .history-stats {
        flex-wrap: wrap;
        gap: var(--spacing-md);
      }

      .history-detail {
        text-align: left;
      }
    }
  }
</style>
