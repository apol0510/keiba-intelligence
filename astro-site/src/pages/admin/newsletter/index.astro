---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import AuthCheck from '../../../components/AuthCheck.astro';
---

<BaseLayout
  title="メルマガ配信管理"
  description="KEIBA Intelligence メルマガ配信管理画面">
  <AuthCheck />
  <section class="admin-newsletter">
    <div class="container">
      <div class="header">
        <h1>メルマガ配信管理</h1>
        <a href="/admin/newsletter/new" class="btn btn-primary">+ 新規配信作成</a>
      </div>

      <div id="broadcasts-list" class="broadcasts-list">
        <p>読み込み中...</p>
      </div>
    </div>
  </section>

  <style>
    .admin-newsletter {
      padding: var(--spacing-2xl) 0;
      min-height: calc(100vh - 200px);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-2xl);
    }

    .broadcasts-list {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
    }

    .broadcast-table {
      width: 100%;
      border-collapse: collapse;
    }

    .broadcast-table th {
      text-align: left;
      padding: var(--spacing-md);
      border-bottom: 2px solid var(--border-color);
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .broadcast-table td {
      padding: var(--spacing-md);
      border-bottom: 1px solid var(--border-color);
    }

    .broadcast-table tr:hover {
      background: var(--bg-secondary);
    }

    .status-badge {
      display: inline-block;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
      font-weight: 600;
    }

    .status-draft {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }

    .status-dry-run {
      background: var(--warning);
      color: white;
    }

    .status-sent {
      background: var(--success);
      color: white;
    }
  </style>

  <script>
    async function loadBroadcasts() {
      try {
        const response = await fetch('/.netlify/functions/get-broadcasts');
        const data = await response.json();

        const listEl = document.getElementById('broadcasts-list');

        if (!data.success || data.broadcasts.length === 0) {
          listEl.innerHTML = '<p>配信がありません。</p>';
          return;
        }

        const tableHtml = `
          <table class="broadcast-table">
            <thead>
              <tr>
                <th>件名</th>
                <th>状態</th>
                <th>送信件数</th>
                <th>作成日時</th>
                <th>送信日時</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              ${data.broadcasts.map(b => `
                <tr>
                  <td>${b.subject}</td>
                  <td>
                    <span class="status-badge status-${b.status}">
                      ${b.status === 'draft' ? '下書き' : b.status === 'dry-run' ? 'Dry-Run' : '送信済み'}
                    </span>
                  </td>
                  <td>${b.recipient_count || '-'}</td>
                  <td>${new Date(b.created_at).toLocaleString('ja-JP')}</td>
                  <td>${b.sent_at ? new Date(b.sent_at).toLocaleString('ja-JP') : '-'}</td>
                  <td>
                    <a href="/admin/newsletter/${b.broadcast_id}" class="btn btn-secondary">詳細</a>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

        listEl.innerHTML = tableHtml;
      } catch (error) {
        console.error('Error loading broadcasts:', error);
        document.getElementById('broadcasts-list').innerHTML = '<p>エラーが発生しました。</p>';
      }
    }

    loadBroadcasts();
  </script>
</BaseLayout>
