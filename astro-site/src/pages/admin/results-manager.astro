---
import BaseLayout from '../../layouts/BaseLayout.astro';

export const prerender = false;

let result = null;
let errorMessage = null;

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const copiedText = formData.get('copiedText');

    if (!copiedText) {
      throw new Error('ã‚³ãƒ”ãƒšãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
    }

    // ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ç›´æ¥å®Ÿè£…ï¼ˆparse-nankan-results.jsã‹ã‚‰ç§»æ¤ï¼‰
    const parsedData = parseNankanResults(copiedText);

    result = {
      parsedData,
      json: JSON.stringify(parsedData, null, 2)
    };

  } catch (error) {
    errorMessage = error.message;
  }
}

// ãƒ‘ãƒ¼ã‚µãƒ¼é–¢æ•°ï¼ˆparse-nankan-results.jsã‹ã‚‰ç§»æ¤ï¼‰
function parseNankanResults(text) {
  if (!text || typeof text !== 'string') {
    throw new Error('ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã™');
  }

  const raceInfo = extractRaceInfo(text);
  const results = extractResults(text);
  const payouts = extractPayouts(text);

  return {
    date: raceInfo.date,
    venue: raceInfo.venue,
    venueCode: raceInfo.venueCode,
    races: [
      {
        raceNumber: raceInfo.raceNumber,
        raceName: raceInfo.raceName,
        distance: raceInfo.distance,
        surface: raceInfo.surface,
        track: raceInfo.track,
        horses: raceInfo.horses,
        startTime: raceInfo.startTime,
        results,
        payouts,
        enteredAt: new Date().toISOString(),
        enteredBy: 'staff-ui'
      }
    ],
    dataVersion: '1.0'
  };
}

function extractRaceInfo(text) {
  const dateMatch = text.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
  if (!dateMatch) throw new Error('æ—¥ä»˜ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');

  const year = dateMatch[1];
  const month = dateMatch[2].padStart(2, '0');
  const day = dateMatch[3].padStart(2, '0');
  const date = `${year}-${month}-${day}`;

  const venueMatch = text.match(/(èˆ¹æ©‹|å¤§äº•|å·å´|æµ¦å’Œ)ç«¶é¦¬/);
  if (!venueMatch) throw new Error('ç«¶é¦¬å ´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');

  const venue = venueMatch[1];
  const venueCodeMap = { 'èˆ¹æ©‹': 'FU', 'å¤§äº•': 'OI', 'å·å´': 'KA', 'æµ¦å’Œ': 'UR' };
  const venueCode = venueCodeMap[venue];

  const raceNumberMatch = text.match(/ç¬¬(\d+)æ—¥/);
  const raceNumber = raceNumberMatch ? parseInt(raceNumberMatch[1], 10) : 1;

  const raceNameMatch = text.match(/æ—¥[\s\u3000]+(.+?)[\s\u3000]+ï¼¢|æ—¥[\s\u3000]+(.+?)$/m);
  const raceName = raceNameMatch ? (raceNameMatch[1] || raceNameMatch[2] || '').trim() : '';

  const distanceMatch = text.match(/[ãƒ€èŠ][\s\u3000]*(\d{1}),?(\d{3})m/);
  const distance = distanceMatch ? parseInt(distanceMatch[1] + distanceMatch[2], 10) : null;

  const surface = text.includes('ãƒ€') ? 'ãƒ€ãƒ¼ãƒˆ' : 'èŠ';

  const trackMatch = text.match(/ï¼ˆ(å¤–|å†…|å³|å·¦)ï¼‰/);
  const track = trackMatch ? trackMatch[1] : null;

  const horsesMatch = text.match(/ï¼ˆ(\d+)é ­ï¼‰/);
  const horses = horsesMatch ? parseInt(horsesMatch[1], 10) : null;

  const startTimeMatch = text.match(/ç™ºèµ°æ™‚åˆ»(\d{1,2}):(\d{2})/);
  const startTime = startTimeMatch ? `${startTimeMatch[1]}:${startTimeMatch[2]}` : null;

  return { date, venue, venueCode, raceNumber, raceName, distance, surface, track, horses, startTime };
}

function extractResults(text) {
  const results = [];
  const lines = text.split('\n');

  for (let line of lines) {
    // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: ç€ æ  é¦¬ç•ª é¦¬å æ€§é½¢ è² æ‹… é¦¬ä½“é‡ å¢—æ¸› é¨æ‰‹ èª¿æ•™å¸« ã‚¿ã‚¤ãƒ  ç€å·® ä¸ŠãŒã‚Š3F ã‚³ãƒ¼ãƒŠãƒ¼é€šéé † äººæ°—
    // ä¾‹: 1 5 7 ãƒã‚­ã‚·ãƒãƒ ãƒ‘ãƒ¯ãƒ¼ ç‰¡4 55.0 500kg -1 ç”ºç”°ç›´å¸Œ æ—æ­£äºº 2:28.0 - 39.3 - 1
    const match = line.match(/^(\d+)[\s\u3000]+(\d+)[\s\u3000]+(\d+)[\s\u3000]+(.+?)[\s\u3000]+[ç‰¡ç‰ã‚»]\d+[\s\u3000]+([\d.]+)[\s\u3000]+(\d+)kg[\s\u3000]+([+-Â±ï¼‹ï¼]?\d*)[\s\u3000]+(.+?)[\s\u3000]+(.+?)[\s\u3000]+([\d:.]+)[\s\u3000]+(.*?)[\s\u3000]+([\d.]+)[\s\u3000]+(.*)[\s\u3000]+(\d+)\s*$/);

    if (match) {
      results.push({
        rank: parseInt(match[1], 10),
        bracket: parseInt(match[2], 10),
        number: parseInt(match[3], 10),
        name: match[4].trim(),
        jockey: match[8].trim(),
        trainer: match[9].trim(),
        time: match[10].trim(),
        margin: match[11].trim() || '-',
        lastFurlong: match[12].trim(),
        popularity: parseInt(match[14], 10)
      });
    }
  }

  if (results.length === 0) throw new Error('ç€é †ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  return results;
}

function extractPayouts(text) {
  const payouts = {};

  // æ‰•æˆ»é‡‘ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡ºï¼ˆæ–‡æœ«ã¾ã§å…¨ã¦å–å¾—ï¼‰
  const payoutMatch = text.match(/æ‰•æˆ»é‡‘[\s\S]*$/);
  if (!payoutMatch) return payouts;

  const payoutSection = payoutMatch[0];
  const lines = payoutSection.split('\n').filter(l => l.trim());

  // ç¬¬1ãƒ†ãƒ¼ãƒ–ãƒ«ï¼šå˜å‹ã€œé¦¬å˜ï¼ˆæ¨ªä¸¦ã³ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
  // ãƒ‡ãƒ¼ã‚¿æ§‹é€ : å˜å‹ è¤‡å‹ æ è¤‡ æ™®é€šé¦¬è¤‡ æ å˜ é¦¬å˜ï¼ˆå„3å€¤ï¼šçµ„ç•ª é‡‘é¡ äººæ°—ï¼‰
  let table1HeaderIndex = -1;
  for (let i = 0; i < lines.length; i++) {
    if (lines[i].includes('å˜å‹') && lines[i].includes('é¦¬å˜')) {
      table1HeaderIndex = i;
      break;
    }
  }

  if (table1HeaderIndex > -1) {
    // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’è¦‹ã¤ã‘ã‚‹ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã®å¾Œã€æœ€åˆã®æ•°å­—ã§å§‹ã¾ã‚‹è¡Œï¼‰
    for (let i = table1HeaderIndex + 1; i < lines.length; i++) {
      const line = lines[i];
      if (/^[\d-]/.test(line) && !line.includes('çµ„ç•ª')) {
        // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’ç©ºç™½ã§åˆ†å‰²
        const values = line.split(/[\s\u3000]+/).filter(v => v);

        // å˜å‹: values[0-2]
        if (values.length >= 3) {
          payouts.tansho = {
            number: parseInt(values[0], 10),
            payout: parseInt(values[1].replace(/,/g, ''), 10),
            popularity: parseInt(values[2], 10)
          };
        }

        // æ™®é€šé¦¬è¤‡: values[9-11]
        if (values.length >= 12) {
          payouts.umaren = {
            combination: values[9],
            payout: parseInt(values[10].replace(/,/g, ''), 10),
            popularity: parseInt(values[11], 10)
          };
        }

        // é¦¬å˜: values[15-17]
        if (values.length >= 18) {
          payouts.umatan = {
            combination: values[15],
            payout: parseInt(values[16].replace(/,/g, ''), 10),
            popularity: parseInt(values[17], 10)
          };
        }

        break;
      }
    }
  }

  // ç¬¬2ãƒ†ãƒ¼ãƒ–ãƒ«ï¼šãƒ¯ã‚¤ãƒ‰ã€ä¸‰é€£è¤‡ã€ä¸‰é€£å˜ï¼ˆæ¨ªä¸¦ã³ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
  let table2HeaderIndex = -1;
  for (let i = 0; i < lines.length; i++) {
    if (lines[i].includes('ãƒ¯ã‚¤ãƒ‰') && lines[i].includes('ä¸‰é€£è¤‡')) {
      table2HeaderIndex = i;
      break;
    }
  }

  if (table2HeaderIndex > -1) {
    // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’è¦‹ã¤ã‘ã‚‹
    for (let i = table2HeaderIndex + 1; i < lines.length; i++) {
      const line = lines[i];
      if (/^[\d-]/.test(line) && !line.includes('çµ„ç•ª')) {
        // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’ç©ºç™½ã§åˆ†å‰²
        const values = line.split(/[\s\u3000]+/).filter(v => v);

        // ä¸‰é€£è¤‡: values[3-5] (ãƒ¯ã‚¤ãƒ‰ã¯0-2)
        if (values.length >= 6) {
          payouts.sanrenpuku = {
            combination: values[3],
            payout: parseInt(values[4].replace(/,/g, ''), 10),
            popularity: parseInt(values[5], 10)
          };
        }

        // ä¸‰é€£å˜: values[6-8]
        if (values.length >= 9) {
          payouts.sanrentan = {
            combination: values[6],
            payout: parseInt(values[7].replace(/,/g, ''), 10),
            popularity: parseInt(values[8], 10)
          };
        }

        break;
      }
    }
  }

  return payouts;
}
---

<BaseLayout
  title="çµæœç®¡ç†ç”»é¢"
  description="å—é–¢å…¬å¼ã‚µã‚¤ãƒˆã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸçµæœã‚’è‡ªå‹•è§£æã—ã¦ãƒ‡ãƒ¼ã‚¿åŒ–ã—ã¾ã™"
>
  <section class="admin-section">
    <div class="container">
      <h1 class="page-title">ğŸ‡ å—é–¢ç«¶é¦¬ çµæœç®¡ç†</h1>
      <p class="page-description">
        å—é–¢å…¬å¼ã‚µã‚¤ãƒˆã®çµæœã‚’å…¨æ–‡ã‚³ãƒ”ãƒšã—ã¦ã€è‡ªå‹•è§£æã—ã¾ã™ã€‚<br>
        <strong>â€» å…¨æ–‡ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼ˆæ—¥ä»˜ãƒ»ãƒ¬ãƒ¼ã‚¹æƒ…å ±ãƒ»ç€é †è¡¨ãƒ»æ‰•æˆ»é‡‘ã™ã¹ã¦ï¼‰</strong>
      </p>

      <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="card form-card">
        <h2>ğŸ“‹ å—é–¢å…¬å¼çµæœã‚’å…¨æ–‡ã‚³ãƒ”ãƒš</h2>
        <form method="POST">
          <div class="form-group">
            <label for="copiedText">ã‚³ãƒ”ãƒšã‚¨ãƒªã‚¢</label>
            <textarea
              id="copiedText"
              name="copiedText"
              rows="20"
              required
              class="form-textarea"
              placeholder="2026å¹´1æœˆ23æ—¥ ç¬¬10å› èˆ¹æ©‹ç«¶é¦¬ ç¬¬5æ—¥ ãƒ€2,200mï¼ˆå¤–ï¼‰ ï¼ˆ14é ­ï¼‰ ç™ºèµ°æ™‚åˆ»20:50
ã‚¬ãƒ¼ãƒãƒƒãƒˆï¼’ï¼’ï¼ï¼ ï¼¢ï¼’ï¼¢ï¼“ é¸æŠœé¦¬
ç€    æ     é¦¬ç•ª    é¦¬å    æ€§é½¢    è² æ‹…    é¦¬ä½“é‡    å¢—æ¸›    é¨æ‰‹    èª¿æ•™å¸«    ã‚¿ã‚¤ãƒ     ç€å·®    ä¸ŠãŒã‚Š3F    ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †    äººæ°—
1    5    7    ãƒã‚­ã‚·ãƒãƒ ãƒ‘ãƒ¯ãƒ¼    ç‰¡4    55.0    500kg    -1    ç”ºç”°ç›´å¸Œ    æ—æ­£äºº    2:28.0    -    39.3    -    1
2    6    9    ãƒ’ãƒ­ã‚·ã‚²ã‚¸ãƒ£ãƒƒã‚¯    ç‰¡7    57.0    528kg    ï¼‹6    ç¬ é‡é›„å¤§    å±±ä¸­å°Šå¾³    2:28.1    ã‚¯ãƒ“    40.1    -    11
...
ï¼ˆå…¨æ–‡ã‚³ãƒ”ãƒ¼ï¼‰"
            ></textarea>
          </div>

          <button type="submit" class="btn btn-primary btn-lg w-full">
            ğŸ” è‡ªå‹•è§£æ
          </button>
        </form>
      </div>

      <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
      {errorMessage && (
        <div class="card error-card">
          <h3>âŒ ã‚¨ãƒ©ãƒ¼</h3>
          <p>{errorMessage}</p>
          <p class="error-hint">
            <strong>è§£æ±ºæ–¹æ³•:</strong><br>
            âœ… æ—¥ä»˜è¡Œã‹ã‚‰æ‰•æˆ»é‡‘ã¾ã§å…¨æ–‡ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„<br>
            âœ… ã€Œ2026å¹´1æœˆ23æ—¥ã€ã®å½¢å¼ã§æ—¥ä»˜ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª<br>
            âœ… ã€Œèˆ¹æ©‹ç«¶é¦¬ã€ã€Œå¤§äº•ç«¶é¦¬ã€ã€Œå·å´ç«¶é¦¬ã€ã€Œæµ¦å’Œç«¶é¦¬ã€ã®ã„ãšã‚Œã‹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          </p>
        </div>
      )}

      <!-- çµæœè¡¨ç¤º -->
      {result && (
        <div class="results-section">
          <div class="race-card card">
            <h2 class="section-title">âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç¢ºèª</h2>

            <!-- ãƒ¬ãƒ¼ã‚¹æƒ…å ± -->
            <div class="race-info-summary">
              <h3>ğŸ“… ãƒ¬ãƒ¼ã‚¹æƒ…å ±</h3>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">æ—¥ä»˜:</span>
                  <span class="info-value">{result.parsedData.date}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">ç«¶é¦¬å ´:</span>
                  <span class="info-value">{result.parsedData.venue}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">ãƒ¬ãƒ¼ã‚¹:</span>
                  <span class="info-value">
                    ç¬¬{result.parsedData.races[0].raceNumber}R {result.parsedData.races[0].raceName}
                  </span>
                </div>
                <div class="info-item">
                  <span class="info-label">è·é›¢:</span>
                  <span class="info-value">
                    {result.parsedData.races[0].surface}{result.parsedData.races[0].distance}m
                    {result.parsedData.races[0].track && `ï¼ˆ${result.parsedData.races[0].track}ï¼‰`}
                  </span>
                </div>
                <div class="info-item">
                  <span class="info-label">é ­æ•°:</span>
                  <span class="info-value">{result.parsedData.races[0].horses}é ­</span>
                </div>
                <div class="info-item">
                  <span class="info-label">ç™ºèµ°:</span>
                  <span class="info-value">{result.parsedData.races[0].startTime}</span>
                </div>
              </div>
            </div>

            <!-- ç€é †è¡¨ç¤º -->
            <div class="results-display">
              <h3>ğŸ ç€é †</h3>
              <div class="results-table">
                <div class="table-header">
                  <span>ç€é †</span>
                  <span>æ </span>
                  <span>é¦¬ç•ª</span>
                  <span>é¦¬å</span>
                  <span>é¨æ‰‹</span>
                  <span>ã‚¿ã‚¤ãƒ </span>
                  <span>äººæ°—</span>
                </div>
                {result.parsedData.races[0].results.slice(0, 3).map((horse) => (
                  <div class={`table-row rank-${horse.rank}`}>
                    <span class="rank">{horse.rank}ç€</span>
                    <span>{horse.bracket}</span>
                    <span class="horse-number">{horse.number}</span>
                    <span class="horse-name">{horse.name}</span>
                    <span>{horse.jockey}</span>
                    <span>{horse.time}</span>
                    <span>{horse.popularity}äººæ°—</span>
                  </div>
                ))}
              </div>
            </div>

            <!-- æ‰•æˆ»é‡‘è¡¨ç¤º -->
            <div class="payouts-display">
              <h3>ğŸ’° æ‰•æˆ»é‡‘</h3>
              <div class="payouts-grid">
                {result.parsedData.races[0].payouts.tansho && (
                  <div class="payout-item">
                    <span class="payout-type">å˜å‹</span>
                    <span class="payout-combo">{result.parsedData.races[0].payouts.tansho.number}ç•ª</span>
                    <span class="payout-value">{result.parsedData.races[0].payouts.tansho.payout.toLocaleString()}å††</span>
                  </div>
                )}
                {result.parsedData.races[0].payouts.umatan && (
                  <div class="payout-item">
                    <span class="payout-type">é¦¬å˜</span>
                    <span class="payout-combo">{result.parsedData.races[0].payouts.umatan.combination}</span>
                    <span class="payout-value">{result.parsedData.races[0].payouts.umatan.payout.toLocaleString()}å††</span>
                  </div>
                )}
                {result.parsedData.races[0].payouts.sanrenpuku && (
                  <div class="payout-item">
                    <span class="payout-type">ä¸‰é€£è¤‡</span>
                    <span class="payout-combo">{result.parsedData.races[0].payouts.sanrenpuku.combination}</span>
                    <span class="payout-value">{result.parsedData.races[0].payouts.sanrenpuku.payout.toLocaleString()}å††</span>
                  </div>
                )}
                {result.parsedData.races[0].payouts.sanrentan && (
                  <div class="payout-item">
                    <span class="payout-type">ä¸‰é€£å˜</span>
                    <span class="payout-combo">{result.parsedData.races[0].payouts.sanrentan.combination}</span>
                    <span class="payout-value">{result.parsedData.races[0].payouts.sanrentan.payout.toLocaleString()}å††</span>
                  </div>
                )}
              </div>
            </div>

            <!-- JSONå‡ºåŠ› -->
            <div class="json-output">
              <h3>JSONå‡ºåŠ›</h3>
              <textarea
                readonly
                rows="20"
                class="json-textarea"
              >{result.json}</textarea>
              <div class="button-group">
                <button
                  type="button"
                  class="btn btn-secondary"
                  onclick="navigator.clipboard.writeText(document.querySelector('.json-textarea').value).then(() => alert('JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'))"
                >
                  ğŸ“‹ JSONã‚’ã‚³ãƒ”ãƒ¼
                </button>
                <button
                  type="button"
                  id="saveToGitBtn"
                  class="btn btn-primary"
                  onclick="saveToKeibaDataShared()"
                >
                  ğŸš€ ä¿å­˜ã—ã¦Git Push
                </button>
              </div>
              <div id="saveStatus" class="save-status" style="display: none;"></div>
              <p class="save-hint">
                <strong>ã€ŒğŸš€ ä¿å­˜ã—ã¦Git Pushã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨:</strong><br>
                1. è‡ªå‹•çš„ã« keiba-data-shared ãƒªãƒã‚¸ãƒˆãƒªã«ä¿å­˜<br>
                2. Git ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ãŒè‡ªå‹•å®Ÿè¡Œ<br>
                3. å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å³åº§ã«åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ ğŸ‰
              </p>
            </div>
          </div>
        </div>
      )}

      <!-- ä½¿ç”¨æ–¹æ³• -->
      <div class="card info-card">
        <h2>ä½¿ç”¨æ–¹æ³•</h2>
        <ol>
          <li><strong>å—é–¢å…¬å¼ã‚µã‚¤ãƒˆ</strong>ã§çµæœãƒšãƒ¼ã‚¸ã‚’é–‹ã</li>
          <li>æ—¥ä»˜è¡Œã‹ã‚‰æ‰•æˆ»é‡‘ã¾ã§<strong>å…¨æ–‡é¸æŠãƒ»ã‚³ãƒ”ãƒ¼</strong></li>
          <li>ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã«<strong>ãƒšãƒ¼ã‚¹ãƒˆ</strong></li>
          <li>ã€Œè‡ªå‹•è§£æã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
          <li>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèª</li>
          <li>JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¦<code>keiba-data-shared</code>ãƒªãƒã‚¸ãƒˆãƒªã«ä¿å­˜</li>
          <li>Git ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã§å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…±æœ‰å®Œäº† ğŸ‰</li>
        </ol>

        <h3>âš ï¸ æ³¨æ„äº‹é …</h3>
        <ul>
          <li>å¿…ãš<strong>å…¨æ–‡ã‚³ãƒ”ãƒ¼</strong>ã—ã¦ãã ã•ã„ï¼ˆéƒ¨åˆ†ã‚³ãƒ”ãƒ¼ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ï¼‰</li>
          <li>æ—¥ä»˜ãƒ»ç«¶é¦¬å ´ãƒ»ãƒ¬ãƒ¼ã‚¹ç•ªå·ãƒ»ç€é †è¡¨ãƒ»æ‰•æˆ»é‡‘ãŒã™ã¹ã¦å«ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™</li>
        </ul>
      </div>
    </div>
  </section>

  <style>
    .admin-section {
      padding: var(--spacing-2xl) 0;
      min-height: 100vh;
    }

    .page-title {
      font-size: 2rem;
      margin-bottom: var(--spacing-md);
      text-align: center;
    }

    .page-description {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-2xl);
    }

    .form-card {
      max-width: 1000px;
      margin: 0 auto var(--spacing-xl);
    }

    .form-group {
      margin-bottom: var(--spacing-lg);
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
    }

    .form-textarea {
      width: 100%;
      padding: var(--spacing-sm);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      resize: vertical;
    }

    .error-card {
      max-width: 800px;
      margin: 0 auto var(--spacing-xl);
      border: 2px solid var(--error);
      background: rgba(239, 68, 68, 0.1);
    }

    .error-hint {
      margin-top: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
    }

    .results-section {
      margin-top: var(--spacing-2xl);
    }

    .race-card {
      max-width: 1200px;
      margin: 0 auto;
    }

    .section-title {
      font-size: 1.75rem;
      margin-bottom: var(--spacing-xl);
      padding-bottom: var(--spacing-md);
      border-bottom: 2px solid var(--border-color);
    }

    .race-info-summary {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
      margin-top: var(--spacing-md);
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }

    .info-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .info-value {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .results-display,
    .payouts-display {
      margin-bottom: var(--spacing-xl);
    }

    .results-display h3,
    .payouts-display h3 {
      font-size: 1.25rem;
      margin-bottom: var(--spacing-md);
    }

    .results-table {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }

    .table-header,
    .table-row {
      display: grid;
      grid-template-columns: 60px 40px 60px 1fr 120px 100px 60px;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm);
      align-items: center;
    }

    .table-header {
      font-weight: 700;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
    }

    .table-row {
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
    }

    .table-row.rank-1 {
      border-left: 4px solid #fbbf24;
    }

    .table-row.rank-2 {
      border-left: 4px solid #9ca3af;
    }

    .table-row.rank-3 {
      border-left: 4px solid #cd7f32;
    }

    .rank {
      font-weight: 700;
    }

    .horse-number {
      font-weight: 700;
      color: var(--primary-end);
    }

    .horse-name {
      font-weight: 600;
    }

    .payouts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--spacing-md);
    }

    .payout-item {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
      padding: var(--spacing-md);
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
    }

    .payout-type {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .payout-combo {
      font-size: 1.125rem;
      font-weight: 600;
      font-family: 'Courier New', monospace;
    }

    .payout-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--success);
    }

    .json-output {
      margin-top: var(--spacing-xl);
    }

    .json-textarea {
      width: 100%;
      padding: var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      resize: vertical;
    }

    .save-hint {
      margin-top: var(--spacing-md);
      padding: var(--spacing-md);
      background: rgba(59, 130, 246, 0.1);
      border-left: 4px solid var(--primary-end);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
    }

    .save-hint code {
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
    }

    .info-card {
      max-width: 1200px;
      margin: var(--spacing-xl) auto 0;
    }

    .info-card ol,
    .info-card ul {
      margin-left: var(--spacing-lg);
      color: var(--text-secondary);
    }

    .info-card li {
      margin-bottom: var(--spacing-sm);
    }

    .info-card code {
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
    }

    .w-full {
      width: 100%;
    }

    .mt-2 {
      margin-top: var(--spacing-md);
    }

    .button-group {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-md);
    }

    .button-group .btn {
      flex: 1;
    }

    .save-status {
      margin-top: var(--spacing-md);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      font-weight: 600;
    }

    .save-status.success {
      background: rgba(16, 185, 129, 0.1);
      border-left: 4px solid var(--success);
      color: var(--success);
    }

    .save-status.error {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid var(--error);
      color: var(--error);
    }

    .save-status.loading {
      background: rgba(59, 130, 246, 0.1);
      border-left: 4px solid var(--primary-end);
      color: var(--primary-end);
    }
  </style>

  <script>
    async function saveToKeibaDataShared() {
      const btn = document.getElementById('saveToGitBtn');
      const statusDiv = document.getElementById('saveStatus');
      const jsonTextarea = document.querySelector('.json-textarea');

      if (!jsonTextarea) {
        alert('JSONãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      const resultsJSON = jsonTextarea.value;

      // ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
      btn.disabled = true;
      btn.textContent = 'â³ ä¿å­˜ä¸­...';

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
      statusDiv.style.display = 'block';
      statusDiv.className = 'save-status loading';
      statusDiv.textContent = 'ğŸš€ keiba-data-shared ãƒªãƒã‚¸ãƒˆãƒªã«ä¿å­˜ä¸­...';

      try {
        // Netlify Functionã‚’å‘¼ã³å‡ºã—
        const response = await fetch('/.netlify/functions/save-to-keiba-data-shared', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ resultsJSON })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          // æˆåŠŸ
          statusDiv.className = 'save-status success';
          statusDiv.innerHTML = `
            âœ… ${data.message}<br>
            <strong>ãƒ•ã‚¡ã‚¤ãƒ«:</strong> ${data.filePath}<br>
            <strong>ãƒªãƒã‚¸ãƒˆãƒª:</strong> <a href="${data.repoUrl}" target="_blank">${data.repoUrl}</a><br>
            <strong>ã‚³ãƒŸãƒƒãƒˆ:</strong> <a href="${data.commitUrl}" target="_blank">GitHubã§ç¢ºèª</a><br>
            <strong>Raw URL:</strong> <a href="${data.rawUrl}" target="_blank">ãƒ‡ãƒ¼ã‚¿URL</a>
          `;
          btn.textContent = 'âœ… ä¿å­˜å®Œäº†';
        } else {
          // ã‚¨ãƒ©ãƒ¼
          statusDiv.className = 'save-status error';
          statusDiv.innerHTML = `
            âŒ ã‚¨ãƒ©ãƒ¼: ${data.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'}<br>
            ${data.hint ? `<strong>ãƒ’ãƒ³ãƒˆ:</strong> ${data.hint}` : ''}
          `;
          btn.disabled = false;
          btn.textContent = 'ğŸš€ ä¿å­˜ã—ã¦Git Push';
        }
      } catch (error) {
        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
        statusDiv.className = 'save-status error';
        statusDiv.innerHTML = `
          âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}<br>
          <strong>å¯¾å‡¦æ³•:</strong> ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„
        `;
        btn.disabled = false;
        btn.textContent = 'ğŸš€ ä¿å­˜ã—ã¦Git Push';
      }
    }
  </script>
</BaseLayout>
