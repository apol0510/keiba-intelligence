---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { readFileSync, existsSync } from 'fs';
import { join } from 'path';

export const prerender = false;

const { year } = Astro.params;

// archiveResults.jsonã‹ã‚‰è©²å½“å¹´ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
const archivePath = join(process.cwd(), 'src', 'data', 'archiveResults.json');
let yearData = [];
let yearStats = {
  totalDays: 0,
  totalRaces: 0,
  totalHitRaces: 0,
  totalBetAmount: 0,
  totalPayout: 0,
  hitRate: 0,
  returnRate: 0,
  bestMonth: null,
  worstMonth: null,
};
let monthlyStats = {};

try {
  if (existsSync(archivePath)) {
    const fileContent = readFileSync(archivePath, 'utf-8');
    const allData = JSON.parse(fileContent);

    // è©²å½“å¹´ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
    yearData = allData.filter(entry => {
      const [entryYear] = entry.date.split('-');
      return entryYear === year;
    }).sort((a, b) => b.date.localeCompare(a.date)); // é™é †ã‚½ãƒ¼ãƒˆ

    // å¹´é–“çµ±è¨ˆã‚’è¨ˆç®—
    yearData.forEach(entry => {
      yearStats.totalDays++;
      yearStats.totalRaces += entry.totalRaces;
      yearStats.totalHitRaces += entry.hitRaces;
      yearStats.totalBetAmount += entry.betAmount;
      yearStats.totalPayout += entry.totalPayout;

      // æœˆåˆ¥çµ±è¨ˆ
      const [, month] = entry.date.split('-');
      if (!monthlyStats[month]) {
        monthlyStats[month] = {
          month,
          totalDays: 0,
          totalRaces: 0,
          totalHitRaces: 0,
          totalBetAmount: 0,
          totalPayout: 0,
          hitRate: 0,
          returnRate: 0,
        };
      }

      monthlyStats[month].totalDays++;
      monthlyStats[month].totalRaces += entry.totalRaces;
      monthlyStats[month].totalHitRaces += entry.hitRaces;
      monthlyStats[month].totalBetAmount += entry.betAmount;
      monthlyStats[month].totalPayout += entry.totalPayout;
    });

    // æœˆåˆ¥çµ±è¨ˆã®çš„ä¸­ç‡ãƒ»å›åç‡è¨ˆç®—
    Object.values(monthlyStats).forEach(month => {
      if (month.totalRaces > 0) {
        month.hitRate = ((month.totalHitRaces / month.totalRaces) * 100).toFixed(1);
      }
      if (month.totalBetAmount > 0) {
        month.returnRate = ((month.totalPayout / month.totalBetAmount) * 100).toFixed(1);
      }

      // æœ€é«˜ãƒ»æœ€ä½å›åç‡ã®æœˆ
      if (!yearStats.bestMonth || parseFloat(month.returnRate) > parseFloat(yearStats.bestMonth.returnRate)) {
        yearStats.bestMonth = month;
      }
      if (!yearStats.worstMonth || parseFloat(month.returnRate) < parseFloat(yearStats.worstMonth.returnRate)) {
        yearStats.worstMonth = month;
      }
    });

    // å¹´é–“çµ±è¨ˆã®çš„ä¸­ç‡ãƒ»å›åç‡è¨ˆç®—
    if (yearStats.totalRaces > 0) {
      yearStats.hitRate = ((yearStats.totalHitRaces / yearStats.totalRaces) * 100).toFixed(1);
    }
    if (yearStats.totalBetAmount > 0) {
      yearStats.returnRate = ((yearStats.totalPayout / yearStats.totalBetAmount) * 100).toFixed(1);
    }
  }
} catch (error) {
  console.error('Error loading archive:', error);
}

const pageTitle = yearData.length > 0
  ? `${year}å¹´ çš„ä¸­å®Ÿç¸¾ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–`
  : 'çš„ä¸­å®Ÿç¸¾ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';

const pageDescription = yearData.length > 0
  ? `${year}å¹´ã®çš„ä¸­å®Ÿç¸¾ã€‚é–‹å‚¬æ—¥æ•°${yearStats.totalDays}æ—¥ã€å¹´é–“çš„ä¸­ç‡${yearStats.hitRate}%ã€å¹´é–“å›åç‡${yearStats.returnRate}%ã€å¹´é–“åˆè¨ˆé…å½“Â¥${yearStats.totalPayout.toLocaleString()}`
  : 'å—é–¢ç«¶é¦¬ã®çš„ä¸­å®Ÿç¸¾ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–';
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <main class="year-archive-page">
    <div class="container">
      {yearData.length === 0 ? (
        <div class="no-data">
          <h1>âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h1>
          <p>{year}å¹´ã®çš„ä¸­å®Ÿç¸¾ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
          <a href="/results" class="btn-back">çš„ä¸­å®Ÿç¸¾ä¸€è¦§ã¸æˆ»ã‚‹</a>
        </div>
      ) : (
        <>
          {/* ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ */}
          <header class="page-header">
            <div class="breadcrumb">
              <a href="/results">çš„ä¸­å®Ÿç¸¾</a>
              <span>/</span>
              <span>{year}å¹´</span>
            </div>
            <h1>{year}å¹´ çš„ä¸­å®Ÿç¸¾ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</h1>
          </header>

          {/* å¹´é–“ã‚µãƒãƒªãƒ¼çµ±è¨ˆ */}
          <section class="summary-section">
            <h2>å¹´é–“ã‚µãƒãƒªãƒ¼</h2>
            <div class="summary-grid">
              <div class="summary-card">
                <div class="summary-label">é–‹å‚¬æ—¥æ•°</div>
                <div class="summary-value">{yearStats.totalDays}æ—¥</div>
              </div>
              <div class="summary-card">
                <div class="summary-label">å¹´é–“çš„ä¸­ç‡</div>
                <div class="summary-value highlight">{yearStats.hitRate}%</div>
                <div class="summary-detail">{yearStats.totalHitRaces}/{yearStats.totalRaces}R</div>
              </div>
              <div class="summary-card">
                <div class="summary-label">å¹´é–“å›åç‡</div>
                <div class={`summary-value ${parseFloat(yearStats.returnRate) >= 100 ? 'profit' : 'loss'}`}>
                  {yearStats.returnRate}%
                </div>
              </div>
              <div class="summary-card">
                <div class="summary-label">å¹´é–“åˆè¨ˆé…å½“</div>
                <div class="summary-value profit">Â¥{yearStats.totalPayout.toLocaleString()}</div>
              </div>
            </div>
          </section>

          {/* ãƒã‚¤ãƒ©ã‚¤ãƒˆ */}
          {yearStats.bestMonth && yearStats.worstMonth && (
            <section class="highlights-section">
              <h2>ãƒã‚¤ãƒ©ã‚¤ãƒˆ</h2>
              <div class="highlights-grid">
                <div class="highlight-card best">
                  <div class="highlight-icon">ğŸ†</div>
                  <div class="highlight-label">æœ€é«˜å›åç‡ã®æœˆ</div>
                  <div class="highlight-value">{yearStats.bestMonth.returnRate}%</div>
                  <div class="highlight-date">
                    <a href={`/archive/${year}/${yearStats.bestMonth.month}`}>
                      {year}å¹´{yearStats.bestMonth.month}æœˆ
                    </a>
                  </div>
                </div>
                <div class="highlight-card worst">
                  <div class="highlight-icon">ğŸ“‰</div>
                  <div class="highlight-label">æœ€ä½å›åç‡ã®æœˆ</div>
                  <div class="highlight-value">{yearStats.worstMonth.returnRate}%</div>
                  <div class="highlight-date">
                    <a href={`/archive/${year}/${yearStats.worstMonth.month}`}>
                      {year}å¹´{yearStats.worstMonth.month}æœˆ
                    </a>
                  </div>
                </div>
              </div>
            </section>
          )}

          {/* æœˆåˆ¥çµ±è¨ˆ */}
          <section class="monthly-section">
            <h2>æœˆåˆ¥çµ±è¨ˆ</h2>
            <div class="monthly-grid">
              {Object.values(monthlyStats).sort((a, b) => b.month.localeCompare(a.month)).map((month) => (
                <a
                  href={`/archive/${year}/${month.month}`}
                  class="month-card"
                >
                  <div class="month-header">
                    <span class="month-label">{month.month}æœˆ</span>
                    <span class="month-days">{month.totalDays}æ—¥</span>
                  </div>
                  <div class="month-stats">
                    <div class="stat-row">
                      <span class="stat-label">çš„ä¸­ç‡</span>
                      <span class="stat-value highlight">{month.hitRate}%</span>
                    </div>
                    <div class="stat-row">
                      <span class="stat-label">å›åç‡</span>
                      <span class={`stat-value ${parseFloat(month.returnRate) >= 100 ? 'profit' : 'loss'}`}>
                        {month.returnRate}%
                      </span>
                    </div>
                    <div class="stat-row">
                      <span class="stat-label">é…å½“</span>
                      <span class="stat-value profit">Â¥{month.totalPayout.toLocaleString()}</span>
                    </div>
                  </div>
                  <div class="month-detail">
                    {month.totalHitRaces}/{month.totalRaces}Rçš„ä¸­
                  </div>
                </a>
              ))}
            </div>
          </section>

          {/* ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ */}
          <footer class="page-footer">
            <a href="/results" class="btn-back">â† çš„ä¸­å®Ÿç¸¾ä¸€è¦§ã¸æˆ»ã‚‹</a>
          </footer>
        </>
      )}
    </div>
  </main>
</BaseLayout>

<style lang="scss">
  .year-archive-page {
    min-height: 100vh;
    padding: var(--spacing-2xl) 0;
    background: var(--bg-primary);
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--spacing-lg);
  }

  /* ãƒ‡ãƒ¼ã‚¿ãªã— */
  .no-data {
    text-align: center;
    padding: var(--spacing-2xl);
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);

    h1 {
      font-size: 2rem;
      margin-bottom: var(--spacing-md);
      color: var(--text-primary);
    }

    p {
      color: var(--text-secondary);
      margin-bottom: var(--spacing-xl);
    }
  }

  /* ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ */
  .page-header {
    margin-bottom: var(--spacing-2xl);

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
      font-size: 0.875rem;
      color: var(--text-secondary);

      a {
        color: #60a5fa;
        text-decoration: none;
        transition: color var(--transition-fast);

        &:hover {
          color: #93c5fd;
        }
      }

      span {
        color: var(--text-tertiary);
      }
    }

    h1 {
      font-size: 2rem;
      font-weight: 800;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
  }

  /* ã‚µãƒãƒªãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .summary-section {
    margin-bottom: var(--spacing-2xl);

    h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: var(--spacing-lg);
      color: var(--text-primary);
    }
  }

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-lg);
  }

  .summary-card {
    text-align: center;
    padding: var(--spacing-xl);
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
    transition: all var(--transition-normal);

    &:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    .summary-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-sm);
      font-weight: 500;
    }

    .summary-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);

      &.highlight {
        color: #60a5fa;
      }

      &.profit {
        color: #10b981;
      }

      &.loss {
        color: #ef4444;
      }
    }

    .summary-detail {
      font-size: 0.875rem;
      color: var(--text-tertiary);
    }
  }

  /* ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .highlights-section {
    margin-bottom: var(--spacing-2xl);

    h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: var(--spacing-lg);
      color: var(--text-primary);
    }
  }

  .highlights-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-lg);
  }

  .highlight-card {
    text-align: center;
    padding: var(--spacing-xl);
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    border: 2px solid var(--border-color);
    transition: all var(--transition-normal);

    &.best {
      border-color: rgba(251, 191, 36, 0.5);
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, var(--bg-secondary) 50%);
    }

    &.worst {
      border-color: rgba(239, 68, 68, 0.3);
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, var(--bg-secondary) 50%);
    }

    &:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    .highlight-icon {
      font-size: 3rem;
      margin-bottom: var(--spacing-md);
    }

    .highlight-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-sm);
      font-weight: 500;
    }

    .highlight-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
    }

    .highlight-date {
      font-size: 0.875rem;

      a {
        color: #60a5fa;
        text-decoration: none;
        transition: color var(--transition-fast);

        &:hover {
          color: #93c5fd;
        }
      }
    }
  }

  /* æœˆåˆ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .monthly-section {
    margin-bottom: var(--spacing-2xl);

    h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: var(--spacing-lg);
      color: var(--text-primary);
    }
  }

  .monthly-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--spacing-lg);
  }

  .month-card {
    display: flex;
    flex-direction: column;
    padding: var(--spacing-lg);
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
    text-decoration: none;
    transition: all var(--transition-normal);

    &:hover {
      background: var(--bg-tertiary);
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      border-color: rgba(96, 165, 250, 0.4);
    }

    .month-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-md);
      border-bottom: 1px solid var(--border-color);

      .month-label {
        font-size: 1.5rem;
        font-weight: 700;
        color: #60a5fa;
      }

      .month-days {
        font-size: 0.875rem;
        color: var(--text-tertiary);
      }
    }

    .month-stats {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-md);

      .stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;

        .stat-label {
          font-size: 0.875rem;
          color: var(--text-secondary);
        }

        .stat-value {
          font-size: 1.125rem;
          font-weight: 700;
          color: var(--text-primary);

          &.highlight {
            color: #60a5fa;
          }

          &.profit {
            color: #10b981;
          }

          &.loss {
            color: #ef4444;
          }
        }
      }
    }

    .month-detail {
      font-size: 0.875rem;
      color: var(--text-tertiary);
      text-align: center;
      padding-top: var(--spacing-sm);
      border-top: 1px solid var(--border-color);
    }
  }

  /* ãƒ•ãƒƒã‚¿ãƒ¼ */
  .page-footer {
    margin-top: var(--spacing-2xl);
    padding-top: var(--spacing-2xl);
    border-top: 1px solid var(--border-color);
    text-align: center;
  }

  .btn-back {
    display: inline-block;
    padding: var(--spacing-md) var(--spacing-xl);
    background: var(--bg-secondary);
    color: var(--text-primary);
    text-decoration: none;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
    font-weight: 600;
    transition: all var(--transition-normal);

    &:hover {
      background: var(--bg-tertiary);
      transform: translateY(-2px);
    }
  }

  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
  @media (max-width: 768px) {
    .page-header h1 {
      font-size: 1.5rem;
    }

    .summary-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .summary-card {
      padding: var(--spacing-lg);

      .summary-value {
        font-size: 1.5rem;
      }
    }

    .highlights-grid {
      grid-template-columns: 1fr;
    }

    .monthly-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
