# Prediction Converter テストケース

## 概要

このディレクトリには、`/admin/prediction-converter` の動作確認・回帰テスト用のサンプルデータが含まれています。

## ファイル構成

- **prediction-converter-samples.txt**: 8つのテストケース集
  - 基本ケース
  - 本命絶対軸固定ケース（89〜90pt）
  - 本命昇格ケース（本命pt ≤86）
  - 本命-対抗pt差3pt以内（入れ替え判定）
  - 対抗-単穴pt差3pt以内（入れ替え判定）
  - 単穴下位-連下上位pt差2pt以内（入れ替え判定）
  - 同点馬が複数（馬番昇順ルール確認）
  - 小数ptケース（pt計算外部実施の確認）

## Prediction Converter 仕様概要

### 入力仕様

- **形式**: `馬番,馬名,pt` （1行1頭）
- **pt値**: 外部で計算済みの値を入力（converter内では計算しない）
- **旧用語互換**: 入力データに旧用語（特徴量重要度、累積スコア等）が含まれていてもpt抽出可能

### 処理フロー

1. **データ解析** (`parseInputData`)
   - 馬番,馬名,pt形式の入力データを解析
   - pt降順でソート（同点時は馬番昇順）

2. **初期役割割当** (`assignInitialRoles`)
   - pt降順で本命/対抗/単穴/連下/抑えを仮割当

3. **役割調整ルール** (`applyAdjustmentRules`)
   - **ルール①**: 本命ptが 89 <= pt <= 90 → 本命枠のみ絶対軸固定
   - **ルール②**: 本命-対抗pt差 ≤3 → 馬番昇順で入れ替え判定
   - **ルール③**: 本命pt ≤86 → 対抗を本命に昇格、単穴最上位を対抗に昇格
   - **ルール④**: 対抗-単穴pt差 ≤3 → 馬番昇順で入れ替え判定
   - **ルール⑤**: 単穴下位-連下上位pt差 ≤2 → 馬番昇順で入れ替え判定
   - **重要**: 5つのルールは順次1回ずつ評価・適用

4. **買い目生成** (`generateBettingLines`)
   - 2段構成: `13-6.4.7.3.9.11.10(抑え1.2.12)`

5. **JSON出力** (`outputJSON`)
   - 予想ページ用JSON生成
   - **重要**: 出力では旧用語を一切使用しない

### 出力仕様

- **買い目形式**: 2段構成（`本命-対抗.単穴.連下(抑え馬番)`）
- **JSON形式**: レース情報、馬データ、買い目を含む
- **旧用語**: 出力には一切含まない

### 重要な設計原則

✅ **pt計算は外部で実施**（converter内では計算しない）
✅ **出力では旧用語を一切使用しない**
✅ **入力は旧用語が含まれていてもpt抽出可能**
✅ **モジュール設計**（関数分離で保守性向上）
✅ **同点時の一貫ルール**（すべての比較・選抜で馬番昇順）
✅ **5つのルールを順次1回ずつ適用**
✅ **本命固定時は対抗以下のみ調整対象**

## テスト方法

1. `/admin/prediction-converter` にアクセス
2. レース情報を入力（例: 2026-01-12, 大井, 1R）
3. `prediction-converter-samples.txt` から任意のサンプルをコピー
4. 馬データフィールドにペースト
5. 「予想データ生成」ボタンをクリック
6. 期待される買い目と一致することを確認

## 回帰テスト時のチェックポイント

- [ ] 全サンプルで正しい役割割当が行われる
- [ ] 買い目が期待通りの2段構成で生成される
- [ ] 出力JSONに旧用語が含まれない
- [ ] 同点の場合、馬番昇順で処理される
- [ ] 本命固定ケース（89〜90pt）で対抗以下のみが調整対象となる
- [ ] 小数ptが正しく処理される
- [ ] エラーメッセージが適切に表示される

## 改修時の注意事項

このconverterは **"壊れにくい"** 設計になっていますが、改修時は以下の点に注意してください：

1. **pt計算ロジックを追加しない**（外部で実施）
2. **旧用語を出力に含めない**（入力互換のみ）
3. **5つのルールの評価順序を変更しない**
4. **同点時の馬番昇順ルールを全ての比較に適用**
5. **本命固定時は対抗以下のみを調整対象とする**

改修後は必ず全サンプルでテストを実行してください。
