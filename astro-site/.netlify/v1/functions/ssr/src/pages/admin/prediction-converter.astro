---
import BaseLayout from '../../layouts/BaseLayout.astro';
// import AuthCheck from '../../components/AuthCheck.astro'; // ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–

export const prerender = false;

let result = null;
let errorMessage = null;

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const raceDate = formData.get('raceDate');
    const venue = formData.get('venue');
    const raceNumber = formData.get('raceNumber');
    const horseData = formData.get('horseData');

    // ãƒ‡ãƒ¼ã‚¿è§£æï¼ˆå…¥åŠ›â†’ptæŠ½å‡ºï¼‰
    const horses = parseInputData(horseData);

    // åˆæœŸå½¹å‰²å‰²å½“ï¼ˆpté™é †ä»®å‰²å½“ï¼‰
    const rolesAssigned = assignInitialRoles(horses);

    // å½¹å‰²èª¿æ•´ãƒ«ãƒ¼ãƒ«å®Ÿè¡Œï¼ˆ5ã¤ã®ãƒ«ãƒ¼ãƒ«é †æ¬¡é©ç”¨ï¼‰
    const rolesAdjusted = applyAdjustmentRules(rolesAssigned);

    // è²·ã„ç›®ç”Ÿæˆï¼ˆ2æ®µæ§‹æˆï¼‰
    const bettingLines = generateBettingLines(rolesAdjusted);

    // JSONå‡ºåŠ›ï¼ˆäºˆæƒ³ãƒšãƒ¼ã‚¸ç”¨ï¼‰
    const predictionJSON = outputJSON({
      raceDate,
      venue,
      raceNumber,
      horses: rolesAdjusted,
      bettingLines
    });

    result = {
      horses: rolesAdjusted,
      bettingLines,
      json: predictionJSON
    };

  } catch (error) {
    errorMessage = error.message;
  }
}

// ========================================
// ã€é–¢æ•°1ã€‘ãƒ‡ãƒ¼ã‚¿è§£æï¼ˆå…¥åŠ›â†’ptæŠ½å‡ºï¼‰
// ========================================
function parseInputData(rawInput: string) {
  const lines = rawInput.trim().split('\n');
  const horses = [];
  let currentHorse = null;

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;

    // ãƒ‘ã‚¿ãƒ¼ãƒ³1: â— 5 ãƒãƒ†ã‚£ã‚¹ãƒˆã‚¥ãƒ¼ã‚¿ æœ¬å‘½
    // ãƒ‘ã‚¿ãƒ¼ãƒ³2: â—‹ 12 ãƒ•ã‚£ãƒªãƒ”ãƒ¼ãƒŒ å¯¾æŠ—
    // ãƒ‘ã‚¿ãƒ¼ãƒ³3: â–² 8 ã‚¢ã‚¤ãƒˆã‚«ã‚³ã‚¤ãƒˆã‚« å˜ç©´
    const roleMatch = line.match(/^[â—â—‹â–²â–³Ã—]\s+(\d+)\s+(.+?)\s+(?:æœ¬å‘½|å¯¾æŠ—|å˜ç©´)$/);
    if (roleMatch) {
      currentHorse = {
        horseNumber: parseInt(roleMatch[1], 10),
        horseName: roleMatch[2],
        pt: null
      };
      continue;
    }

    // ãƒ‘ã‚¿ãƒ¼ãƒ³4: ç´¯ç©ã‚¹ã‚³ã‚¢: 89pt
    const scoreMatch = line.match(/ç´¯ç©ã‚¹ã‚³ã‚¢[ï¼š:]\s*(\d+(?:\.\d+)?)pt/);
    if (scoreMatch && currentHorse) {
      currentHorse.pt = parseFloat(scoreMatch[1]);
      horses.push({ ...currentHorse });
      currentHorse = null;
      continue;
    }

    // ãƒ‘ã‚¿ãƒ¼ãƒ³5: 4 ãƒ­ãƒ¼ãƒ‰ã‚ªãƒ–ã‚­ãƒ³ã‚° (80pt) ï¼ˆé€£ä¸‹ãƒ»æŠ‘ãˆï¼‰
    const shortMatch = line.match(/^(\d+)\s+(.+?)\s+\((\d+(?:\.\d+)?)pt\)/);
    if (shortMatch) {
      horses.push({
        horseNumber: parseInt(shortMatch[1], 10),
        horseName: shortMatch[2],
        pt: parseFloat(shortMatch[3])
      });
      continue;
    }

    // ãƒ‘ã‚¿ãƒ¼ãƒ³6: 1,ãƒã‚³ã‚¹ãƒšã‚·ãƒ£ãƒ«,90.5 ï¼ˆã‚·ãƒ³ãƒ—ãƒ«å½¢å¼ãƒ»å¾Œæ–¹äº’æ›ï¼‰
    const simpleMatch = line.match(/^(\d+)[,\s]+(.+?)[,\s]+(\d+(?:\.\d+)?)$/);
    if (simpleMatch) {
      horses.push({
        horseNumber: parseInt(simpleMatch[1], 10),
        horseName: simpleMatch[2],
        pt: parseFloat(simpleMatch[3])
      });
      continue;
    }
  }

  // pté™é †ã§ã‚½ãƒ¼ãƒˆï¼ˆåŒç‚¹ã®å ´åˆã¯é¦¬ç•ªæ˜‡é †ï¼‰
  horses.sort((a, b) => {
    if (b.pt !== a.pt) return b.pt - a.pt;
    return a.horseNumber - b.horseNumber;
  });

  return horses;
}

// ========================================
// ã€é–¢æ•°2ã€‘åˆæœŸå½¹å‰²å‰²å½“ï¼ˆpté™é †ä»®å‰²å½“ï¼‰
// ========================================
function assignInitialRoles(horses) {
  if (horses.length < 4) {
    throw new Error('æœ€ä½4é ­å¿…è¦ã§ã™ï¼ˆæœ¬å‘½1/å¯¾æŠ—1/å˜ç©´2ï¼‰');
  }

  // pté™é †ã§ã‚½ãƒ¼ãƒˆæ¸ˆã¿ã®ãŸã‚ã€ä¸Šã‹ã‚‰é †ã«ä»®å‰²å½“
  // æœ¬å‘½/å¯¾æŠ—/å˜ç©´2é ­ã‚’ç¢ºå®šå¾Œã€æ®‹ã‚Šé¦¬ã‚’é€£ä¸‹/æŠ‘ãˆã«æŒ¯ã‚Šåˆ†ã‘

  // æ®‹ã‚Šé¦¬ï¼ˆæœ¬å‘½/å¯¾æŠ—/å˜ç©´ã‚’é™¤ãï¼‰ã‚’å–å¾—
  const remaining = horses.slice(4);

  // æ®‹ã‚Šé¦¬ãŒãªã„å ´åˆã¯æœ¬å‘½/å¯¾æŠ—/å˜ç©´ã®ã¿
  if (remaining.length === 0) {
    return horses.map((horse, index) => {
      let role = '';
      if (index === 0) role = 'æœ¬å‘½';
      else if (index === 1) role = 'å¯¾æŠ—';
      else if (index === 2 || index === 3) role = 'å˜ç©´';
      return { ...horse, role };
    });
  }

  // æ®‹ã‚Šé¦¬ã®æœ€å°ptã‚’å–å¾—ï¼ˆæŠ‘ãˆ = minPtåŒç‚¹ã‚¯ãƒ©ã‚¹ï¼‰
  const minPt = Math.min(...remaining.map(h => h.pt));

  // pt == minPt ã®é¦¬ã‚’æŠ‘ãˆã€ãã‚Œä»¥å¤–ã‚’é€£ä¸‹
  return horses.map((horse, index) => {
    let role = '';
    if (index === 0) role = 'æœ¬å‘½';
    else if (index === 1) role = 'å¯¾æŠ—';
    else if (index === 2 || index === 3) role = 'å˜ç©´';
    else if (horse.pt === minPt) role = 'æŠ‘ãˆ';
    else role = 'é€£ä¸‹';

    return { ...horse, role };
  });
}

// ========================================
// ã€é–¢æ•°3ã€‘å½¹å‰²èª¿æ•´ãƒ«ãƒ¼ãƒ«ï¼ˆ5ã¤ã®ãƒ«ãƒ¼ãƒ«é †æ¬¡é©ç”¨ï¼‰
// ========================================
function applyAdjustmentRules(horses) {
  let adjusted = [...horses];

  // ãƒ«ãƒ¼ãƒ«â‘ ï¼šæœ¬å‘½ptãŒ 89 <= pt <= 90 ã®å ´åˆ â†’ æœ¬å‘½æ ã®ã¿çµ¶å¯¾è»¸å›ºå®š
  const honmei = adjusted.find(h => h.role === 'æœ¬å‘½');
  const isHonmeiFixed = honmei && honmei.pt >= 89 && honmei.pt <= 90;

  // ãƒ«ãƒ¼ãƒ«â‘¡ï¼šæœ¬å‘½ã¨å¯¾æŠ—ã®ptå·®ãŒ3ptä»¥å†… â†’ å…¥ã‚Œæ›¿ãˆï¼ˆæœ¬å‘½å›ºå®šæ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
  if (!isHonmeiFixed) {
    const taikou = adjusted.find(h => h.role === 'å¯¾æŠ—');
    if (honmei && taikou && (honmei.pt - taikou.pt <= 3)) {
      // ptå·®ãŒ3ptä»¥å†…ã®å ´åˆã€é¦¬ç•ªæ˜‡é †ã§å„ªå…ˆï¼ˆå°ã•ã„æ–¹ãŒä¸Šä½ï¼‰
      if (taikou.horseNumber < honmei.horseNumber) {
        honmei.role = 'å¯¾æŠ—';
        taikou.role = 'æœ¬å‘½';
      }
    }
  }

  // ãƒ«ãƒ¼ãƒ«â‘¢ï¼šæœ¬å‘½ptãŒ86ptä»¥ä¸‹ â†’ å¯¾æŠ—ã‚’æœ¬å‘½ã«æ˜‡æ ¼ã€å˜ç©´æœ€ä¸Šä½ã‚’å¯¾æŠ—ã«æ˜‡æ ¼ï¼ˆæœ¬å‘½å›ºå®šæ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
  if (!isHonmeiFixed) {
    const currentHonmei = adjusted.find(h => h.role === 'æœ¬å‘½');
    if (currentHonmei && currentHonmei.pt <= 86) {
      const currentTaikou = adjusted.find(h => h.role === 'å¯¾æŠ—');
      const tananaList = adjusted.filter(h => h.role === 'å˜ç©´');

      if (currentTaikou && tananaList.length > 0) {
        // pté™é †ã§ã‚½ãƒ¼ãƒˆï¼ˆåŒç‚¹ãªã‚‰é¦¬ç•ªæ˜‡é †ï¼‰
        tananaList.sort((a, b) => {
          if (b.pt !== a.pt) return b.pt - a.pt;
          return a.horseNumber - b.horseNumber;
        });

        currentHonmei.role = 'å¯¾æŠ—';
        currentTaikou.role = 'æœ¬å‘½';
        tananaList[0].role = 'å¯¾æŠ—';
      }
    }
  }

  // ãƒ«ãƒ¼ãƒ«â‘£ï¼šå¯¾æŠ—ã¨å˜ç©´æœ€ä¸Šä½ã®ptå·®ãŒ3ptä»¥å†… â†’ æ˜‡æ ¼/é™æ ¼
  const currentTaikou = adjusted.find(h => h.role === 'å¯¾æŠ—');
  const tananaList = adjusted.filter(h => h.role === 'å˜ç©´');

  if (currentTaikou && tananaList.length > 0) {
    tananaList.sort((a, b) => {
      if (b.pt !== a.pt) return b.pt - a.pt;
      return a.horseNumber - b.horseNumber;
    });

    const topTanana = tananaList[0];
    if (currentTaikou.pt - topTanana.pt <= 3) {
      // é¦¬ç•ªæ˜‡é †ã§å„ªå…ˆ
      if (topTanana.horseNumber < currentTaikou.horseNumber) {
        currentTaikou.role = 'å˜ç©´';
        topTanana.role = 'å¯¾æŠ—';
      }
    }
  }

  // ãƒ«ãƒ¼ãƒ«â‘¤ï¼šå˜ç©´ä¸‹ä½ã¨é€£ä¸‹æœ€ä¸Šä½ã®ptå·®ãŒ2ptä»¥å†… â†’ å…¥ã‚Œæ›¿ãˆ
  const finalTananaList = adjusted.filter(h => h.role === 'å˜ç©´');
  const renkaList = adjusted.filter(h => h.role === 'é€£ä¸‹');

  if (finalTananaList.length === 2 && renkaList.length > 0) {
    finalTananaList.sort((a, b) => {
      if (b.pt !== a.pt) return b.pt - a.pt;
      return a.horseNumber - b.horseNumber;
    });

    renkaList.sort((a, b) => {
      if (b.pt !== a.pt) return b.pt - a.pt;
      return a.horseNumber - b.horseNumber;
    });

    const bottomTanana = finalTananaList[1];
    const topRenka = renkaList[0];

    if (bottomTanana.pt - topRenka.pt <= 2) {
      // é¦¬ç•ªæ˜‡é †ã§å„ªå…ˆ
      if (topRenka.horseNumber < bottomTanana.horseNumber) {
        bottomTanana.role = 'é€£ä¸‹';
        topRenka.role = 'å˜ç©´';
      }
    }
  }

  // æœ€çµ‚ã‚½ãƒ¼ãƒˆï¼ˆå½¹å‰²é † â†’ pté™é † â†’ é¦¬ç•ªæ˜‡é †ï¼‰
  const roleOrder = { 'æœ¬å‘½': 0, 'å¯¾æŠ—': 1, 'å˜ç©´': 2, 'é€£ä¸‹': 3, 'æŠ‘ãˆ': 4 };
  adjusted.sort((a, b) => {
    if (roleOrder[a.role] !== roleOrder[b.role]) return roleOrder[a.role] - roleOrder[b.role];
    if (b.pt !== a.pt) return b.pt - a.pt;
    return a.horseNumber - b.horseNumber;
  });

  return adjusted;
}

// ========================================
// ã€é–¢æ•°4ã€‘è²·ã„ç›®ç”Ÿæˆï¼ˆ2æ®µæ§‹æˆï¼‰
// ========================================
function generateBettingLines(horses) {
  const honmei = horses.find(h => h.role === 'æœ¬å‘½');
  const taikou = horses.find(h => h.role === 'å¯¾æŠ—');
  const tanana = horses.filter(h => h.role === 'å˜ç©´');
  const renka = horses.filter(h => h.role === 'é€£ä¸‹');
  const osae = horses.filter(h => h.role === 'æŠ‘ãˆ');

  if (!honmei) throw new Error('æœ¬å‘½ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
  if (!taikou) throw new Error('å¯¾æŠ—ãŒå­˜åœ¨ã—ã¾ã›ã‚“');

  // æŠ‘ãˆéƒ¨åˆ†ï¼ˆå…±é€šï¼‰
  const osaeStr = osae.length > 0 ? `(æŠ‘ãˆ${osae.map(h => h.horseNumber).join('.')})` : '';

  // ç¬¬1è¡Œ: æœ¬å‘½-å¯¾æŠ—.å˜ç©´.é€£ä¸‹(æŠ‘ãˆ...)
  const line1Horses = [taikou, ...tanana, ...renka].filter(Boolean);
  const line1 = `${honmei.horseNumber}-${line1Horses.map(h => h.horseNumber).join('.')}${osaeStr}`;

  // ç¬¬2è¡Œ: å¯¾æŠ—-æœ¬å‘½.å˜ç©´.é€£ä¸‹(æŠ‘ãˆ...)
  const line2Horses = [honmei, ...tanana, ...renka].filter(Boolean);
  const line2 = `${taikou.horseNumber}-${line2Horses.map(h => h.horseNumber).join('.')}${osaeStr}`;

  return [line1, line2];
}

// ========================================
// ã€é–¢æ•°5ã€‘JSONå‡ºåŠ›ï¼ˆäºˆæƒ³ãƒšãƒ¼ã‚¸ç”¨ï¼‰
// ========================================
function outputJSON(data) {
  const { raceDate, venue, raceNumber, horses, bettingLines } = data;

  const output = {
    raceInfo: {
      date: raceDate,
      venue: venue,
      raceNumber: parseInt(raceNumber, 10)
    },
    horses: horses.map(h => ({
      horseNumber: h.horseNumber,
      horseName: h.horseName,
      pt: h.pt,
      role: h.role
    })),
    bettingLines: {
      umatan: Array.isArray(bettingLines) ? bettingLines : [bettingLines]
    },
    generatedAt: new Date().toISOString()
  };

  return JSON.stringify(output, null, 2);
}
---

<!-- <AuthCheck /> ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ– -->

<BaseLayout
  title="äºˆæƒ³ç®¡ç†ç”»é¢"
  description="ç‰¹å¾´é‡ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦JSONäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã™"
>
  <section class="admin-section">
    <div class="container">
      <h1 class="page-title">äºˆæƒ³ç®¡ç†ç”»é¢ï¼ˆPrediction Converterï¼‰</h1>
      <p class="page-description">
        ãƒ¬ãƒ¼ã‚¹æƒ…å ±ã¨é¦¬ãƒ‡ãƒ¼ã‚¿ï¼ˆptå€¤ï¼‰ã‚’å…¥åŠ›ã—ã¦ã€äºˆæƒ³JSONã‚’ç”Ÿæˆã—ã¾ã™ã€‚<br>
        <strong>â€» ptå€¤ã¯å¤–éƒ¨ã§è¨ˆç®—æ¸ˆã¿ã®å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆã“ã®ãƒ„ãƒ¼ãƒ«ã§ã¯ptè¨ˆç®—ã‚’è¡Œã„ã¾ã›ã‚“ï¼‰</strong>
      </p>

      <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="card form-card">
        <h2>ãƒ¬ãƒ¼ã‚¹æƒ…å ±ãƒ»é¦¬ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>
        <form method="POST">
          <div class="form-group">
            <label for="raceDate">é–‹å‚¬æ—¥</label>
            <input
              type="date"
              id="raceDate"
              name="raceDate"
              required
              class="form-input"
            />
          </div>

          <div class="form-group">
            <label for="venue">ç«¶é¦¬å ´</label>
            <select id="venue" name="venue" required class="form-input">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="å¤§äº•">å¤§äº•</option>
              <option value="å·å´">å·å´</option>
              <option value="èˆ¹æ©‹">èˆ¹æ©‹</option>
              <option value="æµ¦å’Œ">æµ¦å’Œ</option>
            </select>
          </div>

          <div class="form-group">
            <label for="raceNumber">ãƒ¬ãƒ¼ã‚¹ç•ªå·</label>
            <input
              type="number"
              id="raceNumber"
              name="raceNumber"
              min="1"
              max="12"
              required
              class="form-input"
            />
          </div>

          <div class="form-group">
            <label for="horseData">é¦¬ãƒ‡ãƒ¼ã‚¿ï¼ˆ1è¡Œ1é ­ï¼šé¦¬ç•ª,é¦¬å,ptï¼‰</label>
            <textarea
              id="horseData"
              name="horseData"
              rows="12"
              required
              class="form-textarea"
              placeholder="ä¾‹:
1,ãƒã‚³ã‚¹ãƒšã‚·ãƒ£ãƒ«,90.5
2,ã‚¯ãƒ­ãƒãƒ£ãƒ³ãƒ—,86.2
3,ã‚±ã‚¤ãƒã‚¹ã‚¿ãƒ¼,82.0
4,ãƒŠãƒ³ã‚«ãƒ³ã‚­ãƒ³ã‚°,77.3
5,ã‚ªã‚ªã‚¤ãƒ—ãƒªãƒ³ã‚¹,70.0"
            ></textarea>
          </div>

          <button type="submit" class="btn btn-primary btn-lg w-full">
            äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
          </button>
        </form>
      </div>

      <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
      {errorMessage && (
        <div class="card error-card">
          <h3>ã‚¨ãƒ©ãƒ¼</h3>
          <p>{errorMessage}</p>
        </div>
      )}

      <!-- çµæœè¡¨ç¤º -->
      {result && (
        <div class="results-section">
          <div class="race-card card">
            <h2 class="section-title">ç”Ÿæˆçµæœ</h2>

            <!-- ptä¸€è¦§è¡¨ç¤º -->
            <div class="pt-summary">
              <h3>ğŸ“Š ptä¸€è¦§ï¼ˆåŒç‚¹é¦¬ç•ªæ˜‡é †ï¼‰</h3>
              <div class="pt-display">
                {result.horses.map((h, i) => (
                  <span class="pt-item">
                    {h.horseNumber}({h.pt}){i < result.horses.length - 1 ? ' / ' : ''}
                  </span>
                ))}
              </div>
              <button
                type="button"
                class="btn btn-secondary btn-sm mt-2"
                onclick={`navigator.clipboard.writeText('${result.horses.map(h => `${h.horseNumber}:${h.pt}`).join(' / ')}').then(() => alert('ptä¸€è¦§ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'))`}
              >
                ğŸ“‹ ptä¸€è¦§ã‚’ã‚³ãƒ”ãƒ¼
              </button>
            </div>

            <!-- è²·ã„ç›®è¡¨ç¤º -->
            <div class="betting-section">
              <h3>ğŸ¯ è²·ã„ç›®ï¼ˆé¦¬å˜ï¼‰2æ®µæ§‹æˆ</h3>
              <div class="betting-lines-container">
                {Array.isArray(result.bettingLines) ? (
                  result.bettingLines.map((line, index) => (
                    <div class="betting-line-item">
                      <span class="line-number">{index === 0 ? 'æœ¬å‘½è»¸' : 'å¯¾æŠ—è»¸'}</span>
                      <span class="betting-line">{line}</span>
                    </div>
                  ))
                ) : (
                  <div class="betting-line-item">
                    <span class="betting-line">{result.bettingLines}</span>
                  </div>
                )}
              </div>
            </div>

            <!-- å½¹å‰²åˆ¥é¦¬ä¸€è¦§ -->
            <div class="horses-prediction">
              <h3>ğŸ‡ å½¹å‰²åˆ¥é¦¬ä¸€è¦§</h3>

              <!-- æœ¬å‘½ãƒ»å¯¾æŠ—ãƒ»å˜ç©´ -->
              <div class="top-horses">
                {result.horses.filter(h => ['æœ¬å‘½', 'å¯¾æŠ—', 'å˜ç©´'].includes(h.role)).map((horse) => (
                  <div class={`horse-item ${horse.role === 'æœ¬å‘½' ? 'honmei' : horse.role === 'å¯¾æŠ—' ? 'taikou' : 'tanana'}`}>
                    <div class="horse-mark">
                      {horse.role === 'æœ¬å‘½' ? 'â—' : horse.role === 'å¯¾æŠ—' ? 'â—‹' : 'â–²'}
                    </div>
                    <div class="horse-info">
                      <div class="horse-header-line">
                        <span class="horse-number">{horse.horseNumber}</span>
                        <span class="horse-name">{horse.horseName}</span>
                        <span class="role-badge">{horse.role}</span>
                      </div>
                      <div class="horse-score">
                        ç´¯ç©ã‚¹ã‚³ã‚¢: <strong>{horse.pt}pt</strong>
                      </div>
                    </div>
                  </div>
                ))}
              </div>

              <!-- é€£ä¸‹å€™è£œé¦¬ -->
              {result.horses.filter(h => h.role === 'é€£ä¸‹').length > 0 && (
                <div class="horse-group renka">
                  <div class="group-header">â–³ é€£ä¸‹å€™è£œé¦¬</div>
                  <div class="group-list">
                    {result.horses.filter(h => h.role === 'é€£ä¸‹').map((horse, index, arr) => (
                      <span class="horse-compact">
                        <strong>{horse.horseNumber}</strong> {horse.horseName} <span class="pt-value">({horse.pt}pt)</span>{index < arr.length - 1 ? 'ã€' : ''}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              <!-- æŠ‘ãˆå€™è£œé¦¬ -->
              {result.horses.filter(h => h.role === 'æŠ‘ãˆ').length > 0 && (
                <div class="horse-group osae">
                  <div class="group-header">Ã— æŠ‘ãˆå€™è£œé¦¬</div>
                  <div class="group-list">
                    {result.horses.filter(h => h.role === 'æŠ‘ãˆ').map((horse, index, arr) => (
                      <span class="horse-compact">
                        <strong>{horse.horseNumber}</strong> {horse.horseName} <span class="pt-value">({horse.pt}pt)</span>{index < arr.length - 1 ? 'ã€' : ''}
                      </span>
                    ))}
                  </div>
                </div>
              )}
            </div>

            <!-- JSONå‡ºåŠ› -->
            <div class="json-output">
              <h3>JSONå‡ºåŠ›ï¼ˆäºˆæƒ³ãƒšãƒ¼ã‚¸ç”¨ï¼‰</h3>
              <textarea
                readonly
                rows="20"
                class="json-textarea"
              >{result.json}</textarea>
              <button
                type="button"
                class="btn btn-secondary mt-2"
                onclick="navigator.clipboard.writeText(this.previousElementSibling.value).then(() => alert('JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'))"
              >
                JSONã‚’ã‚³ãƒ”ãƒ¼
              </button>
            </div>
          </div>
        </div>
      )}

      <!-- ä½¿ç”¨æ–¹æ³• -->
      <div class="card info-card">
        <h2>ä½¿ç”¨æ–¹æ³•</h2>
        <ol>
          <li><strong>ptå€¤ã®æº–å‚™:</strong> å¤–éƒ¨ãƒ„ãƒ¼ãƒ«ã§ptå€¤ã‚’è¨ˆç®—ã—ã¦ãã ã•ã„</li>
          <li><strong>ãƒ‡ãƒ¼ã‚¿å…¥åŠ›:</strong> ãƒ¬ãƒ¼ã‚¹æƒ…å ±ã¨é¦¬ãƒ‡ãƒ¼ã‚¿ï¼ˆé¦¬ç•ª,é¦¬å,ptï¼‰ã‚’å…¥åŠ›</li>
          <li><strong>ç”Ÿæˆå®Ÿè¡Œ:</strong> ã€Œäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
          <li><strong>JSONä¿å­˜:</strong> ç”Ÿæˆã•ã‚ŒãŸJSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜</li>
          <li><strong>Gitç®¡ç†:</strong> å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤</li>
        </ol>

        <h3>å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯æ¦‚è¦</h3>
        <ul>
          <li><strong>åˆæœŸå‰²å½“:</strong> pté™é †ã§æœ¬å‘½/å¯¾æŠ—/å˜ç©´/é€£ä¸‹/æŠ‘ãˆã‚’ä»®å‰²å½“</li>
          <li><strong>èª¿æ•´ãƒ«ãƒ¼ãƒ«â‘ :</strong> æœ¬å‘½ptãŒ89ã€œ90pt â†’ æœ¬å‘½æ ã®ã¿çµ¶å¯¾è»¸å›ºå®š</li>
          <li><strong>èª¿æ•´ãƒ«ãƒ¼ãƒ«â‘¡:</strong> æœ¬å‘½ã¨å¯¾æŠ—ã®ptå·®ãŒ3ptä»¥å†… â†’ å…¥ã‚Œæ›¿ãˆåˆ¤å®š</li>
          <li><strong>èª¿æ•´ãƒ«ãƒ¼ãƒ«â‘¢:</strong> æœ¬å‘½ptãŒ86ptä»¥ä¸‹ â†’ å¯¾æŠ—ã‚’æœ¬å‘½ã«æ˜‡æ ¼</li>
          <li><strong>èª¿æ•´ãƒ«ãƒ¼ãƒ«â‘£:</strong> å¯¾æŠ—ã¨å˜ç©´æœ€ä¸Šä½ã®ptå·®ãŒ3ptä»¥å†… â†’ å…¥ã‚Œæ›¿ãˆåˆ¤å®š</li>
          <li><strong>èª¿æ•´ãƒ«ãƒ¼ãƒ«â‘¤:</strong> å˜ç©´ä¸‹ä½ã¨é€£ä¸‹æœ€ä¸Šä½ã®ptå·®ãŒ2ptä»¥å†… â†’ å…¥ã‚Œæ›¿ãˆåˆ¤å®š</li>
          <li><strong>åŒç‚¹ãƒ«ãƒ¼ãƒ«:</strong> å…¨ã¦ã®æ¯”è¼ƒãƒ»ã‚½ãƒ¼ãƒˆã§é¦¬ç•ªæ˜‡é †ã‚’æ¡ç”¨</li>
        </ul>
      </div>
    </div>
  </section>

  <style>
    .admin-section {
      padding: var(--spacing-2xl) 0;
      min-height: 100vh;
    }

    .page-title {
      font-size: 2rem;
      margin-bottom: var(--spacing-md);
      text-align: center;
    }

    .page-description {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-2xl);
    }

    .form-card {
      max-width: 800px;
      margin: 0 auto var(--spacing-xl);
    }

    .form-group {
      margin-bottom: var(--spacing-lg);
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
    }

    .form-input,
    .form-textarea {
      width: 100%;
      padding: var(--spacing-sm);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: inherit;
    }

    .form-textarea {
      font-family: 'Courier New', monospace;
      resize: vertical;
    }

    .error-card {
      max-width: 800px;
      margin: 0 auto var(--spacing-xl);
      border: 2px solid var(--error);
      background: rgba(239, 68, 68, 0.1);
    }

    .error-card h3 {
      color: var(--error);
      margin-bottom: var(--spacing-sm);
    }

    /* çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .results-section {
      margin-top: var(--spacing-2xl);
    }

    .race-card {
      max-width: 1000px;
      margin: 0 auto;
      padding: var(--spacing-xl);
    }

    .section-title {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: var(--spacing-xl);
      padding-bottom: var(--spacing-md);
      border-bottom: 2px solid var(--border-color);
    }

    /* ptä¸€è¦§ */
    .pt-summary {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-2xl);
      border-left: 4px solid #8b5cf6;
    }

    .pt-summary h3 {
      font-size: 1.125rem;
      font-weight: 700;
      margin-bottom: var(--spacing-md);
      color: var(--text-primary);
    }

    .pt-display {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      padding: var(--spacing-md);
      background: var(--bg-card);
      border-radius: var(--radius-md);
      font-family: 'Courier New', monospace;
      overflow-x: auto;
      white-space: nowrap;
      line-height: 1.8;
    }

    .pt-item {
      color: var(--text-secondary);
    }

    .btn-sm {
      padding: var(--spacing-xs) var(--spacing-md);
      font-size: 0.875rem;
    }

    /* è²·ã„ç›®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .betting-section {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-2xl);
      border-left: 4px solid var(--primary-end);
    }

    .betting-section h3 {
      font-size: 1.125rem;
      font-weight: 700;
      margin-bottom: var(--spacing-md);
      color: var(--text-primary);
    }

    .betting-lines-container {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .betting-line-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-card);
      border-radius: var(--radius-md);
    }

    .line-number {
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--text-secondary);
      min-width: 4rem;
    }

    .betting-line {
      font-size: 1.25rem;
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-family: 'Courier New', monospace;
      flex: 1;
    }

    /* å½¹å‰²åˆ¥é¦¬ä¸€è¦§ */
    .horses-prediction {
      margin-bottom: var(--spacing-xl);
    }

    .horses-prediction h3 {
      font-size: 1.125rem;
      font-weight: 700;
      margin-bottom: var(--spacing-lg);
      color: var(--text-primary);
    }

    /* ä¸Šä½é¦¬ï¼ˆæœ¬å‘½ãƒ»å¯¾æŠ—ãƒ»å˜ç©´ï¼‰ */
    .top-horses {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    .horse-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border-left: 4px solid;
      transition: transform var(--transition-base);
    }

    .horse-item:hover {
      transform: translateX(4px);
    }

    .horse-item.honmei {
      border-left-color: #ef4444;
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, var(--bg-secondary) 100%);
    }

    .horse-item.taikou {
      border-left-color: #f59e0b;
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, var(--bg-secondary) 100%);
    }

    .horse-item.tanana {
      border-left-color: #3b82f6;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, var(--bg-secondary) 100%);
    }

    .horse-mark {
      font-size: 2rem;
      font-weight: 700;
      min-width: 2.5rem;
      text-align: center;
    }

    .horse-item.honmei .horse-mark { color: #ef4444; }
    .horse-item.taikou .horse-mark { color: #f59e0b; }
    .horse-item.tanana .horse-mark { color: #3b82f6; }

    .horse-info {
      flex: 1;
    }

    .horse-header-line {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-xs);
    }

    .horse-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      min-width: 2.5rem;
    }

    .horse-name {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      flex: 1;
    }

    .role-badge {
      font-size: 0.75rem;
      font-weight: 700;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }

    .horse-score {
      font-size: 0.875rem;
      color: var(--text-secondary);
      padding-left: 2.5rem;
    }

    .horse-score strong {
      color: var(--text-primary);
      font-weight: 700;
      font-size: 1rem;
    }

    /* é€£ä¸‹ãƒ»æŠ‘ãˆã‚°ãƒ«ãƒ¼ãƒ— */
    .horse-group {
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border-left: 4px solid;
    }

    .horse-group.renka {
      border-left-color: #6b7280;
    }

    .horse-group.osae {
      border-left-color: #9ca3af;
    }

    .group-header {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
    }

    .group-list {
      font-size: 0.9375rem;
      color: var(--text-secondary);
      line-height: 1.8;
    }

    .horse-compact {
      color: var(--text-secondary);
    }

    .horse-compact strong {
      color: var(--text-primary);
      font-size: 1.125rem;
    }

    .pt-value {
      color: var(--text-tertiary);
      font-size: 0.875rem;
    }

    .json-output {
      margin-top: var(--spacing-xl);
    }

    .json-textarea {
      width: 100%;
      padding: var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      resize: vertical;
    }

    .info-card {
      max-width: 1200px;
      margin: var(--spacing-xl) auto 0;
      background: var(--bg-secondary);
    }

    .info-card ol,
    .info-card ul {
      margin-left: var(--spacing-lg);
      color: var(--text-secondary);
    }

    .info-card li {
      margin-bottom: var(--spacing-sm);
    }

    .info-card h3 {
      margin-top: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
    }

    .w-full {
      width: 100%;
    }

    .mt-2 {
      margin-top: var(--spacing-md);
    }

    @media (max-width: 640px) {
      .page-title {
        font-size: 1.5rem;
      }

      .betting-display {
        font-size: 1.125rem;
      }
    }
  </style>
</BaseLayout>
