---
import BaseLayout from '../../layouts/BaseLayout.astro';
// import AuthCheck from '../../components/AuthCheck.astro'; // ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–

export const prerender = false;

let previewResults = null;
let generateResults = null;
let errors = [];
let action = null;

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    action = formData.get('action'); // 'preview' or 'generate'
    const raceDate = formData.get('raceDate');
    const venue = formData.get('venue');
    const allRacesData = formData.get('allRacesData');

    // ãƒ¬ãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§ãƒ‘ãƒ¼ã‚¹
    const racesData = parseAllRaces(allRacesData);

    if (action === 'preview') {
      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ‘ãƒ¼ã‚¹ã®ã¿å®Ÿè¡Œ
      previewResults = [];
      errors = [];

      for (const raceData of racesData) {
        try {
          const horses = parseInputData(raceData.horseData);
          previewResults.push({
            raceNumber: raceData.raceNumber,
            horseCount: horses.length,
            topHorse: horses[0] || null,
            secondHorse: horses[1] || null
          });
        } catch (error) {
          errors.push({
            raceNumber: raceData.raceNumber,
            message: error.message
          });
        }
      }
    } else if (action === 'generate') {
      // ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰ï¼šå…¨å‡¦ç†å®Ÿè¡Œ
      generateResults = [];
      errors = [];

      for (const raceData of racesData) {
        try {
          // ãƒ‡ãƒ¼ã‚¿è§£æ
          const horses = parseInputData(raceData.horseData);

          // åˆæœŸå½¹å‰²å‰²å½“
          const rolesAssigned = assignInitialRoles(horses);

          // å½¹å‰²èª¿æ•´ãƒ«ãƒ¼ãƒ«å®Ÿè¡Œ
          const rolesAdjusted = applyAdjustmentRules(rolesAssigned);

          // è²·ã„ç›®ç”Ÿæˆ
          const bettingLines = generateBettingLines(rolesAdjusted);

          // å€‹åˆ¥JSONç”Ÿæˆ
          const predictionJSON = outputJSON({
            raceDate,
            venue,
            raceNumber: raceData.raceNumber,
            horses: rolesAdjusted,
            bettingLines
          });

          generateResults.push({
            raceNumber: raceData.raceNumber,
            horses: rolesAdjusted,
            bettingLines,
            json: predictionJSON
          });
        } catch (error) {
          errors.push({
            raceNumber: raceData.raceNumber,
            message: error.message
          });
        }
      }

      // å…¨ãƒ¬ãƒ¼ã‚¹çµ±åˆJSONç”Ÿæˆï¼ˆæˆåŠŸåˆ†ã®ã¿ï¼‰
      if (generateResults.length > 0) {
        const allPredictionsJSON = outputAllRacesJSON({
          raceDate,
          venue,
          races: generateResults
        });
        generateResults.allPredictionsJSON = allPredictionsJSON;
      }
    }

  } catch (error) {
    errors.push({
      raceNumber: 'ALL',
      message: error.message
    });
  }
}

// ========================================
// ã€é–¢æ•°0ã€‘å…¨ãƒ¬ãƒ¼ã‚¹ãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆ===1R===åŒºåˆ‡ã‚Šï¼‰
// ========================================
function parseAllRaces(rawInput: string) {
  const races = [];
  const lines = rawInput.trim().split('\n');
  let currentRaceNumber = null;
  let currentRaceData = [];

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();

    // ãƒ¬ãƒ¼ã‚¹åŒºåˆ‡ã‚Šè¨˜å·ã‚’æ¤œå‡ºï¼ˆ===1R===, ===2R===, ...ï¼‰
    const raceMatch = line.match(/^===(\d+)R===/);
    if (raceMatch) {
      // å‰ã®ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
      if (currentRaceNumber !== null && currentRaceData.length > 0) {
        races.push({
          raceNumber: currentRaceNumber,
          horseData: currentRaceData.join('\n')
        });
      }

      // æ–°ã—ã„ãƒ¬ãƒ¼ã‚¹é–‹å§‹
      currentRaceNumber = parseInt(raceMatch[1], 10);
      currentRaceData = [];
      continue;
    }

    // ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿è¡Œã‚’è¿½åŠ 
    if (currentRaceNumber !== null && line) {
      currentRaceData.push(line);
    }
  }

  // æœ€å¾Œã®ãƒ¬ãƒ¼ã‚¹ã‚’ä¿å­˜
  if (currentRaceNumber !== null && currentRaceData.length > 0) {
    races.push({
      raceNumber: currentRaceNumber,
      horseData: currentRaceData.join('\n')
    });
  }

  return races;
}

// ========================================
// ã€é–¢æ•°1ã€‘ãƒ‡ãƒ¼ã‚¿è§£æï¼ˆå…¥åŠ›â†’ptæŠ½å‡ºï¼‰
// ========================================
function parseInputData(rawInput: string) {
  const lines = rawInput.trim().split('\n');
  const horses = [];
  let currentHorse = null;

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;

    // ãƒ‘ã‚¿ãƒ¼ãƒ³1: â— 5 ãƒãƒ†ã‚£ã‚¹ãƒˆã‚¥ãƒ¼ã‚¿ æœ¬å‘½
    // ãƒ‘ã‚¿ãƒ¼ãƒ³2: â—‹ 12 ãƒ•ã‚£ãƒªãƒ”ãƒ¼ãƒŒ å¯¾æŠ—
    // ãƒ‘ã‚¿ãƒ¼ãƒ³3: â–² 8 ã‚¢ã‚¤ãƒˆã‚«ã‚³ã‚¤ãƒˆã‚« å˜ç©´
    const roleMatch = line.match(/^[â—â—‹â–²â–³Ã—]\s+(\d+)\s+(.+?)\s+(?:æœ¬å‘½|å¯¾æŠ—|å˜ç©´)$/);
    if (roleMatch) {
      currentHorse = {
        horseNumber: parseInt(roleMatch[1], 10),
        horseName: roleMatch[2],
        pt: null
      };
      continue;
    }

    // ãƒ‘ã‚¿ãƒ¼ãƒ³4: ç´¯ç©ã‚¹ã‚³ã‚¢: 89pt
    const scoreMatch = line.match(/ç´¯ç©ã‚¹ã‚³ã‚¢[ï¼š:]\s*(\d+(?:\.\d+)?)pt/);
    if (scoreMatch && currentHorse) {
      currentHorse.pt = parseFloat(scoreMatch[1]);
      horses.push({ ...currentHorse });
      currentHorse = null;
      continue;
    }

    // ãƒ‘ã‚¿ãƒ¼ãƒ³5: 4 ãƒ­ãƒ¼ãƒ‰ã‚ªãƒ–ã‚­ãƒ³ã‚° (80pt) ï¼ˆé€£ä¸‹ãƒ»æŠ‘ãˆï¼‰
    const shortMatch = line.match(/^(\d+)\s+(.+?)\s+\((\d+(?:\.\d+)?)pt\)/);
    if (shortMatch) {
      horses.push({
        horseNumber: parseInt(shortMatch[1], 10),
        horseName: shortMatch[2],
        pt: parseFloat(shortMatch[3])
      });
      continue;
    }

    // ãƒ‘ã‚¿ãƒ¼ãƒ³6: 1,ãƒã‚³ã‚¹ãƒšã‚·ãƒ£ãƒ«,90.5 ï¼ˆã‚·ãƒ³ãƒ—ãƒ«å½¢å¼ãƒ»å¾Œæ–¹äº’æ›ï¼‰
    const simpleMatch = line.match(/^(\d+)[,\s]+(.+?)[,\s]+(\d+(?:\.\d+)?)$/);
    if (simpleMatch) {
      horses.push({
        horseNumber: parseInt(simpleMatch[1], 10),
        horseName: simpleMatch[2],
        pt: parseFloat(simpleMatch[3])
      });
      continue;
    }
  }

  // pté™é †ã§ã‚½ãƒ¼ãƒˆï¼ˆåŒç‚¹ã®å ´åˆã¯é¦¬ç•ªæ˜‡é †ï¼‰
  horses.sort((a, b) => {
    if (b.pt !== a.pt) return b.pt - a.pt;
    return a.horseNumber - b.horseNumber;
  });

  return horses;
}

// ========================================
// ã€é–¢æ•°2ã€‘åˆæœŸå½¹å‰²å‰²å½“ï¼ˆpté™é †ä»®å‰²å½“ï¼‰
// ========================================
function assignInitialRoles(horses) {
  if (horses.length < 4) {
    throw new Error('æœ€ä½4é ­å¿…è¦ã§ã™ï¼ˆæœ¬å‘½1/å¯¾æŠ—1/å˜ç©´2ï¼‰');
  }

  // pté™é †ã§ã‚½ãƒ¼ãƒˆæ¸ˆã¿ã®ãŸã‚ã€ä¸Šã‹ã‚‰é †ã«ä»®å‰²å½“
  // æœ¬å‘½/å¯¾æŠ—/å˜ç©´2é ­ã‚’ç¢ºå®šå¾Œã€æ®‹ã‚Šé¦¬ã‚’é€£ä¸‹/æŠ‘ãˆã«æŒ¯ã‚Šåˆ†ã‘

  // æ®‹ã‚Šé¦¬ï¼ˆæœ¬å‘½/å¯¾æŠ—/å˜ç©´ã‚’é™¤ãï¼‰ã‚’å–å¾—
  const remaining = horses.slice(4);

  // æ®‹ã‚Šé¦¬ãŒãªã„å ´åˆã¯æœ¬å‘½/å¯¾æŠ—/å˜ç©´ã®ã¿
  if (remaining.length === 0) {
    return horses.map((horse, index) => {
      let role = '';
      if (index === 0) role = 'æœ¬å‘½';
      else if (index === 1) role = 'å¯¾æŠ—';
      else if (index === 2 || index === 3) role = 'å˜ç©´';
      return { ...horse, role };
    });
  }

  // æ®‹ã‚Šé¦¬ã®æœ€å°ptã‚’å–å¾—ï¼ˆæŠ‘ãˆ = minPtåŒç‚¹ã‚¯ãƒ©ã‚¹ï¼‰
  const minPt = Math.min(...remaining.map(h => h.pt));

  // pt == minPt ã®é¦¬ã‚’æŠ‘ãˆã€ãã‚Œä»¥å¤–ã‚’é€£ä¸‹
  return horses.map((horse, index) => {
    let role = '';
    if (index === 0) role = 'æœ¬å‘½';
    else if (index === 1) role = 'å¯¾æŠ—';
    else if (index === 2 || index === 3) role = 'å˜ç©´';
    else if (horse.pt === minPt) role = 'æŠ‘ãˆ';
    else role = 'é€£ä¸‹';

    return { ...horse, role };
  });
}

// ========================================
// ã€é–¢æ•°3ã€‘å½¹å‰²èª¿æ•´ãƒ«ãƒ¼ãƒ«ï¼ˆ5ã¤ã®ãƒ«ãƒ¼ãƒ«é †æ¬¡é©ç”¨ï¼‰
// ========================================
function applyAdjustmentRules(horses) {
  let adjusted = [...horses];

  // ãƒ«ãƒ¼ãƒ«â‘ ï¼šæœ¬å‘½ptãŒ 89 <= pt <= 90 ã®å ´åˆ â†’ æœ¬å‘½æ ã®ã¿çµ¶å¯¾è»¸å›ºå®š
  const honmei = adjusted.find(h => h.role === 'æœ¬å‘½');
  const isHonmeiFixed = honmei && honmei.pt >= 89 && honmei.pt <= 90;

  // ãƒ«ãƒ¼ãƒ«â‘¡ï¼šæœ¬å‘½ã¨å¯¾æŠ—ã®ptå·®ãŒ3ptä»¥å†… â†’ å…¥ã‚Œæ›¿ãˆï¼ˆæœ¬å‘½å›ºå®šæ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
  if (!isHonmeiFixed) {
    const taikou = adjusted.find(h => h.role === 'å¯¾æŠ—');
    if (honmei && taikou && (honmei.pt - taikou.pt <= 3)) {
      // ptå·®ãŒ3ptä»¥å†…ã®å ´åˆã€é¦¬ç•ªæ˜‡é †ã§å„ªå…ˆï¼ˆå°ã•ã„æ–¹ãŒä¸Šä½ï¼‰
      if (taikou.horseNumber < honmei.horseNumber) {
        honmei.role = 'å¯¾æŠ—';
        taikou.role = 'æœ¬å‘½';
      }
    }
  }

  // ãƒ«ãƒ¼ãƒ«â‘¢ï¼šæœ¬å‘½ptãŒ86ptä»¥ä¸‹ â†’ å¯¾æŠ—ã‚’æœ¬å‘½ã«æ˜‡æ ¼ã€å˜ç©´æœ€ä¸Šä½ã‚’å¯¾æŠ—ã«æ˜‡æ ¼ï¼ˆæœ¬å‘½å›ºå®šæ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
  if (!isHonmeiFixed) {
    const currentHonmei = adjusted.find(h => h.role === 'æœ¬å‘½');
    if (currentHonmei && currentHonmei.pt <= 86) {
      const currentTaikou = adjusted.find(h => h.role === 'å¯¾æŠ—');
      const tananaList = adjusted.filter(h => h.role === 'å˜ç©´');

      if (currentTaikou && tananaList.length > 0) {
        // pté™é †ã§ã‚½ãƒ¼ãƒˆï¼ˆåŒç‚¹ãªã‚‰é¦¬ç•ªæ˜‡é †ï¼‰
        tananaList.sort((a, b) => {
          if (b.pt !== a.pt) return b.pt - a.pt;
          return a.horseNumber - b.horseNumber;
        });

        currentHonmei.role = 'å¯¾æŠ—';
        currentTaikou.role = 'æœ¬å‘½';
        tananaList[0].role = 'å¯¾æŠ—';
      }
    }
  }

  // ãƒ«ãƒ¼ãƒ«â‘£ï¼šå¯¾æŠ—ã¨å˜ç©´æœ€ä¸Šä½ã®ptå·®ãŒ3ptä»¥å†… â†’ æ˜‡æ ¼/é™æ ¼
  const currentTaikou = adjusted.find(h => h.role === 'å¯¾æŠ—');
  const tananaList = adjusted.filter(h => h.role === 'å˜ç©´');

  if (currentTaikou && tananaList.length > 0) {
    tananaList.sort((a, b) => {
      if (b.pt !== a.pt) return b.pt - a.pt;
      return a.horseNumber - b.horseNumber;
    });

    const topTanana = tananaList[0];
    if (currentTaikou.pt - topTanana.pt <= 3) {
      // é¦¬ç•ªæ˜‡é †ã§å„ªå…ˆ
      if (topTanana.horseNumber < currentTaikou.horseNumber) {
        currentTaikou.role = 'å˜ç©´';
        topTanana.role = 'å¯¾æŠ—';
      }
    }
  }

  // ãƒ«ãƒ¼ãƒ«â‘¤ï¼šå˜ç©´ä¸‹ä½ã¨é€£ä¸‹æœ€ä¸Šä½ã®ptå·®ãŒ2ptä»¥å†… â†’ å…¥ã‚Œæ›¿ãˆ
  const finalTananaList = adjusted.filter(h => h.role === 'å˜ç©´');
  const renkaList = adjusted.filter(h => h.role === 'é€£ä¸‹');

  if (finalTananaList.length === 2 && renkaList.length > 0) {
    finalTananaList.sort((a, b) => {
      if (b.pt !== a.pt) return b.pt - a.pt;
      return a.horseNumber - b.horseNumber;
    });

    renkaList.sort((a, b) => {
      if (b.pt !== a.pt) return b.pt - a.pt;
      return a.horseNumber - b.horseNumber;
    });

    const bottomTanana = finalTananaList[1];
    const topRenka = renkaList[0];

    if (bottomTanana.pt - topRenka.pt <= 2) {
      // é¦¬ç•ªæ˜‡é †ã§å„ªå…ˆ
      if (topRenka.horseNumber < bottomTanana.horseNumber) {
        bottomTanana.role = 'é€£ä¸‹';
        topRenka.role = 'å˜ç©´';
      }
    }
  }

  // æœ€çµ‚ã‚½ãƒ¼ãƒˆï¼ˆå½¹å‰²é † â†’ pté™é † â†’ é¦¬ç•ªæ˜‡é †ï¼‰
  const roleOrder = { 'æœ¬å‘½': 0, 'å¯¾æŠ—': 1, 'å˜ç©´': 2, 'é€£ä¸‹': 3, 'æŠ‘ãˆ': 4 };
  adjusted.sort((a, b) => {
    if (roleOrder[a.role] !== roleOrder[b.role]) return roleOrder[a.role] - roleOrder[b.role];
    if (b.pt !== a.pt) return b.pt - a.pt;
    return a.horseNumber - b.horseNumber;
  });

  return adjusted;
}

// ========================================
// ã€é–¢æ•°4ã€‘è²·ã„ç›®ç”Ÿæˆï¼ˆ2æ®µæ§‹æˆï¼‰
// ========================================
function generateBettingLines(horses) {
  const honmei = horses.find(h => h.role === 'æœ¬å‘½');
  const taikou = horses.find(h => h.role === 'å¯¾æŠ—');
  const tanana = horses.filter(h => h.role === 'å˜ç©´');
  const renka = horses.filter(h => h.role === 'é€£ä¸‹');
  const osae = horses.filter(h => h.role === 'æŠ‘ãˆ');

  if (!honmei) throw new Error('æœ¬å‘½ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
  if (!taikou) throw new Error('å¯¾æŠ—ãŒå­˜åœ¨ã—ã¾ã›ã‚“');

  // æŠ‘ãˆéƒ¨åˆ†ï¼ˆå…±é€šï¼‰
  const osaeStr = osae.length > 0 ? `(æŠ‘ãˆ${osae.map(h => h.horseNumber).join('.')})` : '';

  // ç¬¬1è¡Œ: æœ¬å‘½-å¯¾æŠ—.å˜ç©´.é€£ä¸‹(æŠ‘ãˆ...)
  const line1Horses = [taikou, ...tanana, ...renka].filter(Boolean);
  const line1 = `${honmei.horseNumber}-${line1Horses.map(h => h.horseNumber).join('.')}${osaeStr}`;

  // ç¬¬2è¡Œ: å¯¾æŠ—-æœ¬å‘½.å˜ç©´.é€£ä¸‹(æŠ‘ãˆ...)
  const line2Horses = [honmei, ...tanana, ...renka].filter(Boolean);
  const line2 = `${taikou.horseNumber}-${line2Horses.map(h => h.horseNumber).join('.')}${osaeStr}`;

  return [line1, line2];
}

// ========================================
// ã€é–¢æ•°5ã€‘å€‹åˆ¥ãƒ¬ãƒ¼ã‚¹JSONå‡ºåŠ›
// ========================================
function outputJSON(data) {
  const { raceDate, venue, raceNumber, horses, bettingLines } = data;

  const output = {
    raceInfo: {
      date: raceDate,
      venue: venue,
      raceNumber: parseInt(raceNumber, 10)
    },
    horses: horses.map(h => ({
      horseNumber: h.horseNumber,
      horseName: h.horseName,
      pt: h.pt,
      role: h.role
    })),
    bettingLines: {
      umatan: Array.isArray(bettingLines) ? bettingLines : [bettingLines]
    },
    generatedAt: new Date().toISOString()
  };

  return JSON.stringify(output, null, 2);
}

// ========================================
// ã€é–¢æ•°6ã€‘å…¨ãƒ¬ãƒ¼ã‚¹çµ±åˆJSONå‡ºåŠ›
// ========================================
function outputAllRacesJSON(data) {
  const { raceDate, venue, races } = data;

  const output = {
    eventInfo: {
      date: raceDate,
      venue: venue,
      totalRaces: races.length
    },
    predictions: races.map(race => {
      const raceData = JSON.parse(race.json);
      return raceData;
    }),
    generatedAt: new Date().toISOString()
  };

  return JSON.stringify(output, null, 2);
}
---

<!-- <AuthCheck /> ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ– -->

<BaseLayout
  title="äºˆæƒ³ç®¡ç†ç”»é¢ï¼ˆå…¨12ãƒ¬ãƒ¼ã‚¹ä¸€æ‹¬ç”Ÿæˆï¼‰"
  description="å…¨12ãƒ¬ãƒ¼ã‚¹ã®ç‰¹å¾´é‡ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬å…¥åŠ›ã—ã¦JSONäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã™"
>
  <section class="admin-section">
    <div class="container">
      <h1 class="page-title">äºˆæƒ³ç®¡ç†ç”»é¢ï¼ˆå…¨12ãƒ¬ãƒ¼ã‚¹ä¸€æ‹¬ç”Ÿæˆï¼‰</h1>
      <p class="page-description">
        é–‹å‚¬æ—¥ãƒ»ç«¶é¦¬å ´ã‚’æŒ‡å®šã—ã€å…¨12ãƒ¬ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬å…¥åŠ›ã—ã¦äºˆæƒ³JSONã‚’ç”Ÿæˆã—ã¾ã™ã€‚<br>
        <strong>â€» ptå€¤ã¯å¤–éƒ¨ã§è¨ˆç®—æ¸ˆã¿ã®å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</strong><br>
        <strong>â€» ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ¼ã‚¹ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã€æˆåŠŸåˆ†ã®ã¿å‡ºåŠ›ã•ã‚Œã¾ã™</strong>
      </p>

      <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="card form-card">
        <h2>é–‹å‚¬æƒ…å ±ãƒ»å…¨ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>
        <form method="POST">
          <div class="form-group">
            <label for="raceDate">é–‹å‚¬æ—¥</label>
            <input
              type="date"
              id="raceDate"
              name="raceDate"
              required
              class="form-input"
            />
          </div>

          <div class="form-group">
            <label for="venue">ç«¶é¦¬å ´</label>
            <select id="venue" name="venue" required class="form-input">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="å¤§äº•">å¤§äº•</option>
              <option value="å·å´">å·å´</option>
              <option value="èˆ¹æ©‹">èˆ¹æ©‹</option>
              <option value="æµ¦å’Œ">æµ¦å’Œ</option>
            </select>
          </div>

          <div class="form-group">
            <label for="allRacesData">å…¨12ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ï¼ˆ===1R===åŒºåˆ‡ã‚Šï¼‰</label>
            <textarea
              id="allRacesData"
              name="allRacesData"
              rows="30"
              required
              class="form-textarea"
              placeholder="ä¾‹:
===1R===
1,ãƒã‚³ã‚¹ãƒšã‚·ãƒ£ãƒ«,90.5
2,ã‚¯ãƒ­ãƒãƒ£ãƒ³ãƒ—,86.2
3,ã‚±ã‚¤ãƒã‚¹ã‚¿ãƒ¼,82.0
4,ãƒŠãƒ³ã‚«ãƒ³ã‚­ãƒ³ã‚°,77.3

===2R===
1,ã‚ªã‚ªã‚¤ãƒ—ãƒªãƒ³ã‚¹,88.0
2,ã‚«ãƒ¯ã‚µã‚­ãƒ›ãƒ¼ãƒ—,84.5
...

===12R===
..."
            ></textarea>
          </div>

          <div class="button-group">
            <button type="submit" name="action" value="preview" class="btn btn-secondary btn-lg">
              ğŸ“Š ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆç¢ºèªã®ã¿ï¼‰
            </button>
            <button type="submit" name="action" value="generate" class="btn btn-primary btn-lg">
              ğŸš€ å…¨ãƒ¬ãƒ¼ã‚¹ç”Ÿæˆ
            </button>
          </div>
        </form>
      </div>

      <!-- ã‚¨ãƒ©ãƒ¼ä¸€è¦§ -->
      {errors.length > 0 && (
        <div class="card error-card">
          <h3>âš ï¸ ã‚¨ãƒ©ãƒ¼ä¸€è¦§ï¼ˆ{errors.length}ä»¶ï¼‰</h3>
          <ul class="error-list">
            {errors.map(err => (
              <li>
                <strong>{err.raceNumber === 'ALL' ? 'å…¨ä½“ã‚¨ãƒ©ãƒ¼' : `${err.raceNumber}R`}:</strong> {err.message}
              </li>
            ))}
          </ul>
        </div>
      )}

      <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ -->
      {previewResults && (
        <div class="card preview-card">
          <h2>ğŸ“Š ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœï¼ˆ{previewResults.length}ãƒ¬ãƒ¼ã‚¹ï¼‰</h2>
          <div class="preview-grid">
            {previewResults.map(race => (
              <div class="preview-item">
                <div class="preview-header">{race.raceNumber}R</div>
                <div class="preview-body">
                  <div class="preview-stat">é ­æ•°: <strong>{race.horseCount}é ­</strong></div>
                  {race.topHorse && (
                    <div class="preview-stat">æœ¬å‘½å€™è£œ: <strong>{race.topHorse.horseNumber}.{race.topHorse.horseName} ({race.topHorse.pt}pt)</strong></div>
                  )}
                  {race.secondHorse && (
                    <div class="preview-stat">å¯¾æŠ—å€™è£œ: <strong>{race.secondHorse.horseNumber}.{race.secondHorse.horseName} ({race.secondHorse.pt}pt)</strong></div>
                  )}
                </div>
              </div>
            ))}
          </div>
          <p class="preview-note">
            âœ… å•é¡Œãªã‘ã‚Œã°ã€Œå…¨ãƒ¬ãƒ¼ã‚¹ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æœ¬ç•ªç”Ÿæˆã—ã¦ãã ã•ã„
          </p>
        </div>
      )}

      <!-- ç”Ÿæˆçµæœ -->
      {generateResults && generateResults.length > 0 && (
        <div class="results-section">
          <div class="card success-card">
            <h2>âœ… ç”ŸæˆæˆåŠŸï¼ˆ{generateResults.length}ãƒ¬ãƒ¼ã‚¹ï¼‰</h2>
          </div>

          <!-- å…¨ãƒ¬ãƒ¼ã‚¹çµ±åˆJSON -->
          <div class="card all-json-card">
            <h2>ğŸ“¦ å…¨ãƒ¬ãƒ¼ã‚¹çµ±åˆJSONï¼ˆ{generateResults.length}ãƒ¬ãƒ¼ã‚¹åˆ†ï¼‰</h2>
            <textarea
              readonly
              rows="15"
              class="json-textarea"
              id="allPredictionsJSON"
            >{generateResults.allPredictionsJSON}</textarea>
            <button
              type="button"
              class="btn btn-primary mt-2"
              onclick="navigator.clipboard.writeText(document.getElementById('allPredictionsJSON').value).then(() => alert('å…¨ãƒ¬ãƒ¼ã‚¹çµ±åˆJSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'))"
            >
              ğŸ“‹ å…¨ãƒ¬ãƒ¼ã‚¹çµ±åˆJSONã‚’ã‚³ãƒ”ãƒ¼
            </button>
          </div>

          <!-- å„ãƒ¬ãƒ¼ã‚¹è©³ç´°ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
          {generateResults.map((race, index) => (
            <details class="race-details" open={index === 0}>
              <summary class="race-summary">{race.raceNumber}R - æœ¬å‘½: {race.horses.find(h => h.role === 'æœ¬å‘½')?.horseNumber}.{race.horses.find(h => h.role === 'æœ¬å‘½')?.horseName} / å¯¾æŠ—: {race.horses.find(h => h.role === 'å¯¾æŠ—')?.horseNumber}.{race.horses.find(h => h.role === 'å¯¾æŠ—')?.horseName}</summary>

              <div class="race-card">
                <!-- ptä¸€è¦§è¡¨ç¤º -->
                <div class="pt-summary">
                  <h3>ğŸ“Š ptä¸€è¦§ï¼ˆåŒç‚¹é¦¬ç•ªæ˜‡é †ï¼‰</h3>
                  <div class="pt-display">
                    {race.horses.map((h, i) => (
                      <span class="pt-item">
                        {h.horseNumber}({h.pt}){i < race.horses.length - 1 ? ' / ' : ''}
                      </span>
                    ))}
                  </div>
                </div>

                <!-- è²·ã„ç›®è¡¨ç¤º -->
                <div class="betting-section">
                  <h3>ğŸ¯ è²·ã„ç›®ï¼ˆé¦¬å˜ï¼‰2æ®µæ§‹æˆ</h3>
                  <div class="betting-lines-container">
                    {Array.isArray(race.bettingLines) ? (
                      race.bettingLines.map((line, idx) => (
                        <div class="betting-line-item">
                          <span class="line-number">{idx === 0 ? 'æœ¬å‘½è»¸' : 'å¯¾æŠ—è»¸'}</span>
                          <span class="betting-line">{line}</span>
                        </div>
                      ))
                    ) : (
                      <div class="betting-line-item">
                        <span class="betting-line">{race.bettingLines}</span>
                      </div>
                    )}
                  </div>
                </div>

                <!-- å½¹å‰²åˆ¥é¦¬ä¸€è¦§ -->
                <div class="horses-prediction">
                  <h3>ğŸ‡ å½¹å‰²åˆ¥é¦¬ä¸€è¦§</h3>

                  <!-- æœ¬å‘½ãƒ»å¯¾æŠ—ãƒ»å˜ç©´ -->
                  <div class="top-horses">
                    {race.horses.filter(h => ['æœ¬å‘½', 'å¯¾æŠ—', 'å˜ç©´'].includes(h.role)).map((horse) => (
                      <div class={`horse-item ${horse.role === 'æœ¬å‘½' ? 'honmei' : horse.role === 'å¯¾æŠ—' ? 'taikou' : 'tanana'}`}>
                        <div class="horse-mark">
                          {horse.role === 'æœ¬å‘½' ? 'â—' : horse.role === 'å¯¾æŠ—' ? 'â—‹' : 'â–²'}
                        </div>
                        <div class="horse-info">
                          <div class="horse-header-line">
                            <span class="horse-number">{horse.horseNumber}</span>
                            <span class="horse-name">{horse.horseName}</span>
                            <span class="role-badge">{horse.role}</span>
                          </div>
                          <div class="horse-score">
                            ç´¯ç©ã‚¹ã‚³ã‚¢: <strong>{horse.pt}pt</strong>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>

                  <!-- é€£ä¸‹å€™è£œé¦¬ -->
                  {race.horses.filter(h => h.role === 'é€£ä¸‹').length > 0 && (
                    <div class="horse-group renka">
                      <div class="group-header">â–³ é€£ä¸‹å€™è£œé¦¬</div>
                      <div class="group-list">
                        {race.horses.filter(h => h.role === 'é€£ä¸‹').map((horse, idx, arr) => (
                          <span class="horse-compact">
                            <strong>{horse.horseNumber}</strong> {horse.horseName} <span class="pt-value">({horse.pt}pt)</span>{idx < arr.length - 1 ? 'ã€' : ''}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}

                  <!-- æŠ‘ãˆå€™è£œé¦¬ -->
                  {race.horses.filter(h => h.role === 'æŠ‘ãˆ').length > 0 && (
                    <div class="horse-group osae">
                      <div class="group-header">Ã— æŠ‘ãˆå€™è£œé¦¬</div>
                      <div class="group-list">
                        {race.horses.filter(h => h.role === 'æŠ‘ãˆ').map((horse, idx, arr) => (
                          <span class="horse-compact">
                            <strong>{horse.horseNumber}</strong> {horse.horseName} <span class="pt-value">({horse.pt}pt)</span>{idx < arr.length - 1 ? 'ã€' : ''}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}
                </div>

                <!-- å€‹åˆ¥JSONå‡ºåŠ› -->
                <div class="json-output">
                  <h3>å€‹åˆ¥JSONï¼ˆ{race.raceNumber}Rï¼‰</h3>
                  <textarea
                    readonly
                    rows="15"
                    class="json-textarea"
                    id={`json-${race.raceNumber}`}
                  >{race.json}</textarea>
                  <button
                    type="button"
                    class="btn btn-secondary mt-2"
                    onclick={`navigator.clipboard.writeText(document.getElementById('json-${race.raceNumber}').value).then(() => alert('${race.raceNumber}Rã®JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'))`}
                  >
                    ğŸ“‹ {race.raceNumber}R JSONã‚’ã‚³ãƒ”ãƒ¼
                  </button>
                </div>
              </div>
            </details>
          ))}
        </div>
      )}

      <!-- ä½¿ç”¨æ–¹æ³• -->
      <div class="card info-card">
        <h2>ä½¿ç”¨æ–¹æ³•</h2>
        <ol>
          <li><strong>ptå€¤ã®æº–å‚™:</strong> å¤–éƒ¨ãƒ„ãƒ¼ãƒ«ã§å…¨12ãƒ¬ãƒ¼ã‚¹åˆ†ã®ptå€¤ã‚’è¨ˆç®—</li>
          <li><strong>ãƒ‡ãƒ¼ã‚¿å…¥åŠ›:</strong> é–‹å‚¬æ—¥ãƒ»ç«¶é¦¬å ´ã‚’å…¥åŠ›å¾Œã€å…¨ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’===1R===åŒºåˆ‡ã‚Šã§å…¥åŠ›</li>
          <li><strong>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</strong> ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãƒœã‚¿ãƒ³ã§é ­æ•°ãƒ»æœ¬å‘½å€™è£œã‚’ç¢ºèªï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ¼ã‚¹ç¢ºèªï¼‰</li>
          <li><strong>ç”Ÿæˆå®Ÿè¡Œ:</strong> ã€Œå…¨ãƒ¬ãƒ¼ã‚¹ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã§æœ¬ç•ªç”Ÿæˆ</li>
          <li><strong>JSONä¿å­˜:</strong> å…¨ãƒ¬ãƒ¼ã‚¹çµ±åˆJSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¦äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜</li>
          <li><strong>Gitç®¡ç†:</strong> å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤</li>
        </ol>

        <h3>å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¾‹</h3>
        <pre class="format-example">===1R===
1,ãƒã‚³ã‚¹ãƒšã‚·ãƒ£ãƒ«,90.5
2,ã‚¯ãƒ­ãƒãƒ£ãƒ³ãƒ—,86.2
3,ã‚±ã‚¤ãƒã‚¹ã‚¿ãƒ¼,82.0
4,ãƒŠãƒ³ã‚«ãƒ³ã‚­ãƒ³ã‚°,77.3

===2R===
1,ã‚ªã‚ªã‚¤ãƒ—ãƒªãƒ³ã‚¹,88.0
2,ã‚«ãƒ¯ã‚µã‚­ãƒ›ãƒ¼ãƒ—,84.5
...

===12R===
...</pre>

        <h3>ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°</h3>
        <ul>
          <li>ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ¼ã‚¹ã¯è‡ªå‹•ã§ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã€æˆåŠŸåˆ†ã®ã¿å‡ºåŠ›ã•ã‚Œã¾ã™</li>
          <li>ã‚¨ãƒ©ãƒ¼è©³ç´°ã¯ãƒšãƒ¼ã‚¸ä¸Šéƒ¨ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆãƒ¬ãƒ¼ã‚¹ç•ªå·+ã‚¨ãƒ©ãƒ¼å†…å®¹ï¼‰</li>
          <li>æœ€ä½4é ­ï¼ˆæœ¬å‘½/å¯¾æŠ—/å˜ç©´2ï¼‰å¿…è¦ã§ã™</li>
        </ul>

        <h3>å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯æ¦‚è¦</h3>
        <ul>
          <li><strong>åˆæœŸå‰²å½“:</strong> pté™é †ã§æœ¬å‘½/å¯¾æŠ—/å˜ç©´/é€£ä¸‹/æŠ‘ãˆã‚’ä»®å‰²å½“</li>
          <li><strong>èª¿æ•´ãƒ«ãƒ¼ãƒ«â‘ :</strong> æœ¬å‘½ptãŒ89ã€œ90pt â†’ æœ¬å‘½æ ã®ã¿çµ¶å¯¾è»¸å›ºå®š</li>
          <li><strong>èª¿æ•´ãƒ«ãƒ¼ãƒ«â‘¡:</strong> æœ¬å‘½ã¨å¯¾æŠ—ã®ptå·®ãŒ3ptä»¥å†… â†’ å…¥ã‚Œæ›¿ãˆåˆ¤å®š</li>
          <li><strong>èª¿æ•´ãƒ«ãƒ¼ãƒ«â‘¢:</strong> æœ¬å‘½ptãŒ86ptä»¥ä¸‹ â†’ å¯¾æŠ—ã‚’æœ¬å‘½ã«æ˜‡æ ¼</li>
          <li><strong>èª¿æ•´ãƒ«ãƒ¼ãƒ«â‘£:</strong> å¯¾æŠ—ã¨å˜ç©´æœ€ä¸Šä½ã®ptå·®ãŒ3ptä»¥å†… â†’ å…¥ã‚Œæ›¿ãˆåˆ¤å®š</li>
          <li><strong>èª¿æ•´ãƒ«ãƒ¼ãƒ«â‘¤:</strong> å˜ç©´ä¸‹ä½ã¨é€£ä¸‹æœ€ä¸Šä½ã®ptå·®ãŒ2ptä»¥å†… â†’ å…¥ã‚Œæ›¿ãˆåˆ¤å®š</li>
          <li><strong>åŒç‚¹ãƒ«ãƒ¼ãƒ«:</strong> å…¨ã¦ã®æ¯”è¼ƒãƒ»ã‚½ãƒ¼ãƒˆã§é¦¬ç•ªæ˜‡é †ã‚’æ¡ç”¨</li>
        </ul>
      </div>
    </div>
  </section>

  <style>
    .admin-section {
      padding: var(--spacing-2xl) 0;
      min-height: 100vh;
    }

    .page-title {
      font-size: 2rem;
      margin-bottom: var(--spacing-md);
      text-align: center;
    }

    .page-description {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-2xl);
      line-height: 1.8;
    }

    .form-card {
      max-width: 1200px;
      margin: 0 auto var(--spacing-xl);
    }

    .form-group {
      margin-bottom: var(--spacing-lg);
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
    }

    .form-input,
    .form-textarea {
      width: 100%;
      padding: var(--spacing-sm);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: inherit;
    }

    .form-textarea {
      font-family: 'Courier New', monospace;
      resize: vertical;
    }

    .button-group {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-lg);
    }

    .button-group .btn {
      flex: 1;
    }

    /* ã‚¨ãƒ©ãƒ¼ã‚«ãƒ¼ãƒ‰ */
    .error-card {
      max-width: 1200px;
      margin: 0 auto var(--spacing-xl);
      border: 2px solid var(--error);
      background: rgba(239, 68, 68, 0.1);
    }

    .error-card h3 {
      color: var(--error);
      margin-bottom: var(--spacing-md);
    }

    .error-list {
      margin-left: var(--spacing-lg);
      color: var(--text-secondary);
    }

    .error-list li {
      margin-bottom: var(--spacing-sm);
    }

    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ */
    .preview-card {
      max-width: 1200px;
      margin: 0 auto var(--spacing-xl);
      border: 2px solid var(--primary-end);
      background: rgba(96, 165, 250, 0.1);
    }

    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    .preview-item {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border-left: 4px solid var(--primary-end);
      overflow: hidden;
    }

    .preview-header {
      background: var(--primary-gradient);
      color: white;
      font-weight: 700;
      font-size: 1.125rem;
      padding: var(--spacing-sm) var(--spacing-md);
      text-align: center;
    }

    .preview-body {
      padding: var(--spacing-md);
    }

    .preview-stat {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-xs);
    }

    .preview-stat strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    .preview-note {
      font-size: 0.9375rem;
      color: var(--text-secondary);
      text-align: center;
      padding: var(--spacing-md);
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
    }

    /* æˆåŠŸã‚«ãƒ¼ãƒ‰ */
    .success-card {
      max-width: 1200px;
      margin: 0 auto var(--spacing-xl);
      border: 2px solid #10b981;
      background: rgba(16, 185, 129, 0.1);
    }

    .success-card h2 {
      color: #10b981;
    }

    /* å…¨ãƒ¬ãƒ¼ã‚¹çµ±åˆJSONã‚«ãƒ¼ãƒ‰ */
    .all-json-card {
      max-width: 1200px;
      margin: 0 auto var(--spacing-xl);
      background: var(--bg-secondary);
      border-left: 4px solid #8b5cf6;
    }

    /* ãƒ¬ãƒ¼ã‚¹è©³ç´°ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ */
    .race-details {
      max-width: 1200px;
      margin: 0 auto var(--spacing-lg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      background: var(--bg-card);
      overflow: hidden;
    }

    .race-summary {
      padding: var(--spacing-md) var(--spacing-lg);
      background: var(--bg-secondary);
      cursor: pointer;
      font-weight: 700;
      font-size: 1.125rem;
      color: var(--text-primary);
      list-style: none;
      user-select: none;
      transition: background var(--transition-base);
    }

    .race-summary:hover {
      background: var(--bg-tertiary);
    }

    .race-summary::marker,
    .race-summary::-webkit-details-marker {
      display: none;
    }

    .race-summary::before {
      content: 'â–¶';
      display: inline-block;
      margin-right: var(--spacing-sm);
      transition: transform var(--transition-base);
    }

    .race-details[open] .race-summary::before {
      transform: rotate(90deg);
    }

    .race-card {
      padding: var(--spacing-xl);
    }

    /* çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .results-section {
      margin-top: var(--spacing-2xl);
    }

    /* ptä¸€è¦§ */
    .pt-summary {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-2xl);
      border-left: 4px solid #8b5cf6;
    }

    .pt-summary h3 {
      font-size: 1.125rem;
      font-weight: 700;
      margin-bottom: var(--spacing-md);
      color: var(--text-primary);
    }

    .pt-display {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      padding: var(--spacing-md);
      background: var(--bg-card);
      border-radius: var(--radius-md);
      font-family: 'Courier New', monospace;
      overflow-x: auto;
      white-space: nowrap;
      line-height: 1.8;
    }

    .pt-item {
      color: var(--text-secondary);
    }

    /* è²·ã„ç›®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .betting-section {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-2xl);
      border-left: 4px solid var(--primary-end);
    }

    .betting-section h3 {
      font-size: 1.125rem;
      font-weight: 700;
      margin-bottom: var(--spacing-md);
      color: var(--text-primary);
    }

    .betting-lines-container {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .betting-line-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-card);
      border-radius: var(--radius-md);
    }

    .line-number {
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--text-secondary);
      min-width: 4rem;
    }

    .betting-line {
      font-size: 1.25rem;
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-family: 'Courier New', monospace;
      flex: 1;
    }

    /* å½¹å‰²åˆ¥é¦¬ä¸€è¦§ */
    .horses-prediction {
      margin-bottom: var(--spacing-xl);
    }

    .horses-prediction h3 {
      font-size: 1.125rem;
      font-weight: 700;
      margin-bottom: var(--spacing-lg);
      color: var(--text-primary);
    }

    /* ä¸Šä½é¦¬ï¼ˆæœ¬å‘½ãƒ»å¯¾æŠ—ãƒ»å˜ç©´ï¼‰ */
    .top-horses {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    .horse-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border-left: 4px solid;
      transition: transform var(--transition-base);
    }

    .horse-item:hover {
      transform: translateX(4px);
    }

    .horse-item.honmei {
      border-left-color: #ef4444;
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, var(--bg-secondary) 100%);
    }

    .horse-item.taikou {
      border-left-color: #f59e0b;
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, var(--bg-secondary) 100%);
    }

    .horse-item.tanana {
      border-left-color: #3b82f6;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, var(--bg-secondary) 100%);
    }

    .horse-mark {
      font-size: 2rem;
      font-weight: 700;
      min-width: 2.5rem;
      text-align: center;
    }

    .horse-item.honmei .horse-mark { color: #ef4444; }
    .horse-item.taikou .horse-mark { color: #f59e0b; }
    .horse-item.tanana .horse-mark { color: #3b82f6; }

    .horse-info {
      flex: 1;
    }

    .horse-header-line {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-xs);
    }

    .horse-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      min-width: 2.5rem;
    }

    .horse-name {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      flex: 1;
    }

    .role-badge {
      font-size: 0.75rem;
      font-weight: 700;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }

    .horse-score {
      font-size: 0.875rem;
      color: var(--text-secondary);
      padding-left: 2.5rem;
    }

    .horse-score strong {
      color: var(--text-primary);
      font-weight: 700;
      font-size: 1rem;
    }

    /* é€£ä¸‹ãƒ»æŠ‘ãˆã‚°ãƒ«ãƒ¼ãƒ— */
    .horse-group {
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border-left: 4px solid;
    }

    .horse-group.renka {
      border-left-color: #6b7280;
    }

    .horse-group.osae {
      border-left-color: #9ca3af;
    }

    .group-header {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
    }

    .group-list {
      font-size: 0.9375rem;
      color: var(--text-secondary);
      line-height: 1.8;
    }

    .horse-compact {
      color: var(--text-secondary);
    }

    .horse-compact strong {
      color: var(--text-primary);
      font-size: 1.125rem;
    }

    .pt-value {
      color: var(--text-tertiary);
      font-size: 0.875rem;
    }

    /* JSONå‡ºåŠ› */
    .json-output {
      margin-top: var(--spacing-xl);
    }

    .json-textarea {
      width: 100%;
      padding: var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      resize: vertical;
    }

    /* ä½¿ç”¨æ–¹æ³•ã‚«ãƒ¼ãƒ‰ */
    .info-card {
      max-width: 1200px;
      margin: var(--spacing-xl) auto 0;
      background: var(--bg-secondary);
    }

    .info-card ol,
    .info-card ul {
      margin-left: var(--spacing-lg);
      color: var(--text-secondary);
    }

    .info-card li {
      margin-bottom: var(--spacing-sm);
    }

    .info-card h3 {
      margin-top: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
    }

    .format-example {
      background: var(--bg-tertiary);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      color: var(--text-secondary);
      border-left: 4px solid var(--primary-end);
    }

    .mt-2 {
      margin-top: var(--spacing-md);
    }

    @media (max-width: 640px) {
      .page-title {
        font-size: 1.5rem;
      }

      .button-group {
        flex-direction: column;
      }

      .preview-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</BaseLayout>
