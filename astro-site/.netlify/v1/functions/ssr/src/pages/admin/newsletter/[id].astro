---
import BaseLayout from '../../../layouts/BaseLayout.astro';

export const prerender = false;
---

<BaseLayout
  title="配信詳細"
  description="メルマガ配信詳細・送信">
  <section class="admin-newsletter-detail">
    <div class="container">
      <div class="header">
        <h1>配信詳細</h1>
        <a href="/admin/newsletter" class="btn btn-secondary">← 一覧に戻る</a>
      </div>

      <div id="detail-content" class="detail-content">
        <p>読み込み中...</p>
      </div>

      <div id="message" class="message"></div>
    </div>
  </section>

  <style>
    .admin-newsletter-detail {
      padding: var(--spacing-2xl) 0;
      min-height: calc(100vh - 200px);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-2xl);
    }

    .detail-content {
      max-width: 1000px;
      margin: 0 auto;
    }

    .detail-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: var(--spacing-sm) 0;
      border-bottom: 1px solid var(--border-color);
    }

    .detail-label {
      font-weight: 600;
      color: var(--text-secondary);
    }

    .detail-value {
      color: var(--text-primary);
    }

    .status-badge {
      display: inline-block;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
      font-weight: 600;
    }

    .status-draft {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }

    .status-dry-run {
      background: var(--warning);
      color: white;
    }

    .status-sent {
      background: var(--success);
      color: white;
    }

    .preview-card {
      background: white;
      color: #333;
      padding: var(--spacing-lg);
      border-radius: var(--radius-md);
      margin-top: var(--spacing-md);
    }

    .actions-card {
      display: flex;
      gap: var(--spacing-md);
      flex-wrap: wrap;
    }

    .warning-card {
      background: rgba(239, 68, 68, 0.1);
      border: 2px solid var(--danger);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-lg);
    }

    .warning-card h3 {
      color: var(--danger);
      margin-bottom: var(--spacing-sm);
    }

    .message {
      max-width: 1000px;
      margin: var(--spacing-md) auto 0;
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      display: none;
    }

    .message.success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid var(--success);
      color: var(--success);
      display: block;
    }

    .message.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--danger);
      color: var(--danger);
      display: block;
    }
  </style>

  <script>
    const broadcastId = window.location.pathname.split('/').pop();
    const messageEl = document.getElementById('message');
    const adminEmail = 'admin@keiba-intelligence.keiba.link'; // 仮：実際は認証から取得

    async function loadBroadcast() {
      try {
        const response = await fetch(`/.netlify/functions/get-broadcast?broadcast_id=${broadcastId}`);
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'エラーが発生しました');
        }

        const broadcast = data.broadcast;
        renderBroadcast(broadcast);
      } catch (error: any) {
        console.error('Error loading broadcast:', error);
        document.getElementById('detail-content')!.innerHTML = `<p>エラー: ${error.message}</p>`;
      }
    }

    function renderBroadcast(broadcast: any) {
      const isSent = broadcast.status === 'sent';
      const isDraft = broadcast.status === 'draft';
      const isDryRun = broadcast.status === 'dry-run';

      const html = `
        ${isSent ? `
          <div class="warning-card">
            <h3>⚠️ 送信済み・再送不可</h3>
            <p>この配信は既に送信済みです。再送信はできません。</p>
          </div>
        ` : ''}

        <div class="detail-card">
          <h2>配信情報</h2>
          <div class="detail-row">
            <span class="detail-label">配信ID</span>
            <span class="detail-value">${broadcast.broadcast_id}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">状態</span>
            <span class="detail-value">
              <span class="status-badge status-${broadcast.status}">
                ${broadcast.status === 'draft' ? '下書き' : broadcast.status === 'dry-run' ? 'Dry-Run' : '送信済み'}
              </span>
            </span>
          </div>
          <div class="detail-row">
            <span class="detail-label">件名</span>
            <span class="detail-value">${broadcast.subject}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">作成日時</span>
            <span class="detail-value">${new Date(broadcast.created_at).toLocaleString('ja-JP')}</span>
          </div>
          ${broadcast.sent_at ? `
          <div class="detail-row">
            <span class="detail-label">送信日時</span>
            <span class="detail-value">${new Date(broadcast.sent_at).toLocaleString('ja-JP')}</span>
          </div>
          ` : ''}
          <div class="detail-row">
            <span class="detail-label">送信件数</span>
            <span class="detail-value">${broadcast.recipient_count || '-'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">作成者</span>
            <span class="detail-value">${broadcast.created_by}</span>
          </div>
        </div>

        <div class="detail-card">
          <h2>本文プレビュー</h2>
          <div class="preview-card">${broadcast.body_html}</div>
        </div>

        <div class="detail-card">
          <h2>操作</h2>
          <div class="actions-card">
            <button id="test-btn" class="btn btn-secondary" ${isSent ? 'disabled' : ''}>テスト送信</button>
            <button id="dryrun-btn" class="btn btn-secondary" ${isSent ? 'disabled' : ''}>Dry-Run実行</button>
            <button id="send-btn" class="btn btn-primary" ${isSent ? 'disabled' : ''}>本番送信</button>
          </div>
        </div>
      `;

      document.getElementById('detail-content')!.innerHTML = html;

      // イベントリスナー設定
      if (!isSent) {
        document.getElementById('test-btn')?.addEventListener('click', () => handleTestSend(broadcast));
        document.getElementById('dryrun-btn')?.addEventListener('click', () => handleDryRun(broadcast));
        document.getElementById('send-btn')?.addEventListener('click', () => handleSend(broadcast));
      }
    }

    async function handleTestSend(broadcast: any) {
      const testEmail = prompt('テスト送信先メールアドレスを入力してください:', adminEmail);
      if (!testEmail) return;

      try {
        const response = await fetch('/.netlify/functions/send-test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            broadcast_id: broadcast.broadcast_id,
            test_email: testEmail,
          }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'エラーが発生しました');
        }

        if (messageEl) {
          messageEl.className = 'message success';
          messageEl.textContent = `テスト送信が完了しました: ${testEmail}`;
        }
      } catch (error: any) {
        console.error('Error sending test:', error);
        if (messageEl) {
          messageEl.className = 'message error';
          messageEl.textContent = `エラー: ${error.message}`;
        }
      }
    }

    async function handleDryRun(broadcast: any) {
      if (!confirm('Dry-Runを実行しますか？（送信件数のみ算出します）')) return;

      try {
        const response = await fetch('/.netlify/functions/send-broadcast', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            broadcast_id: broadcast.broadcast_id,
            dry_run: true,
            user_email: adminEmail,
          }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'エラーが発生しました');
        }

        if (messageEl) {
          messageEl.className = 'message success';
          messageEl.textContent = `Dry-Run完了: 送信予定件数 ${data.recipient_count}件`;
        }

        // リロード
        setTimeout(() => location.reload(), 2000);
      } catch (error: any) {
        console.error('Error dry-run:', error);
        if (messageEl) {
          messageEl.className = 'message error';
          messageEl.textContent = `エラー: ${error.message}`;
        }
      }
    }

    async function handleSend(broadcast: any) {
      // 最終確認ダイアログ
      const confirmed = confirm(
        `以下の内容で送信します。よろしいですか？\n\n` +
        `件名: ${broadcast.subject}\n\n` +
        `送信後は取り消しできません。`
      );

      if (!confirmed) return;

      // 二重確認
      const doubleConfirmed = confirm('本当に送信しますか？この操作は取り消せません。');
      if (!doubleConfirmed) return;

      try {
        const response = await fetch('/.netlify/functions/send-broadcast', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            broadcast_id: broadcast.broadcast_id,
            dry_run: false,
            confirm: true,
            user_email: adminEmail,
          }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || data.message || 'エラーが発生しました');
        }

        if (messageEl) {
          messageEl.className = 'message success';
          messageEl.textContent = `送信完了: ${data.sent_count}件送信、${data.failed_count}件失敗`;
        }

        // リロード
        setTimeout(() => location.reload(), 3000);
      } catch (error: any) {
        console.error('Error sending:', error);
        if (messageEl) {
          messageEl.className = 'message error';
          messageEl.textContent = `エラー: ${error.message}`;
        }
      }
    }

    loadBroadcast();
  </script>
</BaseLayout>
