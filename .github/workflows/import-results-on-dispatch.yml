name: Import Results (Dispatch)

on:
  repository_dispatch:
    types: [results-updated]
  workflow_dispatch:
    inputs:
      date:
        description: 'Êó•‰ªò (YYYY-MM-DD)'
        required: false
        default: ''

# ‰∏¶Ë°åÂÆüË°åÂà∂Âæ°ÔºöÂêå„Åò„É™„Éù„Ç∏„Éà„É™„ÅÆimport-results„ÅØ1„Å§„Åö„Å§ÂÆüË°å
concurrency:
  group: import-results-${{ github.ref }}
  cancel-in-progress: false  # ÂÆüË°å‰∏≠„ÅÆ„Ç∏„Éß„Éñ„Çí„Ç≠„É£„É≥„Çª„É´„Åõ„ÅöÂæÖÊ©ü

jobs:
  import-results:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for git push
    defaults:
      run:
        working-directory: astro-site

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'astro-site/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Import results from keiba-data-shared
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MANUAL_DATE: ${{ github.event.inputs.date }}
          DATES_JSON: ${{ toJSON(github.event.client_payload.dates) }}
          DATE_SINGLE: ${{ github.event.client_payload.date }}
        run: |
          # ÂÑ™ÂÖàÈ†Ü‰Ωç: ÊâãÂãïÂÖ•Âäõ > repository_dispatch payload > ‰ªäÊó•„ÅÆÊó•‰ªò
          if [ -n "$MANUAL_DATE" ]; then
            # ÊâãÂãïÂÆüË°åÊôÇ„ÅÆÂÖ•Âäõ
            echo "üìÖ Manual import for: $MANUAL_DATE"
            npm run import:results -- --date "$MANUAL_DATE"
          elif [ -n "$DATES_JSON" ] && [ "$DATES_JSON" != "null" ]; then
            # repository_dispatchÔºàË§áÊï∞Êó•‰ªòÔºâ
            echo "üìÖ Importing results for multiple dates"
            while IFS= read -r DATE; do
              echo "‚îÅ‚îÅ‚îÅ Processing: $DATE ‚îÅ‚îÅ‚îÅ"
              npm run import:results -- --date "$DATE"
            done < <(echo "$DATES_JSON" | jq -r '.[]')
          elif [ -n "$DATE_SINGLE" ] && [ "$DATE_SINGLE" != "null" ]; then
            # repository_dispatchÔºàÂçò‰∏ÄÊó•‰ªòÔºâ
            echo "üìÖ Importing results for single date: $DATE_SINGLE"
            npm run import:results -- --date "$DATE_SINGLE"
          else
            # „Éá„Éï„Ç©„É´„ÉàÔºö‰ªäÊó•„ÅÆÊó•‰ªòÔºàJSTÔºâ
            TODAY=$(TZ=Asia/Tokyo date +%Y-%m-%d)
            echo "üìÖ Importing for today (JST): $TODAY"
            npm run import:results -- --date "$TODAY"
          fi

      - name: Check for changes
        id: git-check
        run: |
          # archiveResults.json„ÅÆÂ§âÊõ¥„Çí„Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞
          git add src/data/archiveResults.json
          # „Çπ„ÉÜ„Éº„Ç∏„Åï„Çå„ÅüÂ§âÊõ¥„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
          git diff --staged --exit-code || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.git-check.outputs.changed == 'true'
        env:
          MANUAL_DATE: ${{ github.event.inputs.date }}
          DATES_JSON: ${{ toJSON(github.event.client_payload.dates) }}
          DATE_SINGLE: ${{ github.event.client_payload.date }}
          SOURCE: ${{ github.event.client_payload.source }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # „Ç≥„Éü„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏ÁîüÊàê
          if [ -n "$MANUAL_DATE" ]; then
            COMMIT_MSG="Auto-verify: ${MANUAL_DATE} results (manual)"
          elif [ -n "$DATES_JSON" ] && [ "$DATES_JSON" != "null" ]; then
            DATES=$(echo "$DATES_JSON" | jq -r 'join(", ")')
            COMMIT_MSG="Auto-verify: ${DATES} results from ${SOURCE}"
          elif [ -n "$DATE_SINGLE" ] && [ "$DATE_SINGLE" != "null" ]; then
            COMMIT_MSG="Auto-verify: ${DATE_SINGLE} results from ${SOURCE}"
          else
            TODAY=$(TZ=Asia/Tokyo date +%Y-%m-%d)
            COMMIT_MSG="Auto-verify: ${TODAY} results (today JST)"
          fi

          git commit -m "$COMMIT_MSG"

          # Retry logic: pull --rebase and push (ÊúÄÂ§ß5Âõû„É™„Éà„É©„Ç§)
          MAX_RETRIES=5
          RETRY_COUNT=0
          SUCCESS=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = false ]; do
            echo "üîÑ Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: Pulling latest changes..."

            # ÊúÄÊñ∞Áä∂ÊÖã„ÇíÂèñÂæóÔºàrebaseÔºâ
            if git pull --rebase origin main; then
              echo "‚úÖ Successfully pulled latest changes"

              # „Éó„ÉÉ„Ç∑„É•Ë©¶Ë°å
              if git push; then
                echo "‚úÖ Successfully pushed changes"
                SUCCESS=true
              else
                echo "‚ö†Ô∏è  Push failed, retrying..."
                RETRY_COUNT=$((RETRY_COUNT + 1))
                sleep $((RETRY_COUNT * 2))  # Exponential backoff
              fi
            else
              echo "‚ö†Ô∏è  Pull --rebase failed, retrying..."
              RETRY_COUNT=$((RETRY_COUNT + 1))
              sleep $((RETRY_COUNT * 2))
            fi
          done

          if [ "$SUCCESS" = false ]; then
            echo "‚ùå Failed to push after $MAX_RETRIES attempts"
            exit 1
          fi

      - name: Success notification
        if: steps.git-check.outputs.changed == 'true'
        env:
          MANUAL_DATE: ${{ github.event.inputs.date }}
          DATES_JSON: ${{ toJSON(github.event.client_payload.dates) }}
          DATE_SINGLE: ${{ github.event.client_payload.date }}
          SOURCE: ${{ github.event.client_payload.source }}
        run: |
          echo "‚úÖ Results verification completed and pushed"
          if [ -n "$MANUAL_DATE" ]; then
            echo "   Date: $MANUAL_DATE (manual)"
          elif [ -n "$DATES_JSON" ] && [ "$DATES_JSON" != "null" ]; then
            echo "   Dates: $(echo "$DATES_JSON" | jq -r 'join(", ")')"
            echo "   Source: $SOURCE"
          elif [ -n "$DATE_SINGLE" ] && [ "$DATE_SINGLE" != "null" ]; then
            echo "   Date: $DATE_SINGLE"
            echo "   Source: $SOURCE"
          else
            echo "   Date: $(TZ=Asia/Tokyo date +%Y-%m-%d) (today JST)"
          fi

      - name: No changes notification
        if: steps.git-check.outputs.changed != 'true'
        env:
          MANUAL_DATE: ${{ github.event.inputs.date }}
          DATES_JSON: ${{ toJSON(github.event.client_payload.dates) }}
          DATE_SINGLE: ${{ github.event.client_payload.date }}
        run: |
          echo "‚è≠Ô∏è  No changes detected (already up-to-date)"
          if [ -n "$MANUAL_DATE" ]; then
            echo "   Date: $MANUAL_DATE (manual)"
          elif [ -n "$DATES_JSON" ] && [ "$DATES_JSON" != "null" ]; then
            echo "   Dates: $(echo "$DATES_JSON" | jq -r 'join(", ")')"
          elif [ -n "$DATE_SINGLE" ] && [ "$DATE_SINGLE" != "null" ]; then
            echo "   Date: $DATE_SINGLE"
          else
            echo "   Date: $(TZ=Asia/Tokyo date +%Y-%m-%d) (today JST)"
          fi

      - name: Send failure alert
        if: failure()
        env:
          MANUAL_DATE: ${{ github.event.inputs.date }}
          DATES_JSON: ${{ toJSON(github.event.client_payload.dates) }}
          DATE_SINGLE: ${{ github.event.client_payload.date }}
          ALERT_ENDPOINT: ${{ secrets.ALERT_ENDPOINT || 'https://keiba-intelligence.netlify.app/.netlify/functions/send-alert' }}
        run: |
          # ÂØæË±°Êó•‰ªò„ÇíÁâπÂÆö
          if [ -n "$MANUAL_DATE" ]; then
            TARGET_DATE="$MANUAL_DATE"
          elif [ -n "$DATES_JSON" ] && [ "$DATES_JSON" != "null" ]; then
            TARGET_DATE=$(echo "$DATES_JSON" | jq -r '.[0]')
          elif [ -n "$DATE_SINGLE" ] && [ "$DATE_SINGLE" != "null" ]; then
            TARGET_DATE="$DATE_SINGLE"
          else
            TARGET_DATE=$(TZ=Asia/Tokyo date +%Y-%m-%d)
          fi

          echo "üö® GitHub ActionsÂ§±Êïó„ÇíÊ§úÁü•„Åó„Åæ„Åó„Åü"
          echo "   ÂØæË±°Êó•‰ªò: $TARGET_DATE"
          echo "   „ÉØ„Éº„ÇØ„Éï„É≠„Éº: import-results-on-dispatch"
          echo "   „Ç¢„É©„Éº„Éà„É°„Éº„É´ÈÄÅ‰ø°‰∏≠..."

          # „Ç¢„É©„Éº„Éà„É°„Éº„É´ÈÄÅ‰ø°
          curl -X POST "$ALERT_ENDPOINT" \
            -H "Content-Type: application/json" \
            -d "{
              \"type\": \"github-actions-failure\",
              \"date\": \"$TARGET_DATE\",
              \"details\": {
                \"workflow\": \"import-results-on-dispatch\",
                \"step\": \"${{ github.job }}\",
                \"error\": \"GitHub Actions workflow failed\",
                \"run_url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
              },
              \"metadata\": {
                \"repository\": \"${{ github.repository }}\",
                \"run_id\": \"${{ github.run_id }}\",
                \"run_number\": \"${{ github.run_number }}\",
                \"actor\": \"${{ github.actor }}\",
                \"event_name\": \"${{ github.event_name }}\"
              }
            }" || echo "‚ö†Ô∏è  „Ç¢„É©„Éº„Éà„É°„Éº„É´ÈÄÅ‰ø°Â§±ÊïóÔºàÂá¶ÁêÜ„ÅØÁ∂ôÁ∂öÔºâ"
