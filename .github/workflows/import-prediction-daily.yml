name: Import Prediction (Daily Check)

on:
  schedule:
    # æ¯æ—¥ 23:00 JST = 14:00 UTC
    - cron: '0 14 * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

# ä¸¦è¡Œå®Ÿè¡Œåˆ¶å¾¡ï¼šåŒã˜ãƒªãƒã‚¸ãƒˆãƒªã®import-daily-predictionã¯1ã¤ãšã¤å®Ÿè¡Œ
concurrency:
  group: import-prediction-daily-${{ github.ref }}
  cancel-in-progress: false  # å®Ÿè¡Œä¸­ã®ã‚¸ãƒ§ãƒ–ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã›ãšå¾…æ©Ÿ

jobs:
  import-daily-prediction:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for git push
    defaults:
      run:
        working-directory: astro-site

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'astro-site/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Calculate JST date
        id: date
        run: |
          # JSTã®ç¾åœ¨æ—¥ä»˜ã‚’è¨ˆç®—ï¼ˆUTC+9ï¼‰
          JST_DATE=$(TZ=Asia/Tokyo date +%Y-%m-%d)
          echo "date=$JST_DATE" >> $GITHUB_OUTPUT
          echo "ğŸ“… JST Today: $JST_DATE"

      - name: Import prediction from keiba-data-shared
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE="${{ steps.date.outputs.date }}"
          echo "ğŸ”„ Daily check: Importing prediction for $DATE"

          # import:prediction ã¯æ—¥ä»˜æœªæŒ‡å®šã§ JST ä»Šæ—¥ã«ãªã‚‹ãŒã€æ˜ç¤ºçš„ã«æŒ‡å®š
          npm run import:prediction -- --date "$DATE"

      - name: Check for changes
        id: git-check
        run: |
          # å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ï¼ˆæ–°è¦ãƒ•ã‚¡ã‚¤ãƒ« + æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ï¼‰
          git add src/data/predictions/
          # ã‚¹ãƒ†ãƒ¼ã‚¸ã•ã‚ŒãŸå¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          git diff --staged --exit-code || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          DATE="${{ steps.date.outputs.date }}"
          # æ—¢ã« Check for changes ã‚¹ãƒ†ãƒƒãƒ—ã§ git add æ¸ˆã¿
          git commit -m "Daily auto-import: ${DATE} prediction [scheduled 23:00 JST]"

          # Retry logic: pull --rebase and push (æœ€å¤§5å›ãƒªãƒˆãƒ©ã‚¤)
          MAX_RETRIES=5
          RETRY_COUNT=0
          SUCCESS=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = false ]; do
            echo "ğŸ”„ Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: Pulling latest changes..."

            # æœ€æ–°çŠ¶æ…‹ã‚’å–å¾—ï¼ˆrebaseï¼‰
            if git pull --rebase origin main; then
              echo "âœ… Successfully pulled latest changes"

              # ãƒ—ãƒƒã‚·ãƒ¥è©¦è¡Œ
              if git push; then
                echo "âœ… Successfully pushed changes"
                SUCCESS=true
              else
                echo "âš ï¸  Push failed, retrying..."
                RETRY_COUNT=$((RETRY_COUNT + 1))
                sleep $((RETRY_COUNT * 2))  # Exponential backoff
              fi
            else
              echo "âš ï¸  Pull --rebase failed, retrying..."
              RETRY_COUNT=$((RETRY_COUNT + 1))
              sleep $((RETRY_COUNT * 2))
            fi
          done

          if [ "$SUCCESS" = false ]; then
            echo "âŒ Failed to push after $MAX_RETRIES attempts"
            exit 1
          fi

      - name: Success notification
        if: steps.git-check.outputs.changed == 'true'
        run: |
          echo "âœ… Daily import completed and pushed"
          echo "   Date: ${{ steps.date.outputs.date }}"
          echo "   Trigger: scheduled (23:00 JST)"

      - name: No changes notification
        if: steps.git-check.outputs.changed != 'true'
        run: |
          echo "â­ï¸  No changes detected (already up-to-date)"
          echo "   Date: ${{ steps.date.outputs.date }}"
          echo "   This is expected if the main trigger already ran today"
