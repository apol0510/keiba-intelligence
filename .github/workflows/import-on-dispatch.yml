name: Import Prediction (Dispatch)

on:
  repository_dispatch:
    types: [prediction-updated]
  workflow_dispatch:  # Manual testing enabled

jobs:
  import-prediction:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for git push
    defaults:
      run:
        working-directory: astro-site

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'astro-site/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Import prediction from keiba-data-shared
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DATES_JSON: ${{ toJSON(github.event.client_payload.dates) }}
          DATE_SINGLE: ${{ github.event.client_payload.date }}
        run: |
          # „Äê‰øÆÊ≠£„ÄëdatesÈÖçÂàó„Çí„É´„Éº„ÉóÂá¶ÁêÜÔºàÂæåÊñπ‰∫íÊèõÊÄß„ÅÇ„ÇäÔºâ
          if [ -n "$DATES_JSON" ] && [ "$DATES_JSON" != "null" ]; then
            # datesÈÖçÂàó„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºàÊñ∞ÂΩ¢ÂºèÔºâ
            echo "üìÖ Importing predictions for multiple dates"
            echo "$DATES_JSON" | jq -r '.[]' | while read -r DATE; do
              echo "‚îÅ‚îÅ‚îÅ Processing: $DATE ‚îÅ‚îÅ‚îÅ"
              npm run import:prediction -- --date "$DATE"
            done
          elif [ -n "$DATE_SINGLE" ] && [ "$DATE_SINGLE" != "null" ]; then
            # dateÂçò‰Ωì„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºàÊóßÂΩ¢Âºè„ÉªÂæåÊñπ‰∫íÊèõÔºâ
            echo "üìÖ Importing prediction for single date: $DATE_SINGLE"
            npm run import:prediction -- --date "$DATE_SINGLE"
          else
            echo "‚ùå Error: neither dates nor date provided in payload"
            exit 1
          fi

      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          DATES="${{ github.event.client_payload.dates }}"
          SOURCE="${{ github.event.client_payload.source }}"
          git add src/data/predictions/
          git commit -m "Auto-import: ${DATES} prediction from ${SOURCE}"
          git push

      - name: Success notification
        if: steps.git-check.outputs.changed == 'true'
        run: |
          echo "‚úÖ Import completed and pushed"
          echo "   Dates: ${{ github.event.client_payload.dates }}"
          echo "   Source: ${{ github.event.client_payload.source }}"

      - name: No changes notification
        if: steps.git-check.outputs.changed != 'true'
        run: |
          echo "‚è≠Ô∏è  No changes detected (already up-to-date)"
          echo "   Dates: ${{ github.event.client_payload.dates }}"
