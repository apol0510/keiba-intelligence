name: Import Prediction (Dispatch)

on:
  repository_dispatch:
    types: [prediction-updated]
  workflow_dispatch:  # Manual testing enabled

jobs:
  import-prediction:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for git push
    defaults:
      run:
        working-directory: astro-site

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'astro-site/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Import prediction from keiba-data-shared
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DATES_JSON: ${{ toJSON(github.event.client_payload.dates) }}
          DATE_SINGLE: ${{ github.event.client_payload.date }}
        run: |
          # ã€ä¿®æ­£ã€‘datesé…åˆ—ã‚’ãƒ«ãƒ¼ãƒ—å‡¦ç†ï¼ˆå¾Œæ–¹äº’æ›æ€§ã‚ã‚Šï¼‰
          if [ -n "$DATES_JSON" ] && [ "$DATES_JSON" != "null" ]; then
            # datesé…åˆ—ãŒã‚ã‚‹å ´åˆï¼ˆæ–°å½¢å¼ï¼‰
            echo "ğŸ“… Importing predictions for multiple dates"
            # ã‚µãƒ–ã‚·ã‚§ãƒ«å›é¿: while read ã‚’ãƒ—ãƒ­ã‚»ã‚¹ç½®æ›ã§å®Ÿè¡Œ
            while IFS= read -r DATE; do
              echo "â”â”â” Processing: $DATE â”â”â”"
              npm run import:prediction -- --date "$DATE"
            done < <(echo "$DATES_JSON" | jq -r '.[]')
          elif [ -n "$DATE_SINGLE" ] && [ "$DATE_SINGLE" != "null" ]; then
            # dateå˜ä½“ãŒã‚ã‚‹å ´åˆï¼ˆæ—§å½¢å¼ãƒ»å¾Œæ–¹äº’æ›ï¼‰
            echo "ğŸ“… Importing prediction for single date: $DATE_SINGLE"
            npm run import:prediction -- --date "$DATE_SINGLE"
          else
            echo "âŒ Error: neither dates nor date provided in payload"
            exit 1
          fi

      - name: Check for changes
        id: git-check
        run: |
          # å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ï¼ˆæ–°è¦ãƒ•ã‚¡ã‚¤ãƒ« + æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ï¼‰
          git add src/data/predictions/
          # ã‚¹ãƒ†ãƒ¼ã‚¸ã•ã‚ŒãŸå¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          git diff --staged --exit-code || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          DATES="${{ github.event.client_payload.dates }}"
          SOURCE="${{ github.event.client_payload.source }}"
          # æ—¢ã« Check for changes ã‚¹ãƒ†ãƒƒãƒ—ã§ git add æ¸ˆã¿
          git commit -m "Auto-import: ${DATES} prediction from ${SOURCE}"
          git push

      - name: Success notification
        if: steps.git-check.outputs.changed == 'true'
        run: |
          echo "âœ… Import completed and pushed"
          echo "   Dates: ${{ github.event.client_payload.dates }}"
          echo "   Source: ${{ github.event.client_payload.source }}"

      - name: No changes notification
        if: steps.git-check.outputs.changed != 'true'
        run: |
          echo "â­ï¸  No changes detected (already up-to-date)"
          echo "   Dates: ${{ github.event.client_payload.dates }}"
