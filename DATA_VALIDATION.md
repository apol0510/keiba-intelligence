# データ検証システム（再発防止策）

## 📋 概要

2026-02-14に発生したrole（役割）誤変換問題の再発を防止するため、自動データ検証システムを実装しました。

## 🐛 過去の問題（2026-02-14）

### 問題1: 記者印による上書き
- **症状**: 本命が「単穴」になる、対抗が「単穴」になる
- **原因**: `adjustPrediction.js`のStep 0で`marks.印1`（記者印）を使って役割を決定
- **影響**: JRAの`assignment`（独自予想）が上書きされた

### 問題2: 強制変換
- **症状**: 連下最上位が「単穴」になる
- **原因**: `importPredictionJra.js`のLine 252で`連下最上位 → 単穴`に強制変換
- **影響**: 15番トーラスシャインが誤って単穴になった

## ✅ 再発防止策

### 1. JRA用簡易調整関数（simpleAdjustForJRA）

**場所**: `src/utils/normalizePrediction.js`

**機能**:
- roleを一切変更せず保持
- displayScore計算のみ（rawScore + 70）
- mark生成のみ（roleから◎○▲△）
- 南関用の複雑な調整ロジックを完全スキップ

**使用条件**:
- `normalizeAndAdjust(input, { skipMark1Override: true })` で呼び出し
- JRA予想データのみ使用

### 2. 自動データ検証（validateJRAPrediction）

**場所**: `scripts/utils/validatePrediction.js`

**検証項目**:

| 項目 | 検証内容 | エラーメッセージ例 |
|------|---------|-------------------|
| 本命 | 1頭のみ | `❌ 小倉11R: 本命が0頭（1頭必須）` |
| 対抗 | 1頭のみ | `❌ 小倉11R: 対抗が2頭（1頭のみ許可）` |
| 単穴 | 0〜1頭 | `❌ 小倉11R: 単穴が2頭（1頭のみ許可）` |
| 連下最上位 | 0〜1頭 | `❌ 小倉11R: 連下最上位が2頭（1頭のみ許可）` |
| 役割名 | 許可された値のみ | `❌ 小倉11R: 3番 - 不正な役割 "不正な役割"` |
| PT値 | 本命 ≥ 対抗（警告のみ） | `⚠️  小倉11R: 本命が対抗より5点以上低い` |

**許可された役割名**:
- `本命`, `対抗`, `単穴`, `連下最上位`, `連下`, `補欠`, `無`, `抑え`

### 3. インポート時の自動検証

**場所**: `scripts/importPredictionJra.js` Line 335-344

**動作**:
```javascript
// 【再発防止】データ検証を実行
console.log(`🔍 データ検証中...`);
try {
  validateJRAPrediction(convertedData);
  console.log(`   ✅ データ検証成功（本命・対抗・単穴の整合性確認済み）`);
} catch (err) {
  console.error(`\n❌ データ検証失敗:\n${err.message}`);
  console.error(`\n⚠️  保存を中止します（データ品質保護）`);
  throw err; // エラーを投げて処理を中断
}
```

**効果**:
- 不正なデータが保存される前にエラーで中断
- データ品質を保護
- 問題の早期発見

### 4. 自動テスト

**場所**: `scripts/utils/validatePrediction.test.js`

**実行方法**:
```bash
node scripts/utils/validatePrediction.test.js
```

**テストケース**:
1. ✅ 正常データ（本命1・対抗1・単穴1・連下最上位1）
2. ❌ 単穴2頭（再発防止テスト）
3. ❌ 連下最上位2頭（再発防止テスト）
4. ❌ 本命0頭
5. ❌ 対抗0頭
6. ❌ 不正な役割名

**結果**:
```
テスト結果: 6/6 成功
✅ 全テスト成功！
```

## 🔧 使用方法

### インポート時（自動）

```bash
node scripts/importPredictionJra.js --date 2026-02-14
```

**出力例（成功時）**:
```
🔍 データ検証中...
   ✅ データ検証成功（本命・対抗・単穴の整合性確認済み）
✅ 保存完了: .../2026-02-14.json
```

**出力例（エラー時）**:
```
🔍 データ検証中...
❌ データ検証失敗:
データ検証エラー（2件）:
❌ 小倉11R: 単穴が2頭（1頭のみ許可）- 11番ナムラローズマリー, 15番トーラスシャイン
❌ 京都12R: 本命が0頭（1頭必須）

⚠️  保存を中止します（データ品質保護）
```

### テスト実行（手動）

```bash
# 全テストを実行
node scripts/utils/validatePrediction.test.js

# CIで実行（GitHub Actionsなど）
npm run test:validation  # package.jsonに追加可能
```

## 📊 検証フロー

```
keiba-data-shared（元データ）
  ↓
importPredictionJra.js
  ↓
normalizeAndAdjust({ skipMark1Override: true })
  ↓
simpleAdjustForJRA()  ← role保持
  ↓
convertToLegacyFormat()  ← role保持（変換なし）
  ↓
【🔍 validateJRAPrediction()】 ← 再発防止チェック
  ├─ 本命1頭チェック
  ├─ 対抗1頭チェック
  ├─ 単穴0〜1頭チェック
  ├─ 連下最上位0〜1頭チェック
  └─ 役割名チェック
  ↓
✅ 検証成功 → 保存
❌ 検証失敗 → エラー中断（保存しない）
```

## 🎯 期待効果

1. **早期発見**: 不正なデータが保存される前にエラーで検出
2. **自動保護**: 手動確認不要、インポート時に自動チェック
3. **明確なエラー**: どのレースのどの馬に問題があるか明示
4. **回帰防止**: テストケースで過去の問題を再現、再発を防止
5. **CI統合可能**: GitHub Actionsなどで自動テスト実行可能

## 📝 今後の改善案

- [ ] GitHub Actionsでのテスト自動実行
- [ ] より詳細な検証（PT値の範囲チェックなど）
- [ ] 南関予想データの検証強化
- [ ] 検証レポートの自動生成

---

**作成日**: 2026-02-14
**作成者**: Claude Code（クロちゃん）
**目的**: 2026-02-14 role誤変換問題の再発防止
